<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-blue: #0a2463; --secondary-blue: #1e5095; --primary-red: #d90429;
            --text-light: #ffffff; --card-bg: #1a3a7a; --border-color: #3b5a9d; --gold-star: #FFD700;
            --field-green: #008000; --field-line: #FFF; --gk-color: #E8C135;
        }
        html {
            scroll-behavior: smooth;
        }
        body { background-color: var(--primary-blue); color: var(--text-light); padding-top: 56px; }
        .bg-dark-blue { background-color: #051438 !important; border-bottom: 2px solid var(--primary-red); }
        .main-title { color: var(--text-light); border-left: 4px solid var(--primary-red); padding-left: 1rem; }
        .athlete-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .athlete-card-clickable { cursor: pointer; }
        .athlete-card-clickable:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(217, 4, 41, 0.2); border-color: var(--primary-red); }
        .athlete-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--border-color); object-fit: cover; background-color: var(--secondary-blue); }
        .shirt-number { font-size: 1.5rem; font-weight: bold; color: var(--text-light); background-color: var(--primary-red); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; top: 15px; right: 15px; }
        .is-captain { color: var(--gold-star); }
        .card-actions { position: absolute; bottom: 10px; right: 10px; z-index: 5; display: flex; gap: 5px; }
        .card-actions .btn { background: rgba(0,0,0,0.3); border: none; }
        .chart-card, .table-card, .summary-card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .modal-content { background-color: var(--primary-blue); border: 1px solid var(--primary-red); }
        .modal-header, .modal-footer { border-bottom: 1px solid var(--border-color); border-top: 1px solid var(--border-color); }
        .btn-primary-custom { background-color: var(--primary-red); border-color: var(--primary-red); color: white; }
        .btn-primary-custom:hover { background-color: #b80323; border-color: #b80323; }
        .form-control, .form-select { background-color: var(--secondary-blue); color: var(--text-light); border-color: var(--border-color); }
        .form-control::placeholder { color: #8a9fc1; }
        .form-control:focus, .form-select:focus { background-color: var(--secondary-blue); color: var(--text-light); border-color: var(--primary-red); box-shadow: 0 0 0 0.25rem rgba(217, 4, 41, 0.25); }
        .award-card { background: linear-gradient(45deg, var(--gold-star), #d4af37); color: #000; border: 2px solid #fff; width: 180px; }
        .award-avatar { width: 50px; height: 50px; }
        .text-muted { color: rgba(255, 255, 255, 0.75) !important; }
        .summary-card .card-body { min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;}
        .summary-card .display-4 { font-weight: 500; }
        .calendar-card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { background-color: var(--secondary-blue); border: 1px solid var(--border-color); min-height: 120px; padding: 8px; font-size: 0.9rem; }
        .calendar-day.today { border-color: var(--primary-red); }
        .calendar-day-header { font-weight: bold; }
        .calendar-session { background-color: var(--primary-red); color: white; padding: 4px; border-radius: 4px; font-size: 0.75rem; margin-top: 5px; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        /* STILI MODULO FORMAZIONE */
        #pitch-wrapper { display: flex; align-items: flex-start; gap: 1rem; }
        #field-container { background-color: var(--field-green); border: 2px solid var(--field-line); position: relative; width: 100%; max-width: 450px; aspect-ratio: 5 / 7; box-sizing: border-box; flex-shrink: 0; }
        #field-bench-area { background-color: rgba(0,0,0,0.2); border: 2px dashed var(--border-color); border-radius: 8px; width: 150px; height: 630px; position: relative; flex-shrink: 0; }
        .field-line, .field-box, .field-circle, .field-spot { position: absolute; box-sizing: border-box; border-color: var(--field-line); }
        .halfway-line { border-top: 2px solid var(--field-line); width: 100%; top: 50%; }
        .center-circle { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 25%; aspect-ratio: 1/1; border: 2px solid var(--field-line); border-radius: 50%; }
        .center-spot { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2%; aspect-ratio: 1/1; background-color: var(--field-line); border-radius: 50%; }
        .penalty-box-top { top: 0; left: 50%; transform: translateX(-50%); width: 60%; height: 16.5%; border: 2px solid var(--field-line); border-top: none; }
        .penalty-box-bottom { bottom: 0; left: 50%; transform: translateX(-50%); width: 60%; height: 16.5%; border: 2px solid var(--field-line); border-bottom: none; }
        .goal-box-top { top: 0; left: 50%; transform: translateX(-50%); width: 30%; height: 6%; border: 2px solid var(--field-line); border-top: none; }
        .goal-box-bottom { bottom: 0; left: 50%; transform: translateX(-50%); width: 30%; height: 6%; border: 2px solid var(--field-line); border-bottom: none; }
        .penalty-spot-top { top: 11.5%; left: 50%; transform: translateX(-50%); width: 1.5%; aspect-ratio: 1/1; background-color: var(--field-line); border-radius: 50%; }
        .penalty-spot-bottom { bottom: 11.5%; left: 50%; transform: translateX(-50%); width: 1.5%; aspect-ratio: 1/1; background-color: var(--field-line); border-radius: 50%; }
        .player-jersey { position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 15%; cursor: grab; user-select: none; font-size: clamp(4.5px, 0.6vw, 8px); }
        .jersey-body { position: relative; width: 5em; height: 5em; background-color: var(--secondary-blue); border-radius: 0.8em 0.8em 0.5em 0.5em; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 -4px 8px rgba(0,0,0,0.3); }
        .jersey-body::before, .jersey-body::after { content: ''; position: absolute; width: 2.5em; height: 1em; background-color: inherit; top: 0; }
        .jersey-body::before { left: -1.8em; transform: rotate(-40deg); border-radius: 0.5em 0.2em 0 0; }
        .jersey-body::after { right: -1.8em; transform: rotate(40deg); border-radius: 0.2em 0.5em 0 0; }
        .jersey-number { font-size: 2.2em; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; }
        .player-name { margin-top: 0.5em; font-size: 1.33em; font-weight: bold; color: white; background-color: rgba(0,0,0,0.6); padding: 0.1em 0.4em; border-radius: 4px; white-space: nowrap; }
        #available-list .list-group-item { cursor: grab; background-color: var(--secondary-blue); }
        .available-slot { border: 1px dashed var(--border-color); border-radius: 8px; min-height: 50px; }
        #formation-tools { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1rem; }
        .tool-item { cursor: grab; user-select: none; background-color: var(--secondary-blue); border: 1px solid var(--border-color); border-radius: 8px; padding: 5px 10px; text-align: center; }
        .tool-item.opponent-tool { background-color: var(--primary-red); font-size: 1.5rem; line-height: 1; padding: 5px 12px; }
        .tool-item.ball-tool { font-size: 1.5rem; line-height: 1; padding: 5px 10px; }
        .token { position: absolute; cursor: grab; user-select: none; z-index: 10; text-align: center; }
        .token-captain { font-weight: bold; color: white; background: black; padding: 0.2em 0.5em; border-radius: 4px; font-size: clamp(8px, 1vw, 12px); }
        .token-ball { font-size: 2rem; }
        .token-opponent { width: 2.5em; height: 2.5em; background-color: var(--primary-red); border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.5); font-size: clamp(8px, 1vw, 12px); }
        /* STILI RISULTATI PARTITA */
        .match-result-item { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .match-score { font-weight: bold; font-size: 1.1rem; }
        .yellow-card { width: 10px; height: 14px; background-color: #ffc107; display: inline-block; border-radius: 2px; }
        .red-card { width: 10px; height: 14px; background-color: #dc3545; display: inline-block; border-radius: 2px; }
        .scorers-list { font-size: 0.8rem; color: var(--text-muted); }
        #cards-summary-table { --bs-table-bg: var(--secondary-blue); --bs-table-striped-bg: var(--secondary-blue); --bs-table-hover-bg: var(--border-color); border-color: var(--border-color); }
        /* STILI DI STAMPA CORRETTI */
        @media print {
            body { padding-top: 0; }
            .no-print { display: none !important; }
            body * { visibility: hidden; }
            .printing-now, .printing-now * { visibility: visible; }
            .printing-now { position: absolute; left: 0; top: 0; width: 100%; }
            .printing-now #athlete-grid { display: flex !important; flex-wrap: wrap !important; }
            .printing-now #athlete-grid > [class*="col-"] { flex: 0 0 33.33% !important; max-width: 33.33% !important; padding: 5px !important; page-break-inside: avoid; }
            .printing-now .athlete-card { box-shadow: none !important; }
            .printing-now .card, .printing-now .list-group-item, .printing-now .calendar-day, .printing-now .table { background-color: #fff !important; border: 1px solid #ccc !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now table, .printing-now th, .printing-now td { background-color: #fff !important; color: #000 !important; border-color: #000 !important; }
            .printing-now .calendar-session, .printing-now .shirt-number { background-color: #cccccc !important; color: #000 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now *, .printing-now .main-title, .printing-now .text-muted, .printing-now .card-title, .printing-now p, .printing-now h1, .printing-now h2, .printing-now h3, .printing-now h4, .printing-now h5, .printing-now h6 { color: #000 !important; }
            .printing-now .main-title { border-left-color: #000 !important; }
            .printing-now canvas { max-width: 100% !important; height: auto !important; }
            .printing-now #field-container { background-color: var(--field-green) !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now #field-container .field-line, .printing-now #field-container .field-box, .printing-now #field-container .field-circle { border-color: var(--field-line) !important; }
            .printing-now #field-container .field-spot { background-color: var(--field-line) !important; }
            .printing-now .jersey-body, .printing-now .player-name, .printing-now .token-opponent, .printing-now .token-captain, .printing-now .yellow-card, .printing-now .red-card { -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now .player-jersey[data-role*="Portiere"] .jersey-body { background-color: var(--gk-color) !important; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark-blue fixed-top no-print">
        <div class="container-fluid"><a class="navbar-brand fw-bold" href="#"><i class="bi bi-person-workspace"></i> Coach Dashboard</a></div>
    </nav>
    <main class="container-fluid mt-5 pt-3">
        <div id="home-section" class="printable-area">
            <div class="row my-4">
                <div class="col-12 d-flex align-items-center gap-2">
                    <h2 class="main-title mb-0">Home Riepilogo</h2>
                    <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card summary-card h-100">
                        <div class="card-body">
                            <h5 class="card-title text-muted">ATLETI IN ROSA</h5>
                            <p class="display-4" id="home-total-athletes">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card summary-card h-100">
                        <div class="card-body" id="home-next-session">
                             <h5 class="card-title text-muted">PROSSIMA SESSIONE</h5>
                             <p class="text-muted">Nessuna sessione pianificata</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card summary-card h-100">
                        <div class="card-body" id="home-top-performer">
                            <h5 class="card-title text-muted">TOP PERFORMER MENSILE</h5>
                             <p class="text-muted">Nessuna valutazione</p>
                        </div>
                    </div>
                </div>
                 <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card summary-card h-100">
                        <div class="card-body" id="home-quick-actions">
                             <h5 class="card-title text-muted">AZIONI RAPIDE</h5>
                             <div class="d-grid gap-2 w-100 no-print">
                                 <button class="btn btn-primary-custom" id="quick-add-athlete-btn"><i class="bi bi-person-plus-fill"></i> Aggiungi Atleta</button>
                                 <button class="btn btn-secondary" id="quick-plan-session-btn"><i class="bi bi-calendar-plus"></i> Pianifica Sessione</button>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row my-4 no-print">
            <div class="col-12">
                <div class="card summary-card">
                    <div class="card-body">
                        <h5 class="card-title text-muted mb-3">NAVIGAZIONE RAPIDA</h5>
                        <div class="d-flex flex-wrap justify-content-center gap-2">
                            <a href="#formazione-section" class="btn btn-secondary"><i class="bi bi-grid-3x3-gap-fill"></i> Modulo Formazione</a>
                            <a href="#calendario-section" class="btn btn-secondary"><i class="bi bi-calendar3"></i> Calendario</a>
                            <a href="#squadra-section" class="btn btn-secondary"><i class="bi bi-people-fill"></i> Gestione Squadra</a>
                            <a href="#match-results-section" class="btn btn-secondary"><i class="bi bi-trophy-fill"></i> Risultati Partite</a>
                            <a href="#report-valutazioni-section" class="btn btn-secondary"><i class="bi bi-card-checklist"></i> Report Valutazioni</a>
                            <a href="#report-presenze-section" class="btn btn-secondary"><i class="bi bi-person-check-fill"></i> Report Presenze</a>
                            <a href="#hall-of-fame-section" class="btn btn-secondary"><i class="bi bi-award-fill"></i> Hall of Fame</a>
                            <a href="#monitoraggio-gps-section" class="btn btn-secondary"><i class="bi bi-graph-up-arrow"></i> Monitoraggio GPS</a>
                            <a href="#analisi-singolo-section" class="btn btn-secondary"><i class="bi bi-person-lines-fill"></i> Analisi Atleta</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr class="my-5 no-print">
        <div id="formazione-section" class="printable-area">
            <div class="row my-4 align-items-center">
                <div class="col-12 d-flex align-items-center gap-2">
                     <h2 class="main-title mb-0">Modulo Formazione</h2>
                     <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                     <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-9 mb-4">
                    <div id="pitch-wrapper">
                        <div id="field-container" class="drop-zone">
                            <div class="field-line halfway-line"></div>
                            <div class="field-circle center-circle"></div>
                            <div class="field-spot center-spot"></div>
                            <div class="field-box penalty-box-top"></div>
                            <div class="field-box goal-box-top"></div>
                            <div class="field-spot penalty-spot-top"></div>
                            <div class="field-box penalty-box-bottom"></div>
                            <div class="field-box goal-box-bottom"></div>
                            <div class="field-spot penalty-spot-bottom"></div>
                        </div>
                        <div id="field-bench-area" class="drop-zone"></div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card" style="background-color: var(--card-bg);">
                         <div class="card-header fw-bold">Strumenti</div>
                         <div class="card-body">
                             <div id="formation-tools">
                                 <div class="tool-item" draggable="true" data-item-type="captain-c">(C)</div>
                                 <div class="tool-item" draggable="true" data-item-type="captain-vc">(VC)</div>
                                 <div class="tool-item ball-tool" draggable="true" data-item-type="ball">⚽</div>
                                 <div class="tool-item opponent-tool" draggable="true" data-item-type="opponent" title="Trascina per duplicare">●</div>
                             </div>
                         </div>
                         <div class="card-header fw-bold mt-3">Atleti Disponibili</div>
                         <div class="card-body available-slot p-2 drop-zone" id="available-list" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
        <hr class="my-5 no-print">
        <div id="calendario-section" class="printable-area">
             <div class="row my-4 align-items-center">
                 <div class="col-md-8 d-flex align-items-center gap-2">
                     <h2 class="main-title mb-0">Calendario Attività Sportiva</h2>
                     <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                     <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a>
                </div>
                 <div class="col-md-4 d-flex justify-content-md-end no-print">
                    <button class="btn btn-primary-custom" id="add-session-btn"><i class="bi bi-calendar-plus"></i> Pianifica Sessione</button>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mt-3">
                    <div class="card calendar-card">
                        <div class="card-body">
                            <div class="calendar-header mb-3">
                                <button id="prev-month-btn" class="btn btn-outline-secondary no-print"><i class="bi bi-chevron-left"></i></button>
                                <h4 id="current-month-year"></h4>
                                <button id="next-month-btn" class="btn btn-outline-secondary no-print"><i class="bi bi-chevron-right"></i></button>
                            </div>
                            <div class="calendar-grid-header calendar-grid mb-1" style="font-weight: bold; text-align: center;">
                                <div>Lunedì</div><div>Martedì</div><div>Mercoledì</div><div>Giovedì</div><div>Venerdì</div><div>Sabato</div><div>Domenica</div>
                            </div>
                            <div class="calendar-grid" id="calendar-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr class="my-5 no-print">
        <div id="squadra-section" class="printable-area">
            <div class="row align-items-center my-4">
                 <div class="col-md-4 d-flex align-items-center gap-2">
                     <h2 class="main-title mb-0">Gestione Squadra</h2>
                     <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                     <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a>
                </div>
                <div class="col-md-8 d-flex justify-content-md-end align-items-center flex-wrap gap-2 no-print">
                    <button class="btn btn-secondary" id="export-all-data-btn"><i class="bi bi-download"></i> Esporta Dati</button>
                    <label for="import-file-input" class="btn btn-secondary mb-0"><i class="bi bi-upload"></i> Importa Dati</label>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    <button class="btn btn-primary-custom" id="add-athlete-btn"><i class="bi bi-person-plus-fill"></i> Aggiungi Atleta</button>
                    <div class="d-flex align-items-center gap-2">
                        <label for="evaluation-date-picker" class="form-label mb-0 text-nowrap">Data Valutazioni:</label>
                        <input type="date" id="evaluation-date-picker" class="form-control" style="max-width: 180px;">
                        <button class="btn btn-outline-danger" id="delete-day-data-btn" title="Elimina tutti i dati del giorno selezionato"><i class="bi bi-calendar-x-fill"></i></button>
                    </div>
                </div>
            </div>
            <div class="row" id="athlete-grid"></div>
        </div>
        <hr class="my-5 no-print">
        <div id="match-results-section" class="printable-area">
            <div class="row my-4 align-items-center">
                <div class="col-md-8 d-flex align-items-center gap-2">
                    <h2 class="main-title mb-0">Risultati Partite</h2>
                    <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                    <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a>
                </div>
                <div class="col-md-4 d-flex justify-content-md-end no-print">
                    <button class="btn btn-primary-custom" id="add-match-btn"><i class="bi bi-plus-circle-fill"></i> Aggiungi Partita</button>
                </div>
            </div>
            <div class="row" id="match-results-container">
                 <p class="text-muted">Nessun risultato inserito.</p>
            </div>
            <div class="row mt-5">
                <div class="col-lg-7 mb-4">
                    <div class="card chart-card">
                        <div class="card-body">
                            <h5 class="card-title">Andamento Risultati</h5>
                            <div class="d-flex gap-2 mb-3 no-print">
                                <select id="match-opponent-filter" class="form-select form-select-sm" style="width: 200px;">
                                    <option value="all">Tutti gli avversari</option>
                                </select>
                                <div class="btn-group btn-group-sm" id="match-period-toggle">
                                    <button type="button" class="btn btn-outline-secondary active" data-period="monthly">Mensile</button>
                                    <button type="button" class="btn btn-outline-secondary" data-period="bimonthly">Bimestrale</button>
                                    <button type="button" class="btn btn-outline-secondary" data-period="trimester">Trimestre</button>
                                    <button type="button" class="btn btn-outline-secondary" data-period="semester">Semestre</button>
                                    <button type="button" class="btn btn-outline-secondary" data-period="annual">Annuale</button>
                                </div>
                            </div>
                            <canvas id="matchResultsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 mb-4">
                    <div class="card table-card mb-4">
                        <div class="card-body">
                             <h5 class="card-title">Classifica Marcatori</h5>
                             <div id="top-scorers-container" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="card table-card">
                        <div class="card-body">
                            <h5 class="card-title">Riepilogo Cartellini</h5>
                            <div class="table-responsive" style="max-height: 200px;">
                                <table class="table table-dark table-striped table-hover table-sm" id="cards-summary-table">
                                    <thead><tr><th>Atleta</th><th><span class="yellow-card"></span></th><th><span class="red-card"></span></th><th>Data</th></tr></thead>
                                    <tbody id="cards-summary-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr class="my-5 no-print">
        <div id="report-valutazioni-section" class="row my-4 printable-area">
            <div class="col-12 d-flex align-items-center gap-2 mb-3">
                 <h2 class="main-title mb-0">Report Valutazioni Comportamentali</h2>
                 <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                 <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a>
            </div>
            <div class="col-12 mb-3 no-print">
                <div class="d-flex align-items-center gap-2 justify-content-center">
                    <label for="evaluation-date-picker" class="form-label mb-0">Data Valutazioni:</label>
                    <input type="date" id="evaluation-date-picker" class="form-control" style="max-width: 180px;">
                    <span class="text-muted">↔</span>
                    <input type="date" id="evaluation-date-picker-sync" class="form-control" style="max-width: 180px;">
                </div>
            </div>
            <div class="col-lg-6 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Andamento Medio Squadra (Ultimi 7 Giorni)</h5><canvas id="dailyTeamChart"></canvas></div></div></div>
            <div class="col-lg-6 mb-4"><div class="card chart-card"><div class="card-body" id="comparison-chart-container"><h5 class="card-title mb-0">Confronto Valutazioni Atleti</h5><div class="btn-group btn-group-sm float-end no-print" id="comparison-period-toggle"><button type="button" class="btn btn-outline-secondary active" data-period="daily">Giornaliero</button><button type="button" class="btn btn-outline-secondary" data-period="weekly">Settimanale</button><button type="button" class="btn btn-outline-secondary" data-period="monthly">Mensile</button></div><canvas id="monthlyComparisonChart"></canvas></div></div></div>
        </div>
        <div id="report-presenze-section" class="row my-4 printable-area">
             <div class="col-12 d-flex align-items-center gap-2 mb-3">
                 <h2 class="main-title mb-0">Report Presenze Allenamenti</h2>
                 <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                 <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a>
            </div>
             <div class="col-12 mb-4">
                 <div class="card chart-card">
                     <div class="card-body">
                         <div class="d-flex justify-content-between align-items-center">
                             <h5 class="card-title mb-0">Conteggio Presenze Atleti</h5>
                             <div class="btn-group btn-group-sm no-print" id="attendance-period-toggle">
                                 <button type="button" class="btn btn-outline-secondary active" data-period="daily">Giornaliero</button>
                                 <button type="button" class="btn btn-outline-secondary" data-period="weekly">Settimanale</button>
                                 <button type="button" class="btn btn-outline-secondary" data-period="monthly">Mensile</button>
                             </div>
                         </div>
                         <canvas id="attendanceChart"></canvas>
                     </div>
                 </div>
             </div>
        </div>
        <hr class="my-5 no-print">
        <div id="hall-of-fame-section" class="row my-4 printable-area">
            <div class="col-12 d-flex align-items-center gap-2 mb-3">
                 <h2 class="main-title mb-0">Hall of Fame - Atleti Premiati della Stagione</h2>
                 <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                 <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a>
            </div>
              <div id="hall-of-fame-container" class="d-flex flex-wrap gap-3 justify-content-center"></div>
        </div>
        <hr class="my-5 no-print">
        <div id="confronto-squadra-section" class="printable-area">
            <div class="row my-4" id="multi-athlete-chart-container">
                <div class="col-12 d-flex align-items-center gap-2 mb-3">
                     <h2 class="main-title mb-0">Confronto Performance Squadra</h2>
                     <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                     <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a>
                </div>
                <div class="col-12 mb-4">
                    <div class="card chart-card">
                        <div class="card-body">
                            <div class="row g-3 align-items-center mb-3 no-print">
                                <div class="col-md-4">
                                    <label for="multi-athlete-metric-selector" class="form-label">Parametro</label>
                                    <select id="multi-athlete-metric-selector" class="form-select"></select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Tipo Sessione</label>
                                    <div class="btn-group w-100" id="multi-athlete-type-selector">
                                        <button type="button" class="btn btn-outline-secondary active" data-type="all">Tutti</button>
                                        <button type="button" class="btn btn-outline-secondary" data-type="Allenamento">Allenamento</button>
                                        <button type="button" class="btn btn-outline-secondary" data-type="Partita">Partita</button>
                                        <button type="button" class="btn btn-outline-secondary" data-type="Individual">Individual</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3 align-items-end no-print">
                                <div class="col-md-8">
                                    <label class="form-label">Filtro Temporale (mostra valore massimo nel periodo)</label>
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-outline-secondary" data-period="day">Giorno</button>
                                        <button type="button" class="btn btn-outline-secondary active" data-period="month">Mese</button>
                                        <button type="button" class="btn btn-outline-secondary" data-period="bimonth">Bimestre</button>
                                        <button type="button" class="btn btn-outline-secondary" data-period="trimester">Trimestre</button>
                                        <button type="button" class="btn btn-outline-secondary" data-period="semester">Semestre</button>
                                    </div>
                                </div>
                                <div class="col-md-3" id="multi-athlete-datepicker-container" style="display: none;">
                                    <label for="multi-athlete-datepicker" class="form-label">Seleziona Data</label>
                                    <input type="date" id="multi-athlete-datepicker" class="form-control">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">&nbsp;</label>
                                    <button class="btn btn-secondary w-100" id="multi-athlete-reset-btn" title="Reset Filtri"><i class="bi bi-arrow-clockwise"></i></button>
                                </div>
                            </div>
                            <canvas id="multiAthleteChart" class="mt-4"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr class="my-5 no-print">
        <div id="monitoraggio-gps-section" class="row my-4 printable-area">
            <div class="col-12 d-flex align-items-center gap-2 mb-3">
                 <h2 class="main-title mb-0">Monitoraggio Performance (GPS)</h2>
                 <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                 <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a>
            </div>
            <div class="card chart-card p-3 mb-4 no-print">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <label class="form-label mb-0">Filtra sessioni per tipo:</label>
                    <div class="btn-group btn-group-sm" id="performance-filter-toggle">
                        <button type="button" class="btn btn-outline-secondary active" data-type="all">Tutti</button>
                        <button type="button" class="btn btn-outline-secondary" data-type="Allenamento">Allenamento</button>
                        <button type="button" class="btn btn-outline-secondary" data-type="Partita">Partita</button>
                        <button type="button" class="btn btn-outline-secondary" data-type="Individual">Individual</button>
                    </div>
                </div>
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label class="form-label">Seleziona le sessioni da confrontare:</label>
                        <div id="performance-selectors-container" class="d-grid gap-2"></div>
                    </div>
                    <div class="col-md-4 d-flex align-items-end gap-2 mt-2 mt-md-0">
                        <div>
                            <label for="performance-metric-selector" class="form-label">Metrica:</label>
                            <select id="performance-metric-selector" class="form-select"></select>
                        </div>
                        <button class="btn btn-primary-custom flex-grow-1" id="add-comparison-btn"><i class="bi bi-plus-lg"></i> Aggiungi</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-7 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Grafico Confronto Performance</h5><canvas id="performanceChart"></canvas></div></div></div>
            <div class="col-lg-5 mb-4"><div class="card table-card"><div class="card-body"><h5 class="card-title">Tabella Dati a Confronto</h5><div class="table-responsive" id="performance-table-container"></div><div id="export-buttons-container" class="mt-3 d-flex gap-2 no-print"></div></div></div></div>
        </div>
        <hr class="my-5 no-print">
        <div id="analisi-singolo-section" class="row my-4 printable-area">
            <div class="col-12 d-flex align-items-center gap-2 mb-3">
                 <h2 class="main-title mb-0">Analisi Atleta Singolo</h2>
                 <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                 <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a>
            </div>
            <div class="card chart-card p-3 mb-4 no-print">
                <div class="row">
                    <div class="col-md-6">
                        <label for="trend-athlete-selector" class="form-label">Atleta per Andamento nel Tempo:</label>
                        <select id="trend-athlete-selector" class="form-select"></select>
                        <label for="trend-metric-selector" class="form-label mt-2">Metrica per Andamento:</label>
                        <select id="trend-metric-selector" class="form-select"></select>
                    </div>
                    <div class="col-md-6">
                        <label for="radar-athlete-selector-1" class="form-label">Atleta 1 (Radar):</label>
                        <select id="radar-athlete-selector-1" class="form-select"></select>
                        <label for="radar-athlete-selector-2" class="form-label mt-2">Atleta 2 (Confronto Radar):</label>
                        <select id="radar-athlete-selector-2" class="form-select"></select>
                    </div>
                </div>
            </div>
            <div class="col-lg-8 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Andamento Performance nel Tempo (vs. Media Squadra)</h5><canvas id="athleteTrendChart"></canvas></div></div></div>
            <div class="col-lg-4 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Profilo Atleta (vs. Top di Squadra)</h5><canvas id="athleteRadarChart"></canvas></div></div></div>
        </div>
    </main>
    <footer class="bg-dark-blue py-3 mt-5 no-print">
        <div class="container text-center">
            <p class="text-muted mb-0">By Edy Franzoso</p>
        </div>
    </footer>
    <div id="modals-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const modalsContainer = document.getElementById('modals-container');
        modalsContainer.innerHTML = `<div class="modal fade" id="evaluationModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Valutazione di <span id="modal-athlete-name-eval"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="evaluation-form"><input type="hidden" id="modal-athlete-id-eval"><p>Data: <strong id="modal-evaluation-date"></strong></p><div class="mb-2"><label class="form-label">Presenza Allenamento</label><select id="presenza-allenamento" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Serietà Allenamento</label><select id="serieta-allenamento" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Abbigliamento Allenamento</label><select id="abbigliamento-allenamento" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Abbigliamento Partita</label><select id="abbigliamento-partita" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Serietà Comunicazioni</label><select id="comunicazioni" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Doccia (Opzionale)</label><select id="doccia" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="award-checkbox"><label class="form-check-label" for="award-checkbox">Assegna Premio</label></div></form></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-outline-danger" id="delete-single-athlete-day-btn">Elimina Dati del Giorno</button><div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button><button type="submit" class="btn btn-primary-custom" form="evaluation-form">Salva Valutazione</button></div></div></div></div></div>
            <div class="modal fade" id="athleteModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="athleteModalLabel">Gestisci Atleta</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="athlete-form"><input type="hidden" id="modal-athlete-id"><div class="mb-3"><label class="form-label">Nome Cognome</label><input type="text" class="form-control" id="athlete-name" required></div><div class="mb-3"><label class="form-label">URL Foto Profilo</label><input type="url" class="form-control" id="athlete-avatar" placeholder="https://esempio.com/foto.png"></div><div class="mb-3"><label class="form-label">Ruolo</label><input type="text" class="form-control" id="athlete-role" required></div><div class="mb-3"><label class="form-label">Numero Maglia</label><input type="number" class="form-control" id="athlete-number" required min="1"></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="athlete-captain"><label class="form-check-label" for="athlete-captain">Capitano</label></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="submit" class="btn btn-primary-custom" form="athlete-form">Salva Atleta</button></div></div></div></div>
            <div class="modal fade" id="gpsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="gpsModalLabel">Dati Performance di <span id="modal-athlete-name-gps"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="gps-form"><input type="hidden" id="modal-athlete-id-gps">
                <div class="row mb-3"><div class="col-md-8"><label for="gps-session-selector" class="form-label">Seleziona Sessione Esistente per Modificare</label><select id="gps-session-selector" class="form-select"><option value="">--- Inserisci Nuova Sessione ---</option></select></div><div class="col-md-4 d-flex align-items-end"><button type="button" id="delete-gps-session-btn" class="btn btn-outline-danger w-100" disabled>Elimina Sessione</button></div></div><hr>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Data Registrazione</label><input type="date" class="form-control" id="gps-data_di_registrazione" required></div><div class="col-md-4 mb-3"><label class="form-label">Ora Registrazione</label><input type="time" class="form-control" id="gps-ora_registrazione"></div><div class="col-md-4 mb-3"><label class="form-label">Tipo Sessione</label><select class="form-select" id="gps-tipo_sessione"><option value="Allenamento">Allenamento</option><option value="Partita">Partita</option><option value="Individual">Individual</option></select></div></div>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Distanza Totale (m)</label><input type="number" step="0.1" class="form-control" id="gps-distanza_totale" placeholder="es. 10500"></div><div class="col-md-4 mb-3"><label class="form-label">Tempo Totale (min)</label><input type="number" step="0.1" class="form-control" id="gps-tempo_totale" placeholder="es. 92"></div><div class="col-md-4 mb-3"><label class="form-label">Distanza per Minuto (m/min)</label><input type="number" step="0.1" class="form-control" id="gps-distanza_per_minuto" readonly></div></div>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Distanza Sprint (m)</label><input type="number" step="0.1" class="form-control" id="gps-distanza_sprint"></div><div class="col-md-4 mb-3"><label class="form-label">Velocità Massima (km/h)</label><input type="number" step="0.1" class="form-control" id="gps-velocita_massima"></div><div class="col-md-4 mb-3"><label class="form-label">Numero di Sprint</label><input type="number" class="form-control" id="gps-numero_di_sprint"></div></div>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Max Acc (g)o(n°)</label><input type="number" step="0.1" class="form-control" id="gps-max_acc"></div><div class="col-md-4 mb-3"><label class="form-label">Max Dec (g)o(n°)</label><input type="number" step="0.1" class="form-control" id="gps-max_dec"></div><div class="col-md-4 mb-3"><label class="form-label">Passaggi Piede Sinistro</label><input type="number" class="form-control" id="gps-passaggi_piede_sinistro"></div></div>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Passaggi Piede Destro</label><input type="number" class="form-control" id="gps-passaggi_piede_destro"></div><div class="col-md-4 mb-3"><label class="form-label">Cross Piede Sinistro</label><input type="number" step="0.1" class="form-control" id="gps-cross_piede_sinistro"></div><div class="col-md-4 mb-3"><label class="form-label">Cross Piede Destro</label><input type="number" step="0.1" class="form-control" id="gps-cross_piede_destro"></div></div>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Potenza Massima di Tiro (km/h)</label><input type="number" step="0.1" class="form-control" id="gps-potenza_massima_di_tiro"></div><div class="col-md-4 mb-3"><label class="form-label">Tiri Piede SX</label><input type="number" class="form-control" id="gps-tiri_piede_sx"></div><div class="col-md-4 mb-3"><label class="form-label">Tiri Piede DX</label><input type="number" class="form-control" id="gps-tiri_piede_dx"></div></div>
                <div class="row"><div class="col-md-4 mb-3"><label class="form-label">% Passaggi Brevi</label><input type="number" step="0.1" class="form-control" id="gps-perc_passaggi_brevi"></div><div class="col-md-4 mb-3"><label class="form-label">% Lanci</label><input type="number" step="0.1" class="form-control" id="gps-perc_lanci"></div><div class="col-md-4 mb-3"><label class="form-label">Distanza Circuito (m)</label><input type="number" step="1" class="form-control" id="gps-distanza_circuito" placeholder="es. 400"></div></div>
                <div class="row align-items-end"><div class="col-md-5 mb-3"><label class="form-label">Tempo Circuito</label><div class="input-group"><input type="number" class="form-control" id="gps-tempo_circuito_min" placeholder="Min" min="0"><span class="input-group-text">:</span><input type="number" class="form-control" id="gps-tempo_circuito_sec" placeholder="Sec" min="0" max="59"><span class="input-group-text">.</span><input type="number" class="form-control" id="gps-tempo_circuito_cen" placeholder="Cen" min="0" max="99"></div></div><div class="col-md-4 mb-3"><label class="form-label">Velocità (km/h)</label><input type="text" class="form-control" id="gps-velocita_circuito" readonly></div></div>
                <div id="match-stats-fields" style="display: none;"><hr><h5 class="mb-3">Statistiche Partita</h5><div class="row"><div class="col-md-3 mb-3"><label class="form-label">Minuti Giocati</label><input type="number" class="form-control" id="gps-minuti_giocati"></div><div class="col-md-3 mb-3"><label class="form-label">Gol</label><input type="number" class="form-control" id="gps-gol"></div><div class="col-md-3 mb-3"><label class="form-label">Assist</label><input type="number" class="form-control" id="gps-assist"></div><div class="col-md-3 mb-3"><label class="form-label">Ammonizioni</label><input type="number" class="form-control" id="gps-ammonizioni"></div></div><div class="row"><div class="col-md-3 mb-3"><label class="form-label">Espulsioni</label><input type="number" class="form-control" id="gps-espulsioni"></div><div class="col-md-3 mb-3"><label class="form-label">Palle Recuperate</label><input type="number" class="form-control" id="gps-palle_recuperate"></div><div class="col-md-3 mb-3"><label class="form-label">Palle Perse</label><input type="number" class="form-control" id="gps-palle_perse"></div></div></div>
                <div class="row"><div class="col-12 mb-3"><label class="form-label">Note (opzionale)</label><textarea class="form-control" id="gps-note" rows="2" placeholder="Es. Allenamento intenso, recupero infortunio, ecc."></textarea></div></div>
            </form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button><button type="submit" class="btn btn-primary-custom" form="gps-form">Salva Dati GPS</button></div></div></div></div>
            <div class="modal fade" id="sessionModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="sessionModalLabel">Pianifica Sessione</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="session-form"><input type="hidden" id="session-id"><div class="mb-3"><label class="form-label">Data</label><input type="date" class="form-control" id="session-date" required></div><div class="mb-3"><label class="form-label">Titolo/Tipo</label><input type="text" class="form-control" id="session-title" required placeholder="Es. Allenamento tecnico"></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Ora Inizio</label><input type="time" class="form-control" id="session-time"></div><div class="col-md-6 mb-3"><label class="form-label">Luogo</label><input type="text" class="form-control" id="session-location" placeholder="Es. Campo 1"></div></div><div class="mb-3"><label class="form-label">Obiettivi</label><input type="text" class="form-control" id="session-goals" placeholder="Es. Possesso palla, tiri in porta"></div><div class="mb-3"><label class="form-label">Descrizione Allenamento (un punto per riga)</label><textarea class="form-control" id="session-description" rows="5"></textarea></div></form></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-outline-danger" id="delete-session-btn" style="display:none;">Elimina</button><div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="submit" class="btn btn-primary-custom" form="session-form">Salva Sessione</button></div></div></div></div></div>
            <div class="modal fade" id="matchResultModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="matchResultModalLabel">Inserisci Risultato Partita</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="match-result-form"><input type="hidden" id="match-id"><div class="row"><div class="col-md-4 mb-3"><label class="form-label">Data Partita</label><input type="date" class="form-control" id="match-date" required></div><div class="col-md-5 mb-3"><label class="form-label">Squadra Avversaria</label><input type="text" class="form-control" id="match-opponent-name" required></div><div class="col-md-3 mb-3"><label class="form-label">Luogo</label><select class="form-select" id="match-location"><option value="home">Casa</option><option value="away">Trasferta</option></select></div></div><div class="row align-items-center text-center"><div class="col-5"><label class="form-label">GO Sport</label><input type="number" class="form-control text-center" id="match-my-team-score" required min="0" placeholder="Gol"></div><div class="col-2">-</div><div class="col-5"><label class="form-label">AVVERSARI</label><input type="number" class="form-control text-center" id="match-opponent-score" required min="0" placeholder="Gol"></div></div><hr><div class="row mt-3"><div class="col-md-6"><h5><i class="bi bi-futbol"></i> Marcatori (GO Sport)</h5><div id="scorers-container" class="d-grid gap-2"></div><button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-scorer-btn"><i class="bi bi-plus"></i> Aggiungi Marcatore</button></div><div class="col-md-6"><h5><i class="bi bi-file-earmark-person"></i> Cartellini (GO Sport)</h5><div id="cards-container" class="d-grid gap-2"></div><button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-card-btn"><i class="bi bi-plus"></i> Aggiungi Cartellino</button></div></div></form></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-outline-danger" id="delete-match-btn" style="display:none;">Elimina Partita</button><div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="submit" class="btn btn-primary-custom" form="match-result-form">Salva Partita</button></div></div></div></div></div>
            <div class="modal fade" id="passwordModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Accesso Richiesto</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Per visualizzare questi dati è richiesta una password.</p><form id="password-form"><div class="mb-3"><label for="password-input" class="form-label">Password</label><input type="password" class="form-control" id="password-input" required><div id="password-error" class="text-danger mt-2" style="display: none;">Password non corretta.</div></div><button type="submit" class="btn btn-primary-custom w-100">Accedi</button></form></div></div></div></div>`;
        const evaluationModal = new bootstrap.Modal(document.getElementById('evaluationModal'));
        const athleteModal = new bootstrap.Modal(document.getElementById('athleteModal'));
        const gpsModal = new bootstrap.Modal(document.getElementById('gpsModal'));
        const sessionModal = new bootstrap.Modal(document.getElementById('sessionModal'));
        const matchResultModal = new bootstrap.Modal(document.getElementById('matchResultModal'));
        const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
        const elements = {
            athleteGrid: document.getElementById('athlete-grid'),
            evaluationDatePicker: document.getElementById('evaluation-date-picker'),
            evaluationDatePickerSync: document.getElementById('evaluation-date-picker-sync'),
            performanceSelectorsContainer: document.getElementById('performance-selectors-container'),
            addComparisonBtn: document.getElementById('add-comparison-btn'),
            evaluationForm: document.getElementById('evaluation-form'),
            athleteForm: document.getElementById('athlete-form'),
            gpsForm: document.getElementById('gps-form'),
            addAthleteBtn: document.getElementById('add-athlete-btn'),
            comparisonPeriodToggle: document.getElementById('comparison-period-toggle'),
            attendancePeriodToggle: document.getElementById('attendance-period-toggle'),
            metricSelector: document.getElementById('performance-metric-selector'),
            tableContainer: document.getElementById('performance-table-container'),
            exportButtonsContainer: document.getElementById('export-buttons-container'),
            trendAthleteSelector: document.getElementById('trend-athlete-selector'),
            trendMetricSelector: document.getElementById('trend-metric-selector'),
            hallOfFameContainer: document.getElementById('hall-of-fame-container'),
            radarAthleteSelector1: document.getElementById('radar-athlete-selector-1'),
            radarAthleteSelector2: document.getElementById('radar-athlete-selector-2'),
            multiAthleteMetricSelector: document.getElementById('multi-athlete-metric-selector'),
            multiAthleteTimeFilter: document.querySelector('#multi-athlete-chart-container .btn-group[role="group"]'),
            multiAthleteDatepicker: document.getElementById('multi-athlete-datepicker'),
            multiAthleteDatepickerContainer: document.getElementById('multi-athlete-datepicker-container'),
            multiAthleteResetBtn: document.getElementById('multi-athlete-reset-btn'),
            deleteDayDataBtn: document.getElementById('delete-day-data-btn'),
            exportAllDataBtn: document.getElementById('export-all-data-btn'),
            importFileInput: document.getElementById('import-file-input'),
            performanceFilterToggle: document.getElementById('performance-filter-toggle'),
            multiAthleteTypeSelector: document.getElementById('multi-athlete-type-selector'),
            addSessionBtn: document.getElementById('add-session-btn'),
            calendarGrid: document.getElementById('calendar-grid'),
            currentMonthYearEl: document.getElementById('current-month-year'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            sessionForm: document.getElementById('session-form'),
            deleteSessionBtn: document.getElementById('delete-session-btn'),
            homeTotalAthletes: document.getElementById('home-total-athletes'),
            homeNextSession: document.getElementById('home-next-session'),
            homeTopPerformer: document.getElementById('home-top-performer'),
            quickAddAthleteBtn: document.getElementById('quick-add-athlete-btn'),
            quickPlanSessionBtn: document.getElementById('quick-plan-session-btn'),
            fieldContainer: document.getElementById('field-container'),
            fieldBenchArea: document.getElementById('field-bench-area'),
            availableList: document.getElementById('available-list'),
            addMatchBtn: document.getElementById('add-match-btn'),
            matchResultForm: document.getElementById('match-result-form'),
            deleteMatchBtn: document.getElementById('delete-match-btn'),
            matchResultsContainer: document.getElementById('match-results-container'),
            cardsSummaryTbody: document.getElementById('cards-summary-tbody'),
            matchOpponentFilter: document.getElementById('match-opponent-filter'),
            matchPeriodToggle: document.getElementById('match-period-toggle'),
            topScorersContainer: document.getElementById('top-scorers-container'),
            passwordForm: document.getElementById('password-form'),
            passwordError: document.getElementById('password-error'),
        };
        // --- GESTIONE PASSWORD ---
        const ACCESS_PASSWORD = "2025Edy201"; // Modifica qui per cambiare la password
        let authSuccessCallback = null;
        let authCancelCallback = null;
        const isAuthenticated = () => sessionStorage.getItem('isAuthenticated') === 'true';
        const requestAuthentication = (onSuccess, onCancel = () => {}) => {
            if (isAuthenticated()) {
                onSuccess();
                return;
            }
            authSuccessCallback = onSuccess;
            authCancelCallback = onCancel;
            elements.passwordError.style.display = 'none';
            elements.passwordForm.reset();
            passwordModal.show();
        };
        elements.passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('password-input').value;
            if (password === ACCESS_PASSWORD) {
                sessionStorage.setItem('isAuthenticated', 'true');
                elements.passwordError.style.display = 'none';
                passwordModal.hide();
                if (authSuccessCallback) authSuccessCallback();
                // Ricarica i componenti UI per mostrare i dati protetti
                updateAllUI();
            } else {
                elements.passwordError.style.display = 'block';
            }
        });
        document.getElementById('passwordModal').addEventListener('hidden.bs.modal', () => {
             if (!isAuthenticated() && authCancelCallback) {
                authCancelCallback();
             }
        });
        // --- FINE GESTIONE PASSWORD ---
        const matchStatsFields = ['minuti_giocati', 'gol', 'assist', 'ammonizioni', 'espulsioni', 'palle_recuperate', 'palle_perse'];
        const allGpsFields = ['data_di_registrazione', 'ora_registrazione', 'tipo_sessione', 'distanza_totale', 'tempo_totale', 'distanza_sprint', 'velocita_massima', 'numero_di_sprint', 'max_acc', 'max_dec', 'passaggi_piede_sinistro', 'passaggi_piede_destro', 'cross_piede_sinistro', 'cross_piede_destro', 'potenza_massima_di_tiro', 'distanza_per_minuto', 'tiri_piede_sx', 'tiri_piede_dx', 'perc_passaggi_brevi', 'perc_lanci', 'distanza_circuito', 'tempo_circuito_totale_s', 'velocita_circuito', 'note', ...matchStatsFields];
        const gpsFieldsForDisplay = { 'tipo_sessione':'Tipo', 'data_di_registrazione': 'Data', 'ora_registrazione': 'Ora', 'distanza_totale': 'Dist. Totale (m)', 'tempo_totale': 'Tempo (min)', 'distanza_per_minuto':'Dist/min (m)', 'distanza_sprint': 'Distanza Sprint (m)', 'velocita_massima': 'Vel. Max (km/h)', 'numero_di_sprint': 'Num. Sprint', 'max_acc': 'Max Acc (g)o(n°)', 'max_dec': 'Max Dec (g)o(n°)', 'passaggi_piede_sinistro':'Passaggi SX', 'passaggi_piede_destro':'Passaggi DX', 'cross_piede_sinistro':'Cross SX', 'cross_piede_destro':'Cross DX', 'potenza_massima_di_tiro':'Pot. Tiro (km/h)', 'tiri_piede_sx': 'Tiri Piede SX', 'tiri_piede_dx': 'Tiri Piede DX', 'perc_passaggi_brevi': '% Passaggi Brevi', 'perc_lanci': '% Lanci', 'distanza_circuito': 'Dist. Circuito (m)', 'tempo_circuito_totale_s': 'Tempo Circuito (s)', 'velocita_circuito': 'Vel. Circuito (km/h)', 'minuti_giocati': 'Minuti Giocati', 'gol': 'Gol', 'assist': 'Assist', 'ammonizioni': 'Gialli', 'espulsioni': 'Rossi', 'palle_recuperate': 'Palle Recuperate', 'palle_perse': 'Palle Perse', 'note': 'Note' };
        const radarMetrics = { 'distanza_sprint': 'Distanza Sprint', 'velocita_massima': 'Vel. Max', 'max_acc': 'Max Acc', 'max_dec': 'Max Dec', 'passaggi_piede_sinistro': 'Pass. SX', 'passaggi_piede_destro': 'Pass. DX', 'cross_piede_sinistro': 'Cross SX', 'cross_piede_destro': 'Cross DX', 'potenza_massima_di_tiro': 'Pot. Tiro', 'distanza_per_minuto': 'Dist/min', 'tiri_piede_sx': 'Tiri SX', 'tiri_piede_dx': 'Tiri DX', 'perc_passaggi_brevi': '% Pass. Brevi', 'perc_lanci': '% Lanci', 'velocita_circuito': 'Vel. Circuito' };
        const evaluationCategories = ['presenza-allenamento', 'serieta-allenamento', 'abbigliamento-allenamento', 'abbigliamento-partita', 'comunicazioni', 'doccia'];
        const defaultAvatar = "image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3e%3cpath fill='%231e5095' d='M128 128H0V0h128v128z'/%3e%3cpath fill='%23ffffff' d='M64 100c-19.88 0-36-16.12-36-36s16.12-36 36-36 36 16.12 36 36-16.12 36-36 36zm0-64c-15.46 0-28 12.54-28 28s12.54 28 28 28 28-12.54 28-28-12.54-28-28-28z'/%3e%3cpath fill='%23ffffff' d='M64 24a40.01 40.01 0 00-28.28 11.72C35.8 35.8 28 45.45 28 56h8c0-8.27 5.61-15.64 13.53-18.89A31.93 31.93 0 0164 32a32.09 32.09 0 0124.47 11.11C96.39 40.36 102 47.73 102 56h8c0-10.55-7.8-20.2-17.72-24.28A39.99 39.99 0 0064 24z'/%3e%3c/svg%3e";
        let athletes = [], evaluations = {}, gpsData = {}, awards = {}, trainingSessions = {}, matchResults = {};
        let formationData = { starters: [], bench: [], tokens: [] };
        let chartInstances = {};
        let comparisonChartPeriod = 'daily';
        let attendanceChartPeriod = 'daily';
        let performanceSelections = [ { athleteId: null, date: null }, { athleteId: null, date: null } ];
        let performanceFilterType = 'all';
        let multiAthleteFilterType = 'all';
        let currentCalendarDate = new Date();
        let pollingInterval = null;
        // --- GESTIONE DATI ---
        const saveData = async () => {
            const allData = { athletes, evaluations, gpsData, awards, trainingSessions, formationData, matchResults };
            try {
                await fetch('/api/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allData)
                });
            } catch (error) {
                console.error('Errore nel salvataggio dei dati sul server:', error);
            }
        };
        const loadData = async () => {
            try {
                const response = await fetch('/api/data', { cache: 'no-store' });
                if (!response.ok) throw new Error(`Errore HTTP: ${response.status}`);
                const allData = await response.json();
                athletes = allData.athletes || [];
                evaluations = allData.evaluations || {};
                gpsData = allData.gpsData || {};
                awards = allData.awards || {};
                trainingSessions = allData.trainingSessions || {};
                formationData = allData.formationData || { starters: [], bench: [], tokens: [] };
                matchResults = allData.matchResults || {};
            } catch (error) {
                console.error('Errore nel caricamento dei dati dal server:', error);
                athletes = []; evaluations = {}; gpsData = {}; awards = {}; trainingSessions = {}; formationData = { starters: [], bench: [], tokens: [] }; matchResults = {};
            }
        };
        const getWeekRange = (date) => {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6));
            return { start: monday.toISOString().split('T')[0], end: sunday.toISOString().split('T')[0] };
        };
        const calculateAthleteScore = (evaluation) => !evaluation ? 0 : Object.keys(evaluation).filter(k => k !== 'doccia').reduce((sum, key) => sum + parseInt(evaluation[key] || 0, 10), 0);
        // --- FUNZIONI UI ---
        const updateAllUI = () => {
            updateHomePage();
            renderAthletes();
            renderCalendar();
            renderFormation();
            renderMatchResults();
            renderCardsSummary();
            renderTopScorers();
            updateMatchAnalysisChart();
            updateEvaluationCharts();
            updateAttendanceChart();
            updateHallOfFame();
            populatePerformanceSelectors();
            populateAnalysisSelectors();
            updatePerformanceChart();
            updateAthleteTrendChart();
            updateAthleteRadarChart();
            updateMultiAthleteChart();
        };
        const createJerseyElement = (athlete) => {
            const jersey = document.createElement('div');
            jersey.className = 'player-jersey';
            jersey.draggable = true;
            jersey.dataset.athleteId = athlete.id;
            jersey.dataset.role = athlete.role;
            const jerseyColor = athlete.role.toLowerCase().includes('portiere') ? 'var(--gk-color)' : 'var(--secondary-blue)';
            jersey.innerHTML = `<div class="jersey-body" style="background-color: ${jerseyColor};"><span class="jersey-number">${athlete.number}</span></div><span class="player-name">${athlete.name}</span>`;
            return jersey;
        };
        const createTokenElement = (type, id) => {
            const token = document.createElement('div');
            token.className = 'token';
            token.draggable = true;
            token.dataset.itemType = type;
            token.dataset.tokenId = id;
            switch(type) {
                case 'captain-c': token.innerHTML = '(C)'; token.classList.add('token-captain'); break;
                case 'captain-vc': token.innerHTML = '(VC)'; token.classList.add('token-captain'); break;
                case 'ball': token.innerHTML = '⚽'; token.classList.add('token-ball'); break;
                case 'opponent': token.classList.add('token-opponent'); break;
            }
            return token;
        };
        const renderFormation = () => {
            const field = elements.fieldContainer;
            const bench = elements.fieldBenchArea;
            document.querySelectorAll('.player-jersey, .token').forEach(el => el.remove());
            elements.availableList.innerHTML = '';
            const placedAthleteIds = new Set([...formationData.starters.map(p => String(p.athleteId)), ...formationData.bench.map(p => String(p.athleteId))]);
            formationData.starters.forEach(playerData => {
                const athlete = athletes.find(a => String(a.id) === String(playerData.athleteId));
                if (athlete) {
                    const jersey = createJerseyElement(athlete);
                    jersey.style.left = `calc(${playerData.left}% - 3em)`;
                    jersey.style.top = `calc(${playerData.top}% - 3em)`;
                    field.appendChild(jersey);
                }
            });
            formationData.bench.forEach(playerData => {
                const athlete = athletes.find(a => String(a.id) === String(playerData.athleteId));
                if (athlete) {
                    const jersey = createJerseyElement(athlete);
                    jersey.style.left = `calc(${playerData.left}% - 3em)`;
                    jersey.style.top = `calc(${playerData.top}% - 3em)`;
                    bench.appendChild(jersey);
                }
            });
            athletes.forEach(athlete => {
                if (!placedAthleteIds.has(String(athlete.id))) {
                    const availablePlayer = document.createElement('div');
                    availablePlayer.className = 'list-group-item d-flex justify-content-between align-items-center available-player p-2';
                    availablePlayer.draggable = true;
                    availablePlayer.dataset.athleteId = athlete.id;
                    availablePlayer.innerHTML = `<span><strong>${athlete.number}.</strong> ${athlete.name}</span><span class="badge bg-secondary">${athlete.role.substring(0,3)}</span>`;
                    elements.availableList.appendChild(availablePlayer);
                }
            });
            formationData.tokens.forEach(tokenData => {
                const tokenEl = createTokenElement(tokenData.type, tokenData.id);
                tokenEl.style.left = `calc(${tokenData.left}% - 1.25em)`;
                tokenEl.style.top = `calc(${tokenData.top}% - 1.25em)`;
                field.appendChild(tokenEl);
            });
        };
        const updateHomePage = () => { 
            elements.homeTotalAthletes.textContent = athletes.length;
            const today = new Date().toISOString().split('T')[0];
            const futureSessions = Object.entries(trainingSessions)
                .filter(([date]) => date >= today)
                .sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB))
                .flatMap(([date, sessions]) => sessions.map(s => ({...s, date})));
            if (futureSessions.length > 0) {
                const nextSession = futureSessions[0];
                const sessionDate = new Date(nextSession.date);
                elements.homeNextSession.innerHTML = `<h5 class="card-title text-muted">PROSSIMA SESSIONE</h5><h6 class="mb-1">${nextSession.title}</h6><p class="mb-0">${sessionDate.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}</p><p class="mb-0 text-muted">${nextSession.time ? `Ore: ${nextSession.time}` : ''} ${nextSession.location ? `@ ${nextSession.location}` : ''}</p>`;
            } else {
                elements.homeNextSession.innerHTML = `<h5 class="card-title text-muted">PROSSIMA SESSIONE</h5><p class="text-muted">Nessuna sessione pianificata</p>`;
            }
            const now = new Date();
            const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthlyScores = {};
            athletes.forEach(a => monthlyScores[a.id] = { name: a.name, score: 0 });
            Object.entries(evaluations).forEach(([dateStr, dailyEvals]) => {
                if (dateStr.startsWith(currentMonthStr)) {
                    Object.entries(dailyEvals).forEach(([athleteId, evaluation]) => {
                        if (monthlyScores[athleteId]) { monthlyScores[athleteId].score += calculateAthleteScore(evaluation); }
                    });
                }
            });
            const sortedAthletes = Object.values(monthlyScores).sort((a, b) => b.score - a.score);
            if (sortedAthletes.length > 0 && sortedAthletes[0].score > 0) {
                const maxScore = sortedAthletes[0].score;
                const topPerformers = sortedAthletes.filter(athlete => athlete.score === maxScore);
                const names = topPerformers.map(p => p.name).join('<br>');
                elements.homeTopPerformer.innerHTML = `<h5 class="card-title text-muted">TOP PERFORMER MENSILE</h5><h6 class="mb-1">${names}</h6><p class="mb-0 text-muted">Punteggio: ${maxScore}</p><i class="bi bi-trophy-fill mt-2" style="font-size: 1.5rem; color: var(--gold-star);"></i>`;
            } else {
                elements.homeTopPerformer.innerHTML = `<h5 class="card-title text-muted">TOP PERFORMER MENSILE</h5><p class="text-muted">Nessuna valutazione</p>`;
            }
        };
        const renderAthletes = () => {
            elements.athleteGrid.innerHTML = '';
            athletes.forEach(athlete => {
                const card = document.createElement('div');
                card.className = 'col-xl-3 col-lg-4 col-md-6 mb-4';
                card.innerHTML = `<div class="card athlete-card"><div class="card-body athlete-card-clickable" data-athlete-id="${athlete.id}"><img src="${athlete.avatar || defaultAvatar}" onerror="this.src='${defaultAvatar}'" alt="${athlete.name}" class="athlete-avatar me-3"><div><h5 class="card-title mb-0">${athlete.name} ${athlete.isCaptain ? '<i class="bi bi-star-fill is-captain"></i>' : ''}</h5><p class="card-text text-muted">${athlete.role}</p></div><div class="shirt-number">${athlete.number}</div></div><div class="card-actions no-print"><button class="btn btn-sm btn-outline-light gps-btn" title="Dati Performance" data-athlete-id="${athlete.id}"><i class="bi bi-person-fill-gear"></i></button><button class="btn btn-sm btn-outline-light edit-btn" title="Modifica Atleta" data-athlete-id="${athlete.id}"><i class="bi bi-pencil-fill"></i></button><button class="btn btn-sm btn-outline-light delete-btn" title="Elimina Atleta" data-athlete-id="${athlete.id}"><i class="bi bi-trash-fill"></i></button></div></div>`;
                elements.athleteGrid.appendChild(card);
            });
        };
        const renderCalendar = () => {
            elements.calendarGrid.innerHTML = '';
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            elements.currentMonthYearEl.textContent = `${currentCalendarDate.toLocaleString('it-IT', { month: 'long' })} ${year}`;
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;
            for (let i = 0; i < startDayOfWeek; i++) {
                elements.calendarGrid.innerHTML += `<div class="calendar-day other-month"></div>`;
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                if (dateString === new Date().toISOString().split('T')[0]) {
                    dayCell.classList.add('today');
                }
                dayCell.innerHTML = `<div class="calendar-day-header">${day}</div>`;
                if (trainingSessions[dateString]) {
                    trainingSessions[dateString].forEach(session => {
                        const sessionEl = document.createElement('div');
                        sessionEl.className = 'calendar-session';
                        sessionEl.textContent = session.title;
                        sessionEl.dataset.sessionId = session.id;
                        sessionEl.dataset.date = dateString;
                        dayCell.appendChild(sessionEl);
                    });
                }
                elements.calendarGrid.appendChild(dayCell);
            }
        };
        const openSessionModal = (sessionData = null) => {
            elements.sessionForm.reset();
            if(sessionData) {
                document.getElementById('sessionModalLabel').textContent = "Modifica Sessione";
                document.getElementById('session-id').value = sessionData.id;
                document.getElementById('session-date').value = sessionData.date;
                document.getElementById('session-title').value = sessionData.title;
                document.getElementById('session-time').value = sessionData.time;
                document.getElementById('session-location').value = sessionData.location;
                document.getElementById('session-goals').value = sessionData.goals;
                document.getElementById('session-description').value = sessionData.description;
                elements.deleteSessionBtn.style.display = 'block';
            } else {
                document.getElementById('sessionModalLabel').textContent = "Pianifica Sessione";
                document.getElementById('session-id').value = '';
                document.getElementById('session-date').valueAsDate = new Date();
                elements.deleteSessionBtn.style.display = 'none';
            }
            sessionModal.show();
        };
        // --- FUNZIONI RISULTATI PARTITE E CLASSIFICHE ---
        const renderMatchResults = () => {
            elements.matchResultsContainer.innerHTML = '';
            const sortedMatches = Object.values(matchResults).sort((a, b) => new Date(b.date) - new Date(a.date));
            if (sortedMatches.length === 0) {
                elements.matchResultsContainer.innerHTML = '<p class="text-muted">Nessun risultato inserito.</p>';
                return;
            }
            sortedMatches.forEach(match => {
                const myTeamName = "GO Sport";
                const homeTeamName = match.location === 'home' ? myTeamName : match.opponentName;
                const awayTeamName = match.location === 'away' ? myTeamName : match.opponentName;
                const myTeamScorers = match.scorers.map(s => {
                    const athlete = athletes.find(a => String(a.id) === String(s.athleteId));
                    return athlete ? athlete.name.split(' ').pop() : '';
                }).filter(name => name).join(', ');
                const colDiv = document.createElement('div');
                colDiv.className = 'col-lg-4 col-md-6 mb-3';
                const cardContent = `
                    <div class="card h-100 match-result-item" data-match-id="${match.id}" style="cursor: pointer;">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">${new Date(match.date).toLocaleDateString('it-IT', {day: '2-digit', month: 'short', year: 'numeric'})}</small>
                                <a href="#" class="no-print edit-match-btn" data-match-id="${match.id}"><i class="bi bi-pencil-fill"></i></a>
                            </div>
                            <div>
                                ${homeTeamName} vs ${awayTeamName}
                                <strong class="match-score ms-2">${match.homeScore} - ${match.awayScore}</strong>
                            </div>
                            ${myTeamScorers ? `<div class="scorers-list"><i class="bi bi-futbol"></i> Marcatori: <strong style="color: var(--primary-red);">${myTeamScorers}</strong></div>` : ''}
                        </div>
                    </div>`;
                colDiv.innerHTML = cardContent;
                elements.matchResultsContainer.appendChild(colDiv);
                colDiv.querySelector('.match-result-item').addEventListener('click', (e) => {
                     e.preventDefault();
                     if (!e.target.closest('.edit-match-btn')) {
                        openMatchResultModal(match.id);
                     }
                });
            });
        };
        const renderCardsSummary = () => {
            elements.cardsSummaryTbody.innerHTML = '';
            const allCards = Object.values(matchResults)
                .flatMap(match => match.cards.map(card => ({ ...card, date: match.date })))
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            if (allCards.length === 0) {
                elements.cardsSummaryTbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nessun cartellino.</td></tr>';
                return;
            }
            allCards.forEach(card => {
                const athlete = athletes.find(a => String(a.id) === String(card.athleteId));
                const row = `
                    <tr>
                        <td>${athlete ? athlete.name : 'N/D'}</td>
                        <td>${card.type === 'yellow' ? '1' : '0'}</td>
                        <td>${card.type === 'red' ? '1' : '0'}</td>
                        <td>${new Date(card.date).toLocaleDateString('it-IT', {day: '2-digit', month: 'short'})}</td>
                    </tr>
                `;
                elements.cardsSummaryTbody.innerHTML += row;
            });
        };
        const renderTopScorers = () => {
            const goalCounts = {};
            Object.values(matchResults).forEach(match => {
                match.scorers.forEach(scorer => {
                    goalCounts[scorer.athleteId] = (goalCounts[scorer.athleteId] || 0) + 1;
                });
            });
            const sortedScorers = Object.entries(goalCounts)
                .map(([athleteId, goals]) => {
                    const athlete = athletes.find(a => String(a.id) === athleteId);
                    return { name: athlete ? athlete.name : 'Sconosciuto', goals };
                })
                .sort((a, b) => b.goals - a.goals);
            if (sortedScorers.length === 0) {
                elements.topScorersContainer.innerHTML = '<p class="text-muted">Nessun marcatore registrato.</p>';
                return;
            }
            let ol = '<ol class="list-group list-group-numbered">';
            sortedScorers.forEach(scorer => {
                ol += `<li class="list-group-item d-flex justify-content-between align-items-center" style="background: transparent; border-color: var(--border-color);">
                    ${scorer.name}
                    <span class="badge bg-danger rounded-pill">${scorer.goals}</span>
                </li>`;
            });
            ol += '</ol>';
            elements.topScorersContainer.innerHTML = ol;
        };
        const updateMatchAnalysisChart = () => {
            const opponentFilter = elements.matchOpponentFilter.value;
            const period = elements.matchPeriodToggle.querySelector('.active').dataset.period;
            let filteredMatches = Object.values(matchResults).sort((a,b) => new Date(a.date) - new Date(b.date));
            let labels, datasets;
            if (opponentFilter !== 'all') {
                elements.matchPeriodToggle.style.display = 'none';
                filteredMatches = filteredMatches.filter(m => m.opponentName === opponentFilter);
                labels = filteredMatches.map(m => new Date(m.date).toLocaleDateString('it-IT', {day:'2-digit', month:'short'}));
                datasets = [
                    { label: 'Vittorie', data: [], backgroundColor: '#d90429' },
                    { label: 'Pareggi',  [], backgroundColor: '#1e5095' },
                    { label: 'Sconfitte',  [], backgroundColor: '#6c757d' },
                ];
                filteredMatches.forEach(match => {
                    const myScore = match.location === 'home' ? match.homeScore : match.awayScore;
                    const oppScore = match.location === 'home' ? match.awayScore : match.homeScore;
                    datasets[0].data.push(myScore > oppScore ? 1 : 0);
                    datasets[1].data.push(myScore == oppScore ? 1 : 0);
                    datasets[2].data.push(myScore < oppScore ? 1 : 0);
                });
            } else {
                elements.matchPeriodToggle.style.display = 'flex';
                const getPeriodKey = (date, period) => {
                    const d = new Date(date);
                    const year = d.getFullYear();
                    const month = d.getMonth();
                    if (period === 'annual') return `${year}`;
                    if (period === 'semester') return `${year}-S${Math.floor(month / 6) + 1}`;
                    if (period === 'trimester') return `${year}-T${Math.floor(month / 3) + 1}`;
                    if (period === 'bimonthly') return `${year}-B${Math.floor(month / 2) + 1}`;
                    return `${year}-${String(month + 1).padStart(2, '0')}`;
                };
                const resultsByPeriod = {};
                filteredMatches.forEach(match => {
                    const key = getPeriodKey(match.date, period);
                    if (!resultsByPeriod[key]) {
                        resultsByPeriod[key] = { W: 0, D: 0, L: 0 };
                    }
                    const myScore = match.location === 'home' ? match.homeScore : match.awayScore;
                    const oppScore = match.location === 'home' ? match.awayScore : match.homeScore;
                    if (myScore > oppScore) resultsByPeriod[key].W++;
                    else if (myScore < oppScore) resultsByPeriod[key].L++;
                    else resultsByPeriod[key].D++;
                });
                labels = Object.keys(resultsByPeriod).sort();
                datasets = [
                    { label: 'Vittorie', data: labels.map(l => resultsByPeriod[l].W), backgroundColor: '#d90429' },
                    { label: 'Pareggi',  labels.map(l => resultsByPeriod[l].D), backgroundColor: '#1e5095' },
                    { label: 'Sconfitte',  labels.map(l => resultsByPeriod[l].L), backgroundColor: '#6c757d' },
                ];
            }
            const data = { labels, datasets };
            if (chartInstances.matchResults) chartInstances.matchResults.destroy();
            chartInstances.matchResults = new Chart(document.getElementById('matchResultsChart').getContext('2d'), {
                type: 'bar',
                 data,
                options: {
                    scales: {
                        x: { stacked: true, ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } },
                        y: { stacked: true, ticks: { color: '#ffffff', stepSize: 1 }, grid: { color: 'rgba(241, 241, 241, 0.2)' } }
                    },
                    plugins: { legend: { labels: { color: '#ffffff' } } }
                }
            });
            const opponents = [...new Set(Object.values(matchResults).map(m => m.opponentName))];
            elements.matchOpponentFilter.innerHTML = `<option value="all">Tutti gli avversari</option>`;
            opponents.sort().forEach(opp => {
                const selected = opp === opponentFilter ? 'selected' : '';
                elements.matchOpponentFilter.innerHTML += `<option value="${opp}" ${selected}>${opp}</option>`;
            });
        };
        // --- FINE FUNZIONI ---
        const updateEvaluationCharts = () => {
            const date = elements.evaluationDatePicker.value;
            if (!date) return;
            const last7Days = Array.from({length: 7}, (_, i) => new Date(Date.now() - i * 864e5).toISOString().split('T')[0]).reverse();
            const teamDailyAvgScores = last7Days.map(d => {
                let total = 0, count = 0;
                if (evaluations[d]) {
                    Object.values(evaluations[d]).forEach(ev => {
                        total += calculateAthleteScore(ev);
                        count++;
                    });
                }
                return count > 0 ? (total / count).toFixed(2) : 0;
            });
            if(chartInstances.dailyTeam) chartInstances.dailyTeam.destroy();
            chartInstances.dailyTeam = new Chart(document.getElementById('dailyTeamChart').getContext('2d'), {
                type: 'line',
                 {
                    labels: last7Days.map(d => new Date(d).toLocaleDateString('it-IT', {day:'2-digit', month:'short'})),
                    datasets: [{ label: 'Punteggio Medio', data: teamDailyAvgScores, borderColor: 'rgba(217, 4, 41, 1)', backgroundColor: 'rgba(217, 4, 41, 0.2)', tension: 0.3 }]
                },
                options: { scales: { y: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } }, x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } } }, plugins: { legend: { labels: { color: '#ffffff' } } } }
            });
            const scores = {};
            athletes.forEach(a => scores[String(a.id)] = { name: a.name, score: 0 });
            if (comparisonChartPeriod === 'daily') {
                if(evaluations[date]) { Object.entries(evaluations[date]).forEach(([id, ev]) => { if(scores[id]) scores[id].score += calculateAthleteScore(ev); }); }
            } else if (comparisonChartPeriod === 'monthly') {
                const month = date.substring(0, 7);
                Object.keys(evaluations).filter(d => d.startsWith(month)).forEach(d => { Object.entries(evaluations[d]).forEach(([id, ev]) => { if(scores[id]) scores[id].score += calculateAthleteScore(ev); }); });
            } else {
                const week = getWeekRange(date);
                Object.keys(evaluations).filter(d => d >= week.start && d <= week.end).forEach(d => { Object.entries(evaluations[d]).forEach(([id, ev]) => { if(scores[id]) scores[id].score += calculateAthleteScore(ev); }); });
            }
            const allSortedScores = Object.values(scores).filter(a => a.score > 0).sort((a, b) => b.score - a.score);
            let scoresToShow = allSortedScores;
            if (allSortedScores.length > 20) {
                const cutoffScore = allSortedScores[19].score;
                scoresToShow = allSortedScores.filter(a => a.score >= cutoffScore);
            }
            if(chartInstances.monthlyComparison) chartInstances.monthlyComparison.destroy();
            chartInstances.monthlyComparison = new Chart(document.getElementById('monthlyComparisonChart').getContext('2d'), {
                type: 'bar',
                 {
                    labels: scoresToShow.map(a=>a.name),
                    datasets: [{ label: 'Punteggio Totale', data: scoresToShow.map(a=>a.score), backgroundColor: 'rgba(217, 4, 41, 0.8)' }]
                },
                options: { indexAxis: 'y', scales: { y: { ticks: { color: '#ffffff', font: { size: 9 }, autoSkip: false }, grid: { color: 'rgba(241, 241, 241, 0.2)' } }, x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } } }, plugins: { legend: { labels: { color: '#ffffff' } } } }
            });
        };
        const updateAttendanceChart = () => {
            const date = elements.evaluationDatePicker.value;
            if (!date) return;
            const attendanceData = {};
            athletes.forEach(a => attendanceData[String(a.id)] = { name: a.name, count: 0 });
            if (attendanceChartPeriod === 'daily') {
                if (evaluations[date]) { Object.entries(evaluations[date]).forEach(([id, ev]) => { if (attendanceData[id] && ev['presenza-allenamento'] && parseInt(ev['presenza-allenamento'], 10) > 0) { attendanceData[id].count = 1; } }); }
            } else if (attendanceChartPeriod === 'monthly') {
                const month = date.substring(0, 7);
                Object.keys(evaluations).filter(d => d.startsWith(month)).forEach(d => { Object.entries(evaluations[d]).forEach(([id, ev]) => { if (attendanceData[id] && ev['presenza-allenamento'] && parseInt(ev['presenza-allenamento'], 10) > 0) { attendanceData[id].count++; } }); });
            } else {
                const week = getWeekRange(date);
                Object.keys(evaluations).filter(d => d >= week.start && d <= week.end).forEach(d => { Object.entries(evaluations[d]).forEach(([id, ev]) => { if (attendanceData[id] && ev['presenza-allenamento'] && parseInt(ev['presenza-allenamento'], 10) > 0) { attendanceData[id].count++; } }); });
            }
            const sortedAttendance = Object.values(attendanceData).sort((a, b) => b.count - a.count);
            if(chartInstances.attendance) chartInstances.attendance.destroy();
            chartInstances.attendance = new Chart(document.getElementById('attendanceChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sortedAttendance.map(a => a.name),
                    datasets: [{ label: 'Presenze',  sortedAttendance.map(a => a.count), backgroundColor: 'rgba(217, 4, 41, 0.8)' }]
                },
                options: { scales: { y: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } }, x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(241, 241, 241, 0.2)' } } }, plugins: { legend: { labels: { color: '#ffffff' } } } }
            });
        };
        const updateHallOfFame = () => {
            elements.hallOfFameContainer.innerHTML = '';
            const allAwards = Object.values(awards).flat();
            if (allAwards.length === 0) {
                elements.hallOfFameContainer.innerHTML = '<p class="text-muted">Nessun premio assegnato per questa stagione.</p>';
                return;
            }
            allAwards.forEach(award => {
                const athlete = athletes.find(a => a.id.toString() === award.athleteId.toString());
                if (athlete) {
                    const awardCard = document.createElement('div');
                    awardCard.className = 'card award-card text-center';
                    const dateObj = new Date(award.date);
                    const formattedDate = !isNaN(dateObj) ? dateObj.toLocaleDateString('it-IT') : 'Data non disponibile';
                    awardCard.innerHTML = `<div class="card-body p-2"><img src="${athlete.avatar || defaultAvatar}" onerror="this.src='${defaultAvatar}'" alt="${athlete.name}" class="award-avatar mx-auto mb-2 rounded-circle"><h6 class="mb-1" style="font-size: 0.9rem;">${athlete.name}</h6><p class="mb-0" style="font-size: 0.8rem; color: #000;">${formattedDate}</p><small>${award.reason}</small><i class="bi bi-award-fill mt-2" style="font-size: 1.5rem;"></i></div>`;