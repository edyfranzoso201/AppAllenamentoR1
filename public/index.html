<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Squadra e Formazione</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Arial', sans-serif; }
        .player-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background-color: #f9f9f9; position: relative; }
        .player-card.selected { background-color: #e0ffe0; border-color: #0f0; }
        .player-card .btn-group { margin-top: 10px; }
        .form-section { margin-bottom: 30px; padding: 20px; border: 1px solid #eee; border-radius: 10px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .team-management-section { margin-top: 20px; }
        #team-overview .player-card { cursor: pointer; }
        #field { border: 2px solid #000; height: 600px; position: relative; background-color: #28a745; margin-bottom: 20px; overflow: hidden; }
        .field-player { position: absolute; background-color: #007bff; color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: grab; z-index: 10; border: 2px solid #fff; }
        .field-player.ui-draggable-dragging { cursor: grabbing; z-index: 100; }
        #formation-players { min-height: 100px; border: 1px dashed #ccc; padding: 10px; margin-top: 10px; }
        .player-list-item { background-color: #e9ecef; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .player-list-item .badge { margin-left: 10px; }

        /* Grafici */
        #performance-chart-container { height: 300px; width: 100%; }
        #performanceChartSingle, #performanceChartTeam { max-height: 300px; }

        /* Semaforo Scadenze */
        .deadline-status {
            font-size: 2rem; 
            position: absolute;
            top: 50%;
            right: 15px; 
            transform: translateY(-50%);
            z-index: 5;
        }
        .status-green { color: #28a745; }
        .status-yellow { color: #ffc107; }
        .status-red { color: #dc3545; }
        .status-purple { color: #6f42c1; }

        .alert-fixed { position: fixed; top: 0; left: 0; width: 100%; z-index: 1050; border-radius: 0; }

        .remove-from-formation-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="expiration-alerts" class="alert-fixed d-none"></div>

    <div class="container mt-4">
        <h1 class="mb-4 text-center">Gestione Squadra e Formazione</h1>

        
<div class="form-section team-management-section">
            <h2 class="mb-3">Gestione Atleti</h2>

            
<form id="player-form" class="mb-4">
                <input type="hidden" id="player-id">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="nome" class="form-label">Nome</label>
                        <input type="text" class="form-control" id="nome" required>
                    </div>
                    <div class="col-md-4">
                        <label for="cognome" class="form-label">Cognome</label>
                        <input type="text" class="form-control" id="cognome" required>
                    </div>
                    <div class="col-md-4">
                        <label for="ruolo" class="form-label">Ruolo</label>
                        <input type="text" class="form-control" id="ruolo" required>
                    </div>
                    <div class="col-md-4">
                        <label for="dataNascita" class="form-label">Data di Nascita</label>
                        <input type="date" class="form-control" id="dataNascita" required>
                    </div>
                    <div class="col-md-4">
                        <label for="scadenzaVisitaMedica" class="form-label">Scadenza Visita Medica</label>
                        <input type="date" class="form-control" id="scadenzaVisitaMedica" required>
                    </div>
                    <div class="col-md-4">
                        <label for="dataPrenotazioneVisita" class="form-label">Data Prenotazione Visita (Opzionale)</label>
                        <input type="date" class="form-control" id="dataPrenotazioneVisita">
                    </div>
                    <div class="col-md-4">
                        <label for="sesso" class="form-label">Sesso</label>
                        <select class="form-select" id="sesso" required>
                            <option value="">Seleziona...</option>
                            <option value="M">M</option>
                            <option value="F">F</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="nazionalita" class="form-label">Nazionalit√†</label>
                        <input type="text" class="form-control" id="nazionalita">
                    </div>
                    <div class="col-12">
                        <label for="performance" class="form-label">Performance (valori separati da virgola)</label>
                        <input type="text" class="form-control" id="performance" placeholder="es. 8,7,9,6">
                        <small class="form-text text-muted">Inserisci una serie di valori numerici per tracciare l'andamento della performance.</small>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3 me-2" id="save-player-btn">Aggiungi Atleta</button>
                <button type="button" class="btn btn-secondary mt-3" id="cancel-edit-btn" style="display: none;">Annulla Modifica</button>
            </form>

            
<h3 class="mt-5">Elenco Atleti</h3>
            <div id="team-overview" class="row">
                
</div>
        </div>

        
<div class="form-section">
            <h2 class="mb-3">Analisi Performance</h2>
            <div class="row">
                <div class="col-md-6">
                    <h3>Performance Atleta Selezionato</h3>
                    <select id="select-player-chart" class="form-select mb-3">
                        <option value="">Seleziona un atleta</option>
                    </select>
                    <div id="performance-chart-container">
                        <canvas id="performanceChartSingle"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <h3>Performance Media Squadra</h3>
                    <div id="performance-chart-container">
                        <canvas id="performanceChartTeam"></canvas>
                    </div>
                </div>
            </div>
        </div>

        
<div class="form-section">
            <h2 class="mb-3">Modulo Formazione</h2>
            <div class="row">
                <div class="col-md-4">
                    <h3>Giocatori Selezionabili</h3>
                    <div id="players-list" class="border p-3" style="min-height: 200px; max-height: 400px; overflow-y: auto;">
                        
</div>
                </div>
                <div class="col-md-8">
                    <h3>Campo da Gioco</h3>
                    <div id="field">
                        
</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let players = JSON.parse(localStorage.getItem('players')) || [];
        let selectedPlayersOnField = JSON.parse(localStorage.getItem('selectedPlayersOnField')) || {};
        let singlePlayerChart;
        let teamChart;

        function getMedicalStatus(scadenzaVisita, dataPrenotazione = null) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const scadenzaDate = new Date(scadenzaVisita);
            scadenzaDate.setHours(0, 0, 0, 0);

            const threeMonthsFromNow = new Date(today);
            threeMonthsFromNow.setMonth(today.getMonth() + 3);

            let status = 'Valida';
            let colorClass = 'status-green';
            let icon = '<i class="fas fa-circle"></i>';

            if (scadenzaDate < today) {
                status = 'Scaduta';
                colorClass = 'status-red';
            } else if (scadenzaDate <= threeMonthsFromNow) {
                status = 'In scadenza';
                colorClass = 'status-yellow';
            }

            if (dataPrenotazione) {
                const prenotazioneDate = new Date(dataPrenotazione);
                prenotazioneDate.setHours(0, 0, 0, 0);
                if (prenotazioneDate <= scadenzaDate) {
                    status = 'Prenotata';
                    colorClass = 'status-purple';
                } else {
                    status = 'Prenotata (Scaduta)';
                    colorClass = 'status-red';
                }
            }
            return { html: `<span class="deadline-status ${colorClass}" title="Visita Medica: ${status}">${icon}</span>`, isRed: colorClass === 'status-red' };
        }

        function displayPlayers() {
            const teamOverview = $('#team-overview');
            teamOverview.empty();
            const playersListForFormation = $('#players-list');
            playersListForFormation.empty();

            players.forEach(player => {
                const { html: medicalStatusHtml, isRed: isRedStatus } = getMedicalStatus(player.scadenzaVisitaMedica, player.dataPrenotazioneVisita);
                
                const playerCard = `
                    <div class="col-md-4">
                        <div class="player-card" data-id="${player.id}">
                            ${medicalStatusHtml}
                            <h5>${player.nome} ${player.cognome}</h5>
                            <p><strong>Ruolo:</strong> ${player.ruolo}</p>
                            <p><strong>Data Nascita:</strong> ${player.dataNascita}</p>
                            <p><strong>Scadenza Visita:</strong> ${player.scadenzaVisitaMedica}</p>
                            ${player.dataPrenotazioneVisita ? `<p><strong>Prenotazione Visita:</strong> ${player.dataPrenotazioneVisita}</p>` : ''}
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-info btn-sm edit-player-btn" data-id="${player.id}">Modifica</button>
                                <button type="button" class="btn btn-danger btn-sm delete-player-btn" data-id="${player.id}">Elimina</button>
                            </div>
                        </div>
                    </div>
                `;
                teamOverview.append(playerCard);

                if (!isRedStatus) {
                    const playerListItem = `
                        <div class="player-list-item draggable-player" data-id="${player.id}">
                            ${player.nome} ${player.cognome} <span class="badge bg-secondary">${player.ruolo}</span>
                        </div>
                    `;
                    playersListForFormation.append(playerListItem);
                }
            });

            makePlayersDraggable();
            updateFormationPlayers();
            updateSelectPlayerChart();
            checkAndDisplayExpirationAlerts();
        }

        function makePlayersDraggable() {
            $('.draggable-player').draggable({
                revert: "invalid",
                helper: "clone",
                appendTo: "body",
                cursor: "move",
                zIndex: 1000,
                start: function(event, ui) {
                    $(ui.helper).addClass('field-player').css({
                        'width': '50px',
                        'height': '50px',
                        'border-radius': '50%',
                        'background-color': '#007bff',
                        'color': 'white',
                        'display': 'flex',
                        'align-items': 'center',
                        'justify-content': 'center',
                        'font-size': '0.8rem'
                    }).text($(this).text().split(' ')[0][0] + $(this).text().split(' ')[1][0]);
                }
            });
        }

        function updateFormationPlayers() {
            $('#field').empty();
            for (const playerId in selectedPlayersOnField) {
                const player = players.find(p => p.id === playerId);
                if (player) {
                    const { isRed: isRedStatus } = getMedicalStatus(player.scadenzaVisitaMedica, player.dataPrenotazioneVisita);
                    if (isRedStatus) {
                        delete selectedPlayersOnField[playerId];
                        localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
                        displayPlayers();
                        return;
                    }

                    const pos = selectedPlayersOnField[playerId];
                    const playerFieldHtml = `
                        <div class="field-player" data-id="${player.id}" style="left: ${pos.left}px; top: ${pos.top}px;">
                            ${player.nome.charAt(0)}${player.cognome.charAt(0)}
                            <button class="remove-from-formation-btn" data-id="${player.id}" title="Rimuovi dalla formazione">&times;</button>
                        </div>
                    `;
                    $('#field').append(playerFieldHtml);
                } else {
                    delete selectedPlayersOnField[playerId];
                    localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
                }
            }

            $('.field-player').draggable({
                containment: "#field",
                stop: function(event, ui) {
                    const id = $(this).data('id');
                    selectedPlayersOnField[id] = { left: ui.position.left, top: ui.position.top };
                    localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
                }
            });
            attachRemoveButtonListener();
        }

        function attachRemoveButtonListener() {
            $('.remove-from-formation-btn').off('click').on('click', function(e) {
                e.stopPropagation();
                const playerIdToRemove = $(this).data('id');
                delete selectedPlayersOnField[playerIdToRemove];
                localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
                displayPlayers();
            });
        }

        $('#field').droppable({
            accept: ".draggable-player",
            drop: function(event, ui) {
                const playerId = ui.draggable.data('id');
                if (!selectedPlayersOnField[playerId]) {
                    const player = players.find(p => p.id === playerId);
                    if (player) {
                        const newPlayerField = $(`<div class="field-player" data-id="${player.id}">${player.nome.charAt(0)}${player.cognome.charAt(0)}<button class="remove-from-formation-btn" data-id="${player.id}" title="Rimuovi dalla formazione">&times;</button></div>`);
                        const fieldOffset = $(this).offset();
                        const initialLeft = ui.offset.left - fieldOffset.left;
                        const initialTop = ui.offset.top - fieldOffset.top;

                        newPlayerField.css({ left: initialLeft, top: initialTop });
                        $(this).append(newPlayerField);
                        selectedPlayersOnField[player.id] = { left: initialLeft, top: initialTop };
                        localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));

                        newPlayerField.draggable({
                            containment: "#field",
                            stop: function(event, ui) {
                                const id = $(this).data('id');
                                selectedPlayersOnField[id] = { left: ui.position.left, top: ui.position.top };
                                localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
                            }
                        });
                        attachRemoveButtonListener();
                    }
                }
            }
        });

        $('#player-form').on('submit', function(e) {
            e.preventDefault();
            const id = $('#player-id').val();
            const playerData = {
                nome: $('#nome').val(),
                cognome: $('#cognome').val(),
                ruolo: $('#ruolo').val(),
                dataNascita: $('#dataNascita').val(),
                scadenzaVisitaMedica: $('#scadenzaVisitaMedica').val(),
                dataPrenotazioneVisita: $('#dataPrenotazioneVisita').val(),
                sesso: $('#sesso').val(),
                nazionalita: $('#nazionalita').val(),
                performance: $('#performance').val() ? $('#performance').val().split(',').map(Number) : []
            };

            if (id) {
                const playerIndex = players.findIndex(p => p.id === id);
                if (playerIndex > -1) {
                    players[playerIndex] = { ...players[playerIndex], ...playerData };
                }
            } else {
                playerData.id = Date.now().toString();
                players.push(playerData);
            }
            localStorage.setItem('players', JSON.stringify(players));
            $('#player-form')[0].reset();
            $('#player-id').val('');
            $('#save-player-btn').text('Aggiungi Atleta');
            $('#cancel-edit-btn').hide();
            displayPlayers();
        });

        $('#team-overview').on('click', '.edit-player-btn', function() {
            const id = $(this).data('id');
            const player = players.find(p => p.id === id);
            if (player) {
                $('#player-id').val(player.id);
                $('#nome').val(player.nome);
                $('#cognome').val(player.cognome);
                $('#ruolo').val(player.ruolo);
                $('#dataNascita').val(player.dataNascita);
                $('#scadenzaVisitaMedica').val(player.scadenzaVisitaMedica);
                $('#dataPrenotazioneVisita').val(player.dataPrenotazioneVisita);
                $('#sesso').val(player.sesso);
                $('#nazionalita').val(player.nazionalita);
                $('#performance').val(player.performance.join(','));
                $('#save-player-btn').text('Salva Modifiche');
                $('#cancel-edit-btn').show();
            }
        });

        $('#team-overview').on('click', '.delete-player-btn', function() {
            const id = $(this).data('id');
            players = players.filter(p => p.id !== id);
            delete selectedPlayersOnField[id];
            localStorage.setItem('players', JSON.stringify(players));
            localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
            displayPlayers();
        });

        $('#cancel-edit-btn').on('click', function() {
            $('#player-form')[0].reset();
            $('#player-id').val('');
            $('#save-player-btn').text('Aggiungi Atleta');
            $(this).hide();
        });

        function updateSelectPlayerChart() {
            const select = $('#select-player-chart');
            select.empty().append('<option value="">Seleziona un atleta</option>');
            players.forEach(player => {
                select.append(`<option value="${player.id}">${player.nome} ${player.cognome}</option>`);
            });
        }

        $('#select-player-chart').on('change', function() {
            const playerId = $(this).val();
            if (playerId) {
                const player = players.find(p => p.id === playerId);
                if (player) {
                    renderSinglePlayerChart(player);
                }
            } else {
                if (singlePlayerChart) {
                    singlePlayerChart.destroy();
                }
            }
        });

        function renderSinglePlayerChart(player) {
            if (singlePlayerChart) {
                singlePlayerChart.destroy();
            }
            const ctx = document.getElementById('performanceChartSingle').getContext('2d');
            const labels = Array.from({ length: player.performance.length }, (_, i) => `Gara ${i + 1}`);
            const allPerformances = players.flatMap(p => p.performance);
            const teamAverage = allPerformances.length > 0 ? (allPerformances.reduce((a, b) => a + b, 0) / allPerformances.length) : 0;
            const maxPerformance = allPerformances.length > 0 ? Math.max(...allPerformances) : 0;

            singlePlayerChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Performance di ${player.nome}`,
                        data: player.performance,
                        borderColor: 'rgba(217, 4, 41, 1)',
                        backgroundColor: 'rgba(217, 4, 41, 0.2)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Media Squadra',
                        data: Array(labels.length).fill(teamAverage),
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3
                    },
                    {
                        label: 'Max Squadra',
                        data: Array(labels.length).fill(maxPerformance),
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function renderTeamChart() {
            if (teamChart) {
                teamChart.destroy();
            }
            const ctx = document.getElementById('performanceChartTeam').getContext('2d');
            const maxRaces = players.reduce((max, p) => Math.max(max, p.performance.length), 0);
            const labels = Array.from({ length: maxRaces }, (_, i) => `Gara ${i + 1}`);

            const teamPerformanceByRace = Array(maxRaces).fill(0).map((_, i) => {
                const values = players.map(p => p.performance[i]).filter(v => typeof v === 'number');
                return values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
            });

            teamChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Media Performance Squadra',
                        data: teamPerformanceByRace,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function checkAndDisplayExpirationAlerts() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const threeMonthsFromNow = new Date(today);
            threeMonthsFromNow.setMonth(today.getMonth() + 3);

            let expiringPlayers = [];
            players.forEach(player => {
                if (player.scadenzaVisitaMedica) {
                    const scadenzaDate = new Date(player.scadenzaVisitaMedica);
                    scadenzaDate.setHours(0, 0, 0, 0);

                    const dataPrenotazione = player.dataPrenotazioneVisita ? new Date(player.dataPrenotazioneVisita) : null;
                    if (dataPrenotazione) dataPrenotazione.setHours(0, 0, 0, 0);

                    const isExpiringSoon = (scadenzaDate <= threeMonthsFromNow);
                    const isBookedInTime = (dataPrenotazione && dataPrenotazione <= scadenzaDate);

                    if (isExpiringSoon && !isBookedInTime) {
                        expiringPlayers.push({
                            name: `${player.nome} ${player.cognome}`,
                            scadenza: scadenzaDate < today ? 'SCADUTA' : `scade il ${scadenzaDate.toLocaleDateString('it-IT')}`
                        });
                    }
                }
            });

            const alertsContainer = $('#expiration-alerts');
            alertsContainer.empty();
            if (expiringPlayers.length > 0) {
                let alertMessage = `
                    <div class="alert alert-warning alert-dismissible fade show mb-0" role="alert">
                        <strong>Attenzione!</strong> Visite mediche in scadenza (o scadute):
                        <ul>
                            ${expiringPlayers.map(p => `<li><strong>${p.name}</strong>: ${p.scadenza}</li>`).join('')}
                        </ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                alertsContainer.append(alertMessage).removeClass('d-none');
            } else {
                alertsContainer.addClass('d-none');
            }
        }

        $(document).ready(function() {
            displayPlayers();
            renderTeamChart();
        });
    </script>
</body>
</html>