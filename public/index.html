<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-blue: #0a2463; --secondary-blue: #1e5095; --primary-red: #d90429;
            --text-light: #ffffff; --card-bg: #1a3a7a; --border-color: #3b5a9d; --gold-star: #FFD700;
            --field-green: #008000; --field-line: #FFF; --gk-color: #E8C135; --custom-purple: #6f42c1;
            --bs-danger-rgb: 220, 53, 69; /* Per text-bg-danger */
            --bs-warning-rgb: 255, 193, 7; /* Per text-bg-warning */
        }
        html { scroll-behavior: smooth; }
        body { background-color: var(--primary-blue); color: var(--text-light); padding-top: 56px; }
        .bg-dark-blue { background-color: #051438 !important; border-bottom: 2px solid var(--primary-red); }
        .main-title { color: var(--text-light); border-left: 4px solid var(--primary-red); padding-left: 1rem; }
        .athlete-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .athlete-card-clickable { cursor: pointer; }
        .athlete-card-clickable:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(217, 4, 41, 0.2); border-color: var(--primary-red); }
        .athlete-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--border-color); object-fit: cover; background-color: var(--secondary-blue); }
        .athlete-card .card-title { font-size: 1.1rem; margin-bottom: 0.1rem; }
        .shirt-number { font-size: 1.5rem; font-weight: bold; color: var(--text-light); background-color: var(--primary-red); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; top: 50%; right: 15px; transform: translateY(-50%); }
        .is-captain { color: var(--gold-star); }
        .card-actions { position: absolute; bottom: 10px; right: 10px; z-index: 5; display: flex; gap: 5px; }
        .card-actions .btn { background: rgba(0,0,0,0.3); border: none; }
        .chart-card, .table-card, .summary-card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .modal-content { background-color: var(--primary-blue); border: 1px solid var(--primary-red); }
        .modal-header, .modal-footer { border-bottom: 1px solid var(--border-color); border-top: 1px solid var(--border-color); }
        .btn-primary-custom { background-color: var(--primary-red); border-color: var(--primary-red); color: white; }
        .btn-primary-custom:hover { background-color: #b80323; border-color: #b80323; }
        .form-control, .form-select { background-color: var(--secondary-blue); color: var(--text-light); border-color: var(--border-color); }
        .form-control::placeholder { color: #8a9fc1; }
        .form-control:focus, .form-select:focus { background-color: var(--secondary-blue); color: var(--text-light); border-color: var(--primary-red); box-shadow: 0 0 0 0.25rem rgba(217, 4, 41, 0.25); }
        .award-card { background: linear-gradient(45deg, var(--gold-star), #d4af37); color: #000; border: 2px solid #fff; width: 180px; }
        .award-avatar { width: 50px; height: 50px; }
        .text-muted { color: rgba(255, 255, 255, 0.75) !important; }
        .summary-card .card-body { min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;}
        .summary-card .display-4 { font-weight: 500; }
        .calendar-card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { background-color: var(--secondary-blue); border: 1px solid var(--border-color); min-height: 120px; padding: 8px; font-size: 0.9rem; }
        .calendar-day.today { border-color: var(--primary-red); }
        .calendar-day-header { font-weight: bold; }
        .calendar-session { background-color: var(--primary-red); color: white; padding: 4px; border-radius: 4px; font-size: 0.75rem; margin-top: 5px; cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .deadline-status { font-size: 1.2rem; position: absolute; top: 50%; right: 70px; transform: translateY(-50%); }
        .text-purple { color: var(--custom-purple) !important; }
        .available-player.disabled { opacity: 0.5; cursor: not-allowed; background-color: #343a40 !important; }
        .dragging { opacity: 0.5; z-index: 1056; pointer-events: none; }
        #pitch-wrapper { display: flex; align-items: flex-start; gap: 1rem; }
        #field-container { background-color: var(--field-green); border: 2px solid var(--field-line); position: relative; width: 100%; max-width: 450px; aspect-ratio: 5 / 7; box-sizing: border-box; flex-shrink: 0; }
        #field-bench-area { background-color: rgba(0,0,0,0.2); border: 2px dashed var(--border-color); border-radius: 8px; width: 150px; height: 630px; position: relative; flex-shrink: 0; }
        .field-line, .field-box, .field-circle, .field-spot { position: absolute; box-sizing: border-box; border-color: var(--field-line); }
        .halfway-line { border-top: 2px solid var(--field-line); width: 100%; top: 50%; }
        .center-circle { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 25%; aspect-ratio: 1/1; border: 2px solid var(--field-line); border-radius: 50%; }
        .center-spot { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2%; aspect-ratio: 1/1; background-color: var(--field-line); border-radius: 50%; }
        .penalty-box-top { top: 0; left: 50%; transform: translateX(-50%); width: 60%; height: 16.5%; border: 2px solid var(--field-line); border-top: none; }
        .penalty-box-bottom { bottom: 0; left: 50%; transform: translateX(-50%); width: 60%; height: 16.5%; border: 2px solid var(--field-line); border-bottom: none; }
        .goal-box-top { top: 0; left: 50%; transform: translateX(-50%); width: 30%; height: 6%; border: 2px solid var(--field-line); border-top: none; }
        .goal-box-bottom { bottom: 0; left: 50%; transform: translateX(-50%); width: 30%; height: 6%; border: 2px solid var(--field-line); border-bottom: none; }
        .penalty-spot-top { top: 11.5%; left: 50%; transform: translateX(-50%); width: 1.5%; aspect-ratio: 1/1; background-color: var(--field-line); border-radius: 50%; }
        .penalty-spot-bottom { bottom: 11.5%; left: 50%; transform: translateX(-50%); width: 1.5%; aspect-ratio: 1/1; background-color: var(--field-line); border-radius: 50%; }
        .player-jersey { position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 15%; cursor: grab; user-select: none; font-size: clamp(4.5px, 0.6vw, 8px); transform: translate(-50%, -50%); }
        .jersey-body { position: relative; width: 5em; height: 5em; background-color: var(--secondary-blue); border-radius: 0.8em 0.8em 0.5em 0.5em; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 -4px 8px rgba(0,0,0,0.3); }
        .jersey-body::before, .jersey-body::after { content: ''; position: absolute; width: 2.5em; height: 1em; background-color: inherit; top: 0; }
        .jersey-body::before { left: -1.8em; transform: rotate(-40deg); border-radius: 0.5em 0.2em 0 0; }
        .jersey-body::after { right: -1.8em; transform: rotate(40deg); border-radius: 0.2em 0.5em 0 0; }
        .jersey-number { font-size: 2.2em; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; }
        .player-name { margin-top: 0.5em; font-size: 1.33em; font-weight: bold; color: white; background-color: rgba(0,0,0,0.6); padding: 0.1em 0.4em; border-radius: 4px; white-space: nowrap; }
        #available-list .list-group-item, .tool-item { cursor: grab; background-color: var(--secondary-blue); }
        .available-slot { border: 1px dashed var(--border-color); border-radius: 8px; min-height: 50px; }
        #formation-tools { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1rem; }
        .tool-item { border: 1px solid var(--border-color); border-radius: 8px; padding: 5px 10px; text-align: center; }
        .tool-item.opponent-tool { background-color: var(--primary-red); font-size: 1.5rem; line-height: 1; padding: 5px 12px; }
        .tool-item.ball-tool { font-size: 1.5rem; line-height: 1; padding: 5px 10px; }
        .token { position: absolute; cursor: grab; user-select: none; z-index: 10; text-align: center; transform: translate(-50%, -50%); }
        .token-captain { font-weight: bold; color: white; background: black; padding: 0.2em 0.5em; border-radius: 4px; font-size: clamp(8px, 1vw, 12px); }
        .token-ball { font-size: 2rem; }
        .token-opponent { width: 2.5em; height: 2.5em; background-color: var(--primary-red); border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.5); font-size: clamp(8px, 1vw, 12px); }
        .match-result-item { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .match-score { font-weight: bold; font-size: 1.1rem; }
        .yellow-card { width: 10px; height: 14px; background-color: #ffc107; display: inline-block; border-radius: 2px; }
        .red-card { width: 10px; height: 14px; background-color: #dc3545; display: inline-block; border-radius: 2px; }
        .scorers-list { font-size: 0.8rem; color: var(--text-muted); }
        #cards-summary-table, #attendance-percentage-table { --bs-table-bg: var(--secondary-blue); --bs-table-striped-bg: var(--secondary-blue); --bs-table-hover-bg: var(--border-color); border-color: var(--border-color); }
        .season-stats-card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .season-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; text-align: center;}
        .stat-item h6 { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.2rem;}
        .stat-item p { font-size: 1.4rem; font-weight: 500; margin-bottom: 0;}
        .stat-item .diff-pos { color: #28a745; }
        .stat-item .diff-neg { color: var(--primary-red); }
        #medical-deadlines-list .list-group-item { background-color: transparent; border-color: var(--border-color); padding: 0.5rem 1rem;}
        #athleteDashboardModal .list-group-item { background-color: var(--secondary-blue); border-color: var(--border-color); font-size: 0.9rem;}
        #athleteDashboardModal .badge { font-size: 0.9rem;}
        @media print {
            body { padding-top: 0; }
            .no-print { display: none !important; }
            body * { visibility: hidden; }
            .printing-now, .printing-now * { visibility: visible; }
            .printing-now { position: absolute; left: 0; top: 0; width: 100%; }
            .printing-now #athlete-grid { display: flex !important; flex-wrap: wrap !important; }
            .printing-now #athlete-grid > [class*="col-"] { flex: 0 0 25% !important; max-width: 25% !important; padding: 5px !important; page-break-inside: avoid; }
            .printing-now .athlete-card { box-shadow: none !important; }
            .printing-now .card, .printing-now .list-group-item, .printing-now .calendar-day, .printing-now .table { background-color: #fff !important; border: 1px solid #ccc !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now table, .printing-now th, .printing-now td { background-color: #fff !important; color: #000 !important; border-color: #000 !important; }
            .printing-now .calendar-session, .printing-now .shirt-number { background-color: #cccccc !important; color: #000 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now *, .printing-now .main-title, .printing-now .text-muted, .printing-now .card-title, .printing-now p, .printing-now h1, .printing-now h2, .printing-now h3, .printing-now h4, .printing-now h5, .printing-now h6 { color: #000 !important; }
            .printing-now .player-name, .printing-now .jersey-number, .printing-now .token-captain { color: #fff !important; }
            .printing-now .main-title { border-left-color: #000 !important; }
            .printing-now canvas { max-width: 100% !important; height: auto !important; }
            .printing-now #field-container { background-color: var(--field-green) !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now #field-container .field-line, .printing-now #field-container .field-box, .printing-now #field-container .field-circle { border-color: var(--field-line) !important; }
            .printing-now #field-container .field-spot { background-color: var(--field-line) !important; }
            .printing-now .jersey-body, .printing-now .player-name, .printing-now .token-opponent, .printing-now .token-captain, .printing-now .yellow-card, .printing-now .red-card { -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now .player-jersey[data-role*="Portiere"] .jersey-body { background-color: var(--gk-color) !important; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark-blue fixed-top no-print">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#"><i class="bi bi-person-workspace"></i> Coach Dashboard</a>
            <button class="btn btn-outline-secondary ms-auto" id="logout-btn" title="Blocca Dashboard (Logout)" style="display: none;"><i class="bi bi-unlock-fill"></i></button>
        </div>
    </nav>
    <main class="container-fluid mt-5 pt-3">

        <div id="alerts-container"></div>

        <div id="home-section" class="printable-area">
            <div class="row my-4">
                <div class="col-12 d-flex align-items-center gap-2">
                    <h2 class="main-title mb-0">Home Riepilogo</h2>
                    <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card summary-card h-100">
                        <div class="card-body"> <h5 class="card-title text-muted">ATLETI IN ROSA</h5> <p class="display-4" id="home-total-athletes">0</p> </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card summary-card h-100">
                        <div class="card-body" id="home-next-session"> <h5 class="card-title text-muted">PROSSIMA SESSIONE</h5> <p class="text-muted">Nessuna sessione pianificata</p> </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card summary-card h-100">
                        <div class="card-body" id="home-top-performer"> <h5 class="card-title text-muted">TOP PERFORMER MENSILE</h5> <p class="text-muted">Nessuna valutazione</p> </div>
                    </div>
                </div>
                 <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card summary-card h-100">
                        <div class="card-body" id="home-quick-actions"> <h5 class="card-title text-muted">AZIONI RAPIDE</h5> <div class="d-grid gap-2 w-100 no-print"> <button class="btn btn-primary-custom" id="quick-add-athlete-btn"><i class="bi bi-person-plus-fill"></i> Aggiungi Atleta</button> <button class="btn btn-secondary" id="quick-plan-session-btn"><i class="bi bi-calendar-plus"></i> Pianifica Sessione</button> </div> </div>
                    </div>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card season-stats-card">
                        <div class="card-body">
                            <h5 class="card-title text-muted mb-3 text-center">üìà Statistiche Stagionali üìâ</h5>
                            <div class="season-stats-grid" id="season-stats-container">
                                <div class="stat-item"><h6>Partite Giocate</h6><p id="stat-pg">0</p></div>
                                <div class="stat-item"><h6>V-P-S</h6><p id="stat-vps">0-0-0</p></div>
                                <div class="stat-item"><h6>Gol Fatti</h6><p id="stat-gf">0</p></div>
                                <div class="stat-item"><h6>Gol Subiti</h6><p id="stat-gs">0</p></div>
                                <div class="stat-item"><h6>Diff. Reti</h6><p id="stat-dr">0</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card summary-card">
                         <div class="card-body p-3">
                             <h5 class="card-title text-muted text-center"><i class="bi bi-calendar-x"></i> Promemoria Scadenze Mediche</h5>
                             <div id="medical-deadlines-list" class="list-group list-group-flush text-start" style="max-height: 150px; overflow-y: auto;">
                                 <p class="text-muted text-center mt-2">Nessuna scadenza imminente.</p>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
        </div> <div class="row my-4 no-print">
            <div class="col-12">
                <div class="card summary-card">
                    <div class="card-body">
                        <h5 class="card-title text-muted mb-3">NAVIGAZIONE RAPIDA</h5>
                        <div class="d-flex flex-wrap justify-content-center gap-2">
                            <a href="#formazione-section" class="btn btn-secondary"><i class="bi bi-grid-3x3-gap-fill"></i> Modulo Formazione</a>
                            <a href="#calendario-section" class="btn btn-secondary"><i class="bi bi-calendar3"></i> Calendario</a>
                            <a href="#squadra-section" class="btn btn-secondary"><i class="bi bi-people-fill"></i> Gestione Squadra</a>
                            <a href="#match-results-section" class="btn btn-secondary"><i class="bi bi-trophy-fill"></i> Risultati Partite</a>
                            <a href="#report-valutazioni-section" class="btn btn-secondary"><i class="bi bi-card-checklist"></i> Report Valutazioni</a>
                            <a href="#report-presenze-section" class="btn btn-secondary"><i class="bi bi-person-check-fill"></i> Report Presenze</a>
                            <a href="#hall-of-fame-section" class="btn btn-secondary"><i class="bi bi-award-fill"></i> Hall of Fame</a>
                            <a href="#monitoraggio-gps-section" class="btn btn-secondary"><i class="bi bi-graph-up-arrow"></i> Monitoraggio GPS</a>
                            <a href="#analisi-singolo-section" class="btn btn-secondary"><i class="bi bi-person-lines-fill"></i> Analisi Atleta</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="my-5 no-print">

        <div id="formazione-section" class="printable-area">
             <div class="row my-4 align-items-center"> <div class="col-12 d-flex align-items-center gap-2"> <h2 class="main-title mb-0">Modulo Formazione</h2> <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button> <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a> </div> </div> <div class="row"> <div class="col-lg-9 mb-4"> <div id="pitch-wrapper"> <div id="field-container" class="drop-zone"> <div class="field-line halfway-line"></div> <div class="field-circle center-circle"></div> <div class="field-spot center-spot"></div> <div class="field-box penalty-box-top"></div> <div class="field-box goal-box-top"></div> <div class="field-spot penalty-spot-top"></div> <div class="field-box penalty-box-bottom"></div> <div class="field-box goal-box-bottom"></div> <div class="field-spot penalty-spot-bottom"></div> </div> <div id="field-bench-area" class="drop-zone"></div> </div> </div> <div class="col-lg-3"> <div class="card" style="background-color: var(--card-bg);"> <div class="card-header fw-bold">Strumenti</div> <div class="card-body"> <div id="formation-tools"> <div class="tool-item" data-item-type="captain-c">(C)</div> <div class="tool-item" data-item-type="captain-vc">(VC)</div> <div class="tool-item ball-tool" data-item-type="ball">‚öΩ</div> <div class="tool-item opponent-tool" data-item-type="opponent" title="Trascina per duplicare">‚óè</div> </div> </div> <div class="card-header fw-bold mt-3">Atleti Disponibili</div> <div class="card-body available-slot p-2 drop-zone" id="available-list" style="max-height: 400px; overflow-y: auto;"></div> </div> </div> </div>
        </div>

        <hr class="my-5 no-print">

        <div id="calendario-section" class="printable-area">
              <div class="row my-4 align-items-center"> <div class="col-md-8 d-flex align-items-center gap-2"> <h2 class="main-title mb-0">Calendario Attivit√† Sportiva</h2> <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button> <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a> </div> <div class="col-md-4 d-flex justify-content-md-end no-print"> <button class="btn btn-primary-custom" id="add-session-btn"><i class="bi bi-calendar-plus"></i> Pianifica Sessione</button> </div> </div> <div class="row"> <div class="col-12 mt-3"> <div class="card calendar-card"> <div class="card-body"> <div class="calendar-header mb-3"> <button id="prev-month-btn" class="btn btn-outline-secondary no-print"><i class="bi bi-chevron-left"></i></button> <h4 id="current-month-year"></h4> <button id="next-month-btn" class="btn btn-outline-secondary no-print"><i class="bi bi-chevron-right"></i></button> </div> <div class="calendar-grid-header calendar-grid mb-1" style="font-weight: bold; text-align: center;"> <div>Luned√¨</div><div>Marted√¨</div><div>Mercoled√¨</div><div>Gioved√¨</div><div>Venerd√¨</div><div>Sabato</div><div>Domenica</div> </div> <div class="calendar-grid" id="calendar-grid"></div> </div> </div> </div> </div>
        </div>

        <hr class="my-5 no-print">

        <div id="squadra-section" class="printable-area">
             <div class="row align-items-center my-4"> <div class="col-md-4 d-flex align-items-center gap-2"> <h2 class="main-title mb-0">Gestione Squadra</h2> <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button> <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a> </div> <div class="col-md-8 d-flex justify-content-md-end align-items-center flex-wrap gap-2 no-print"> <button class="btn btn-secondary" id="export-all-data-btn"><i class="bi bi-download"></i> Esporta Dati</button> <label for="import-file-input" class="btn btn-secondary mb-0"><i class="bi bi-upload"></i> Importa Dati</label> <input type="file" id="import-file-input" accept=".json" style="display: none;"> <button class="btn btn-primary-custom" id="add-athlete-btn"><i class="bi bi-person-plus-fill"></i> Aggiungi Atleta</button> <div class="d-flex align-items-center gap-2"> <label for="evaluation-date-picker" class="form-label mb-0 text-nowrap">Data Valutazioni:</label> <input type="date" id="evaluation-date-picker" class="form-control" style="max-width: 180px;"> <button class="btn btn-outline-danger" id="delete-day-data-btn" title="Elimina tutti i dati del giorno selezionato"><i class="bi bi-calendar-x-fill"></i></button> </div> </div> </div> <div class="row" id="athlete-grid"></div>
        </div>

        <hr class="my-5 no-print">

        <div id="match-results-section" class="printable-area">
             <div class="row my-4 align-items-center"> <div class="col-md-8 d-flex align-items-center gap-2"> <h2 class="main-title mb-0">Risultati Partite</h2> <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button> <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a> </div> <div class="col-md-4 d-flex justify-content-md-end no-print"> <button class="btn btn-primary-custom" id="add-match-btn"><i class="bi bi-plus-circle-fill"></i> Aggiungi Partita</button> </div> </div> <div class="row" id="match-results-container"> <p class="text-muted">Nessun risultato inserito.</p> </div> <div class="row mt-5"> <div class="col-lg-7 mb-4"> <div class="card chart-card"> <div class="card-body"> <h5 class="card-title">Andamento Risultati</h5> <div class="d-flex gap-2 mb-3 no-print"> <select id="match-opponent-filter" class="form-select form-select-sm" style="width: 200px;"> <option value="all">Tutti gli avversari</option> </select> <div class="btn-group btn-group-sm" id="match-period-toggle"> <button type="button" class="btn btn-outline-secondary active" data-period="monthly">Mensile</button> <button type="button" class="btn btn-outline-secondary" data-period="bimonthly">Bimestrale</button> <button type="button" class="btn btn-outline-secondary" data-period="trimester">Trimestre</button> <button type="button" class="btn btn-outline-secondary" data-period="semester">Semestre</button> <button type="button" class="btn btn-outline-secondary" data-period="annual">Annuale</button> </div> </div> <canvas id="matchResultsChart"></canvas> </div> </div> </div> <div class="col-lg-5 mb-4"> <div class="card table-card mb-4"> <div class="card-body"> <h5 class="card-title">Classifica Marcatori</h5> <div id="top-scorers-container" style="max-height: 200px; overflow-y: auto;"></div> </div> </div> <div class="card table-card"> <div class="card-body"> <h5 class="card-title">Riepilogo Cartellini</h5> <div class="table-responsive mt-2" style="max-height: 200px;"> <table class="table table-dark table-striped table-hover table-sm" id="cards-summary-table"> <thead><tr><th>Atleta</th><th><span class="yellow-card"></span></th><th><span class="red-card"></span></th><th>Data</th><th class="no-print"></th></tr></thead> <tbody id="cards-summary-tbody"></tbody> </table> </div> </div> </div> </div> </div>
        </div>

        <hr class="my-5 no-print">

        <div id="report-valutazioni-section" class="row my-4 printable-area">
              <div class="col-12 d-flex justify-content-between align-items-center gap-2 mb-3"> <div class="d-flex align-items-center gap-2"> <h2 class="main-title mb-0">Report Valutazioni Comportamentali</h2> <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button> <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a> </div> <div class="d-flex align-items-center gap-2 no-print"> <label for="evaluation-date-picker-2" class="form-label mb-0 text-nowrap">Data Report:</label> <input type="date" id="evaluation-date-picker-2" class="form-control" style="max-width: 180px;"> </div> </div> <div class="col-lg-6 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Andamento Medio Squadra (Ultimi 7 Giorni)</h5><canvas id="dailyTeamChart"></canvas></div></div></div> <div class="col-lg-6 mb-4"><div class="card chart-card"><div class="card-body" id="comparison-chart-container"><h5 class="card-title mb-0">Confronto Valutazioni Atleti</h5><div class="btn-group btn-group-sm float-end no-print" id="comparison-period-toggle"><button type="button" class="btn btn-outline-secondary active" data-period="daily">Giornaliero</button><button type="button" class="btn btn-outline-secondary" data-period="weekly">Settimanale</button><button type="button" class="btn btn-outline-secondary" data-period="monthly">Mensile</button></div><canvas id="monthlyComparisonChart"></canvas></div></div></div>
        </div>

        <div id="report-presenze-section" class="row my-4 printable-area">
              <div class="col-12 d-flex align-items-center gap-2 mb-3"> <h2 class="main-title mb-0">Report Presenze Allenamenti</h2> <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button> <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a> </div> <div class="col-12 mb-4"> <div class="card chart-card"> <div class="card-body"> <div class="d-flex justify-content-between align-items-center"> <h5 class="card-title mb-0">Conteggio Presenze Atleti</h5> <div class="btn-group btn-group-sm no-print" id="attendance-period-toggle"> <button type="button" class="btn btn-outline-secondary active" data-period="daily">Giornaliero</button> <button type="button" class="btn btn-outline-secondary" data-period="weekly">Settimanale</button> <button type="button" class="btn btn-outline-secondary" data-period="monthly">Mensile</button> </div> </div> <canvas id="attendanceChart"></canvas> </div> </div> </div>
             <div class="col-12 mb-4">
                 <div class="card table-card">
                     <div class="card-body">
                         <h5 class="card-title">Percentuale Presenze (Ultimi 30 Giorni)</h5>
                         <div class="table-responsive" style="max-height: 300px;">
                             <table class="table table-dark table-striped table-hover table-sm" id="attendance-percentage-table">
                                 <thead><tr><th>Atleta</th><th>% Presenze</th></tr></thead>
                                 <tbody id="attendance-percentage-tbody">
                                     <tr><td colspan="2" class="text-center text-muted">Nessun dato di presenza negli ultimi 30 giorni.</td></tr>
                                 </tbody>
                             </table>
                         </div>
                     </div>
                 </div>
             </div>
        </div>

        <hr class="my-5 no-print">

        <div id="hall-of-fame-section" class="row my-4 printable-area">
             <div class="col-12 d-flex align-items-center gap-2 mb-3"> <h2 class="main-title mb-0">Hall of Fame - Atleti Premiati della Stagione</h2> <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button> <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a> </div> <div id="hall-of-fame-container" class="d-flex flex-wrap gap-3 justify-content-center"></div>
        </div>

        <hr class="my-5 no-print">

         <div id="confronto-squadra-section" class="printable-area">
             <div class="row my-4" id="multi-athlete-chart-container"> <div class="col-12 d-flex align-items-center gap-2 mb-3"> <h2 class="main-title mb-0">Confronto Performance Squadra</h2> <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button> <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a> <button class="btn btn-sm btn-outline-warning ms-1 no-print unlock-btn" title="Sblocca Dati Individuali" style="display: none;"><i class="bi bi-key-fill"></i></button> </div> <div class="col-12 mb-4"> <div class="card chart-card"> <div class="card-body"> <div class="row g-3 align-items-center mb-3 no-print"> <div class="col-md-4"> <label for="multi-athlete-metric-selector" class="form-label">Parametro</label> <select id="multi-athlete-metric-selector" class="form-select"></select> </div> <div class="col-md-8"> <label class="form-label">Tipo Sessione</label> <div class="btn-group w-100" id="multi-athlete-type-selector"> <button type="button" class="btn btn-outline-secondary active" data-type="all">Tutti</button> <button type="button" class="btn btn-outline-secondary" data-type="Allenamento">Allenamento</button> <button type="button" class="btn btn-outline-secondary" data-type="Partita">Partita</button> <button type="button" class="btn btn-outline-secondary" data-type="Individual">Individual</button> </div> </div> </div> <div class="row g-3 align-items-end no-print"> <div class="col-md-8"> <label class="form-label">Filtro Temporale (mostra valore massimo nel periodo)</label> <div class="btn-group w-100" role="group"> <button type="button" class="btn btn-outline-secondary" data-period="day">Giorno</button> <button type="button" class="btn btn-outline-secondary active" data-period="month">Mese</button> <button type="button" class="btn btn-outline-secondary" data-period="bimonth">Bimestre</button> <button type="button" class="btn btn-outline-secondary" data-period="trimester">Trimestre</button> <button type="button" class="btn btn-outline-secondary" data-period="semester">Semestre</button> </div> </div> <div class="col-md-3" id="multi-athlete-datepicker-container" style="display: none;"> <label for="multi-athlete-datepicker" class="form-label">Seleziona Data</label> <input type="date" id="multi-athlete-datepicker" class="form-control"> </div> <div class="col-md-1"> <label class="form-label">&nbsp;</label> <button class="btn btn-secondary w-100" id="multi-athlete-reset-btn" title="Reset Filtri"><i class="bi bi-arrow-clockwise"></i></button> </div> </div> <canvas id="multiAthleteChart" class="mt-4"></canvas> </div> </div> </div> </div>
        </div>

        <hr class="my-5 no-print">

        <div id="monitoraggio-gps-section" class="row my-4 printable-area">
             <div class="col-12 d-flex align-items-center gap-2 mb-3"> <h2 class="main-title mb-0">Monitoraggio Performance (GPS)</h2> <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button> <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a> <button class="btn btn-sm btn-outline-warning ms-1 no-print unlock-btn" title="Sblocca Dati Individuali" style="display: none;"><i class="bi bi-key-fill"></i></button> </div> <div class="card chart-card p-3 mb-4 no-print"> <div class="d-flex justify-content-between align-items-center mb-3"> <label class="form-label mb-0">Filtra sessioni per tipo:</label> <div class="btn-group btn-group-sm" id="performance-filter-toggle"> <button type="button" class="btn btn-outline-secondary active" data-type="all">Tutti</button> <button type="button" class="btn btn-outline-secondary" data-type="Allenamento">Allenamento</button> <button type="button" class="btn btn-outline-secondary" data-type="Partita">Partita</button> <button type="button" class="btn btn-outline-secondary" data-type="Individual">Individual</button> </div> </div> <div class="row align-items-end"> <div class="col-md-8"> <label class="form-label">Seleziona le sessioni da confrontare:</label> <div id="performance-selectors-container" class="d-grid gap-2"></div> </div> <div class="col-md-4 d-flex align-items-end gap-2 mt-2 mt-md-0"> <div> <label for="performance-metric-selector" class="form-label">Metrica:</label> <select id="performance-metric-selector" class="form-select"></select> </div> <button class="btn btn-primary-custom flex-grow-1" id="add-comparison-btn"><i class="bi bi-plus-lg"></i> Aggiungi</button> </div> </div> </div> <div class="col-lg-7 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Grafico Confronto Performance</h5><canvas id="performanceChart"></canvas></div></div></div> <div class="col-lg-5 mb-4"><div class="card table-card"><div class="card-body"><h5 class="card-title">Tabella Dati a Confronto</h5><div class="table-responsive" id="performance-table-container"></div><div id="export-buttons-container" class="mt-3 d-flex gap-2 no-print"></div></div></div></div>
        </div>

        <hr class="my-5 no-print">

        <div id="analisi-singolo-section" class="row my-4 printable-area">
             <div class="col-12 d-flex align-items-center gap-2 mb-3"> <h2 class="main-title mb-0">Analisi Atleta Singolo</h2> <button class="btn btn-sm btn-outline-secondary ms-2 no-print print-section-btn" title="Stampa Sezione"><i class="bi bi-printer-fill"></i></button> <a href="#home-section" class="btn btn-sm btn-outline-secondary ms-1 no-print" title="Torna in Cima"><i class="bi bi-arrow-up-circle-fill"></i></a> <button class="btn btn-sm btn-outline-warning ms-1 no-print unlock-btn" title="Sblocca Dati Individuali" style="display: none;"><i class="bi bi-key-fill"></i></button> </div> <div class="card chart-card p-3 mb-4 no-print"> <div class="row"> <div class="col-md-6"> <label for="trend-athlete-selector" class="form-label">Atleta per Andamento nel Tempo:</label> <select id="trend-athlete-selector" class="form-select"></select> <label for="trend-metric-selector" class="form-label mt-2">Metrica per Andamento:</label> <select id="trend-metric-selector" class="form-select"></select> </div> <div class="col-md-6"> <label for="radar-athlete-selector-1" class="form-label">Atleta 1 (Radar):</label> <select id="radar-athlete-selector-1" class="form-select"></select> <label for="radar-athlete-selector-2" class="form-label mt-2">Atleta 2 (Confronto Radar):</label> <select id="radar-athlete-selector-2" class="form-select"></select> </div> </div> </div> <div class="col-lg-8 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Andamento Performance nel Tempo</h5><canvas id="athleteTrendChart"></canvas></div></div></div> <div class="col-lg-4 mb-4"><div class="card chart-card"><div class="card-body"><h5 class="card-title">Profilo Atleta (vs. Top di Squadra)</h5><canvas id="athleteRadarChart"></canvas></div></div></div>
        </div>
    </main>

    <footer class="bg-dark-blue py-3 mt-5 no-print">
        <div class="container text-center"> <p class="text-muted mb-0">By Edy Franzoso</p> </div>
    </footer>

    <div id="modals-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const modalsContainer = document.getElementById('modals-container');
        // Aggiungo il nuovo modal per Athlete Dashboard
        modalsContainer.innerHTML = `<div class="modal fade" id="evaluationModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Valutazione di <span id="modal-athlete-name-eval"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="evaluation-form"><input type="hidden" id="modal-athlete-id-eval"><p>Data: <strong id="modal-evaluation-date"></strong></p><div class="mb-2"><label class="form-label">Presenza Allenamento</label><select id="presenza-allenamento" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Seriet√† Allenamento</label><select id="serieta-allenamento" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Abbigliamento Allenamento</label><select id="abbigliamento-allenamento" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Abbigliamento Partita</label><select id="abbigliamento-partita" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Seriet√† Comunicazioni</label><select id="comunicazioni" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="mb-2"><label class="form-label">Doccia (Opzionale)</label><select id="doccia" class="form-select"><option value="0">0-NV</option><option value="1">1-B</option><option value="2">2-M</option><option value="3">3-A</option></select></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="award-checkbox"><label class="form-check-label" for="award-checkbox">Assegna Premio</label></div></form></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-outline-danger" id="delete-single-athlete-day-btn">Elimina Dati del Giorno</button><div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button><button type="submit" class="btn btn-primary-custom" form="evaluation-form">Salva Valutazione</button></div></div></div></div></div>
            <div class="modal fade" id="athleteModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="athleteModalLabel">Gestisci Atleta</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="athlete-form"><input type="hidden" id="modal-athlete-id"><div class="mb-3"><label class="form-label">Nome Cognome</label><input type="text" class="form-control" id="athlete-name" required></div><div class="mb-3"><label for="athlete-avatar-input" class="form-label">Foto Profilo</label><input type="file" class="form-control" id="athlete-avatar-input" accept="image/*"><input type="hidden" id="athlete-avatar-base64"><img id="avatar-preview" src="" alt="Anteprima" class="mt-2" style="max-width: 70px; max-height: 70px; display: none; border-radius: 50%;"></div><div class="mb-3"><label class="form-label">Ruolo</label><input type="text" class="form-control" id="athlete-role" required></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Numero Maglia</label><input type="number" class="form-control" id="athlete-number" required min="1"></div><div class="col-md-6 mb-3"><label class="form-label">Scadenza Visita Medica</label><input type="date" class="form-control" id="scadenza-visita"></div></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Data Prenotazione Visita</label><input type="date" class="form-control" id="prenotazione-visita"></div></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="athlete-captain"><label class="form-check-label" for="athlete-captain">Capitano</label></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="submit" class="btn btn-primary-custom" form="athlete-form">Salva Atleta</button></div></div></div></div>
            <div class="modal fade" id="gpsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="gpsModalLabel">Dati Performance di <span id="modal-athlete-name-gps"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="gps-form"><input type="hidden" id="modal-athlete-id-gps"><input type="hidden" id="gps-session-id"> <div class="row mb-3"><div class="col-md-8"><label for="gps-session-selector" class="form-label">Seleziona Sessione Esistente per Modificare</label><select id="gps-session-selector" class="form-select"><option value="">--- Inserisci Nuova Sessione ---</option></select></div><div class="col-md-4 d-flex align-items-end"><button type="button" id="delete-gps-session-btn" class="btn btn-outline-danger w-100" disabled>Elimina Sessione</button></div></div><hr> <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Data Registrazione</label><input type="date" class="form-control" id="gps-data_di_registrazione" required></div><div class="col-md-4 mb-3"><label class="form-label">Ora Registrazione</label><input type="time" class="form-control" id="gps-ora_registrazione"></div><div class="col-md-4 mb-3"><label class="form-label">Tipo Sessione</label><select class="form-select" id="gps-tipo_sessione"><option value="Allenamento">Allenamento</option><option value="Partita">Partita</option><option value="Individual">Individual</option></select></div></div> <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Distanza Totale (m)</label><input type="number" step="0.1" class="form-control" id="gps-distanza_totale" placeholder="es. 10500"></div><div class="col-md-4 mb-3"><label class="form-label">Tempo Totale (min)</label><input type="number" step="0.1" class="form-control" id="gps-tempo_totale" placeholder="es. 92"></div><div class="col-md-4 mb-3"><label class="form-label">Distanza per Minuto (m/min)</label><input type="number" step="0.1" class="form-control" id="gps-distanza_per_minuto" readonly></div></div> <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Distanza Sprint (m)</label><input type="number" step="0.1" class="form-control" id="gps-distanza_sprint"></div><div class="col-md-4 mb-3"><label class="form-label">Velocit√† Massima (km/h)</label><input type="number" step="0.1" class="form-control" id="gps-velocita_massima"></div><div class="col-md-4 mb-3"><label class="form-label">Numero di Sprint</label><input type="number" class="form-control" id="gps-numero_di_sprint"></div></div> <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Max Acc (g)o(n¬∞)</label><input type="number" step="0.1" class="form-control" id="gps-max_acc"></div><div class="col-md-4 mb-3"><label class="form-label">Max Dec (g)o(n¬∞)</label><input type="number" step="0.1" class="form-control" id="gps-max_dec"></div><div class="col-md-4 mb-3"><label class="form-label">Passaggi Piede Sinistro</label><input type="number" class="form-control" id="gps-passaggi_piede_sinistro"></div></div> <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Passaggi Piede Destro</label><input type="number" class="form-control" id="gps-passaggi_piede_destro"></div><div class="col-md-4 mb-3"><label class="form-label">Cross Piede Sinistro</label><input type="number" step="0.1" class="form-control" id="gps-cross_piede_sinistro"></div><div class="col-md-4 mb-3"><label class="form-label">Cross Piede Destro</label><input type="number" step="0.1" class="form-control" id="gps-cross_piede_destro"></div></div> <div class="row"><div class="col-md-4 mb-3"><label class="form-label">Potenza Massima di Tiro (km/h)</label><input type="number" step="0.1" class="form-control" id="gps-potenza_massima_di_tiro"></div><div class="col-md-4 mb-3"><label class="form-label">Tiri Piede SX</label><input type="number" class="form-control" id="gps-tiri_piede_sx"></div><div class="col-md-4 mb-3"><label class="form-label">Tiri Piede DX</label><input type="number" class="form-control" id="gps-tiri_piede_dx"></div></div> <div class="row"><div class="col-md-4 mb-3"><label class="form-label">% Passaggi Brevi</label><input type="number" step="0.1" class="form-control" id="gps-perc_passaggi_brevi"></div><div class="col-md-4 mb-3"><label class="form-label">% Lanci</label><input type="number" step="0.1" class="form-control" id="gps-perc_lanci"></div><div class="col-md-4 mb-3"><label class="form-label">Distanza Circuito (m)</label><input type="number" step="1" class="form-control" id="gps-distanza_circuito" placeholder="es. 400"></div></div> <div class="row align-items-end"><div class="col-md-5 mb-3"><label class="form-label">Tempo Circuito</label><div class="input-group"><input type="number" class="form-control" id="gps-tempo_circuito_min" placeholder="Min" min="0"><span class="input-group-text">:</span><input type="number" class="form-control" id="gps-tempo_circuito_sec" placeholder="Sec" min="0" max="59"><span class="input-group-text">.</span><input type="number" class="form-control" id="gps-tempo_circuito_cen" placeholder="Cen" min="0" max="99"></div></div><div class="col-md-4 mb-3"><label class="form-label">Velocit√† (km/h)</label><input type="text" class="form-control" id="gps-velocita_circuito" readonly></div></div> <div id="match-stats-fields" style="display: none;"><hr><h5 class="mb-3">Statistiche Partita</h5><div class="row"><div class="col-md-3 mb-3"><label class="form-label">Minuti Giocati</label><input type="number" class="form-control" id="gps-minuti_giocati"></div><div class="col-md-3 mb-3"><label class="form-label">Gol</label><input type="number" class="form-control" id="gps-gol"></div><div class="col-md-3 mb-3"><label class="form-label">Assist</label><input type="number" class="form-control" id="gps-assist"></div><div class="col-md-3 mb-3"><label class="form-label">Ammonizioni</label><input type="number" class="form-control" id="gps-ammonizioni"></div></div><div class="row"><div class="col-md-3 mb-3"><label class="form-label">Espulsioni</label><input type="number" class="form-control" id="gps-espulsioni"></div><div class="col-md-3 mb-3"><label class="form-label">Palle Recuperate</label><input type="number" class="form-control" id="gps-palle_recuperate"></div><div class="col-md-3 mb-3"><label class="form-label">Palle Perse</label><input type="number" class="form-control" id="gps-palle_perse"></div></div></div> <div class="row"><div class="col-12 mb-3"><label class="form-label">Note (opzionale)</label><textarea class="form-control" id="gps-note" rows="2" placeholder="Es. Allenamento intenso, recupero infortunio, ecc."></textarea></div></div> </form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button><button type="submit" class="btn btn-primary-custom" form="gps-form">Salva Dati GPS</button></div></div></div></div>
            <div class="modal fade" id="sessionModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="sessionModalLabel">Pianifica Sessione</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="session-form"><input type="hidden" id="session-id"><div class="mb-3"><label class="form-label">Data</label><input type="date" class="form-control" id="session-date" required></div><div class="mb-3"><label class="form-label">Titolo/Tipo</label><input type="text" class="form-control" id="session-title" required placeholder="Es. Allenamento tecnico"></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Ora Inizio</label><input type="time" class="form-control" id="session-time"></div><div class="col-md-6 mb-3"><label class="form-label">Luogo</label><input type="text" class="form-control" id="session-location" placeholder="Es. Campo 1"></div></div><div class="mb-3"><label class="form-label">Obiettivi</label><input type="text" class="form-control" id="session-goals" placeholder="Es. Possesso palla, tiri in porta"></div><div class="mb-3"><label class="form-label">Descrizione Allenamento (un punto per riga)</label><textarea class="form-control" id="session-description" rows="5"></textarea></div></form></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-outline-danger" id="delete-session-btn" style="display:none;">Elimina</button><div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="submit" class="btn btn-primary-custom" form="session-form">Salva Sessione</button></div></div></div></div></div>
            <div class="modal fade" id="matchResultModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="matchResultModalLabel">Inserisci Risultato Partita</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="match-result-form"><input type="hidden" id="match-id"><div class="row"><div class="col-md-4 mb-3"><label class="form-label">Data Partita</label><input type="date" class="form-control" id="match-date" required></div><div class="col-md-5 mb-3"><label class="form-label">Squadra Avversaria</label><input type="text" class="form-control" id="match-opponent-name" required></div><div class="col-md-3 mb-3"><label class="form-label">Luogo</label><select class="form-select" id="match-location"><option value="home">Casa</option><option value="away">Trasferta</option></select></div></div><div class="row align-items-center text-center"><div class="col-5"><label class="form-label">GO Sport</label><input type="number" class="form-control text-center" id="match-my-team-score" required min="0" placeholder="Gol"></div><div class="col-2">-</div><div class="col-5"><label class="form-label">AVVERSARI</label><input type="number" class="form-control text-center" id="match-opponent-score" required min="0" placeholder="Gol"></div></div><hr><div class="row mt-3"><div class="col-md-6"><h5><i class="bi bi-futbol"></i> Marcatori (GO Sport)</h5><div id="scorers-container" class="d-grid gap-2"></div><button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-scorer-btn"><i class="bi bi-plus"></i> Aggiungi Marcatore</button></div><div class="col-md-6"><h5><i class="bi bi-file-earmark-person"></i> Cartellini (GO Sport)</h5><div id="cards-container" class="d-grid gap-2"></div><button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-card-btn"><i class="bi bi-plus"></i> Aggiungi Cartellino</button></div></div></form></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-outline-danger" id="delete-match-btn" style="display:none;">Elimina Partita</button><div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="submit" class="btn btn-primary-custom" form="match-result-form">Salva Partita</button></div></div></div></div></div>
            <div class="modal fade" id="passwordModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Accesso Richiesto</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Per visualizzare questi dati √® richiesta una password.</p><form id="password-form"><div class="mb-3"><label for="password-input" class="form-label">Password</label><input type="password" class="form-control" id="password-input" required><div id="password-error" class="text-danger mt-2" style="display: none;">Password non corretta.</div></div><button type="submit" class="btn btn-primary-custom w-100">Accedi</button></form></div></div></div></div>
            <div class="modal fade" id="athleteDashboardModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="athleteDashboardTitle">Dashboard Atleta</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="athleteDashboardBody"><p class="text-center">Caricamento...</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button></div></div></div></div>`;


        const evaluationModal = new bootstrap.Modal(document.getElementById('evaluationModal'));
        const athleteModal = new bootstrap.Modal(document.getElementById('athleteModal'));
        const gpsModal = new bootstrap.Modal(document.getElementById('gpsModal'));
        const sessionModal = new bootstrap.Modal(document.getElementById('sessionModal'));
        const matchResultModal = new bootstrap.Modal(document.getElementById('matchResultModal'));
        const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
        const athleteDashboardModal = new bootstrap.Modal(document.getElementById('athleteDashboardModal')); // Nuova istanza modal

        const elements = {
            athleteGrid: document.getElementById('athlete-grid'),
            evaluationDatePicker: document.getElementById('evaluation-date-picker'),
            evaluationDatePicker2: document.getElementById('evaluation-date-picker-2'),
            performanceSelectorsContainer: document.getElementById('performance-selectors-container'),
            addComparisonBtn: document.getElementById('add-comparison-btn'),
            evaluationForm: document.getElementById('evaluation-form'),
            athleteForm: document.getElementById('athlete-form'),
            gpsForm: document.getElementById('gps-form'),
            addAthleteBtn: document.getElementById('add-athlete-btn'),
            comparisonPeriodToggle: document.getElementById('comparison-period-toggle'),
            attendancePeriodToggle: document.getElementById('attendance-period-toggle'),
            metricSelector: document.getElementById('performance-metric-selector'),
            tableContainer: document.getElementById('performance-table-container'),
            exportButtonsContainer: document.getElementById('export-buttons-container'),
            trendAthleteSelector: document.getElementById('trend-athlete-selector'),
            trendMetricSelector: document.getElementById('trend-metric-selector'),
            hallOfFameContainer: document.getElementById('hall-of-fame-container'),
            radarAthleteSelector1: document.getElementById('radar-athlete-selector-1'),
            radarAthleteSelector2: document.getElementById('radar-athlete-selector-2'),
            multiAthleteMetricSelector: document.getElementById('multi-athlete-metric-selector'),
            multiAthleteTimeFilter: document.querySelector('#multi-athlete-chart-container .btn-group[role="group"]'),
            multiAthleteDatepicker: document.getElementById('multi-athlete-datepicker'),
            multiAthleteDatepickerContainer: document.getElementById('multi-athlete-datepicker-container'),
            multiAthleteResetBtn: document.getElementById('multi-athlete-reset-btn'),
            deleteDayDataBtn: document.getElementById('delete-day-data-btn'),
            exportAllDataBtn: document.getElementById('export-all-data-btn'),
            importFileInput: document.getElementById('import-file-input'),
            performanceFilterToggle: document.getElementById('performance-filter-toggle'),
            multiAthleteTypeSelector: document.getElementById('multi-athlete-type-selector'),
            addSessionBtn: document.getElementById('add-session-btn'),
            calendarGrid: document.getElementById('calendar-grid'),
            currentMonthYearEl: document.getElementById('current-month-year'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            sessionForm: document.getElementById('session-form'),
            deleteSessionBtn: document.getElementById('delete-session-btn'),
            homeTotalAthletes: document.getElementById('home-total-athletes'),
            homeNextSession: document.getElementById('home-next-session'),
            homeTopPerformer: document.getElementById('home-top-performer'),
            quickAddAthleteBtn: document.getElementById('quick-add-athlete-btn'),
            quickPlanSessionBtn: document.getElementById('quick-plan-session-btn'),
            fieldContainer: document.getElementById('field-container'),
            fieldBenchArea: document.getElementById('field-bench-area'),
            availableList: document.getElementById('available-list'),
            addMatchBtn: document.getElementById('add-match-btn'),
            matchResultForm: document.getElementById('match-result-form'),
            deleteMatchBtn: document.getElementById('delete-match-btn'),
            matchResultsContainer: document.getElementById('match-results-container'),
            cardsSummaryTbody: document.getElementById('cards-summary-tbody'),
            matchOpponentFilter: document.getElementById('match-opponent-filter'),
            matchPeriodToggle: document.getElementById('match-period-toggle'),
            topScorersContainer: document.getElementById('top-scorers-container'),
            passwordForm: document.getElementById('password-form'),
            passwordError: document.getElementById('password-error'),
            alertsContainer: document.getElementById('alerts-container'),
            logoutBtn: document.getElementById('logout-btn'),
            statPg: document.getElementById('stat-pg'),
            statVps: document.getElementById('stat-vps'),
            statGf: document.getElementById('stat-gf'),
            statGs: document.getElementById('stat-gs'),
            statDr: document.getElementById('stat-dr'),
            medicalDeadlinesList: document.getElementById('medical-deadlines-list'), // Nuovo
            attendancePercentageTbody: document.getElementById('attendance-percentage-tbody'), // Nuovo
            athleteDashboardBody: document.getElementById('athleteDashboardBody'), // Nuovo
            athleteDashboardTitle: document.getElementById('athleteDashboardTitle') // Nuovo
        };

        const ACCESS_PASSWORD = "2025Edy201";
        let authSuccessCallback = null;
        let authCancelCallback = null;
        const isAuthenticated = () => sessionStorage.getItem('isAuthenticated') === 'true';
        const requestAuthentication = (onSuccess, onCancel = () => {}) => { if (isAuthenticated()) { onSuccess(); return; } authSuccessCallback = onSuccess; authCancelCallback = onCancel; elements.passwordError.style.display = 'none'; elements.passwordForm.reset(); passwordModal.show(); };
        elements.passwordForm.addEventListener('submit', (e) => { e.preventDefault(); const password = document.getElementById('password-input').value; if (password === ACCESS_PASSWORD) { sessionStorage.setItem('isAuthenticated', 'true'); elements.passwordError.style.display = 'none'; passwordModal.hide(); if (authSuccessCallback) authSuccessCallback(); updateAllUI(); } else { elements.passwordError.style.display = 'block'; } });
        document.getElementById('passwordModal').addEventListener('hidden.bs.modal', () => { if (!isAuthenticated() && authCancelCallback) { authCancelCallback(); } });

        const matchStatsFields = ['minuti_giocati', 'gol', 'assist', 'ammonizioni', 'espulsioni', 'palle_recuperate', 'palle_perse'];
        const allGpsFields = ['data_di_registrazione', 'ora_registrazione', 'tipo_sessione', 'distanza_totale', 'tempo_totale', 'distanza_sprint', 'velocita_massima', 'numero_di_sprint', 'max_acc', 'max_dec', 'passaggi_piede_sinistro', 'passaggi_piede_destro', 'cross_piede_sinistro', 'cross_piede_destro', 'potenza_massima_di_tiro', 'distanza_per_minuto', 'tiri_piede_sx', 'tiri_piede_dx', 'perc_passaggi_brevi', 'perc_lanci', 'distanza_circuito', 'tempo_circuito_totale_s', 'velocita_circuito', 'note', ...matchStatsFields];
        const gpsFieldsForDisplay = { /* ... (invariato) ... */ };
        const radarMetrics = { /* ... (invariato) ... */ };
        const evaluationCategories = ['presenza-allenamento', 'serieta-allenamento', 'abbigliamento-allenamento', 'abbigliamento-partita', 'comunicazioni', 'doccia'];
        const defaultAvatar = "data:image/svg+xml,...";
        let athletes = [], evaluations = {}, gpsData = {}, awards = {}, trainingSessions = {}, matchResults = {};
        let formationData = { starters: [], bench: [], tokens: [] };
        let chartInstances = {};
        let comparisonChartPeriod = 'daily';
        let attendanceChartPeriod = 'daily';
        let performanceSelections = [ { athleteId: null, sessionId: null }, { athleteId: null, sessionId: null } ];
        let performanceFilterType = 'all';
        let multiAthleteFilterType = 'all';
        let currentCalendarDate = new Date();
        let pollingInterval = null;
        let visuallyDeletedCards = [];

        const saveData = async () => { /* ... (invariato) ... */ };
        const migrateGpsData = () => { /* ... (invariato) ... */ };
        const loadData = async () => { /* ... (invariato) ... */ };
        const getWeekRange = (date) => { /* ... (invariato) ... */ };
        const calculateAthleteScore = (evaluation) => !evaluation ? 0 : Object.keys(evaluation).filter(k => k !== 'doccia').reduce((sum, key) => sum + parseInt(evaluation[key] || 0, 10), 0);
        const updateLogoutButtonVisibility = () => { elements.logoutBtn.style.display = isAuthenticated() ? 'block' : 'none'; };
        const updateUnlockButtonsVisibility = () => { const unlockBtns = document.querySelectorAll('.unlock-btn'); const displayStyle = isAuthenticated() ? 'none' : 'inline-block'; unlockBtns.forEach(btn => btn.style.display = displayStyle); };

        const updateTeamSeasonStats = () => {
            let pg = 0, v = 0, p = 0, s = 0, gf = 0, gs = 0;
            Object.values(matchResults).forEach(match => { pg++; const myScore = match.location === 'home' ? match.homeScore : match.awayScore; const oppScore = match.location === 'home' ? match.awayScore : match.homeScore; gf += myScore; gs += oppScore; if (myScore > oppScore) v++; else if (myScore < oppScore) s++; else p++; }); const dr = gf - gs; elements.statPg.textContent = pg; elements.statVps.textContent = `${v}-${p}-${s}`; elements.statGf.textContent = gf; elements.statGs.textContent = gs; elements.statDr.textContent = dr > 0 ? `+${dr}` : dr; elements.statDr.className = dr > 0 ? 'diff-pos' : (dr < 0 ? 'diff-neg' : '');
        };

        // --- NUOVA FUNZIONE: updateMedicalReminders ---
        const updateMedicalReminders = () => {
            const today = new Date(); today.setHours(0,0,0,0);
            const thirtyDaysFromNow = new Date(); thirtyDaysFromNow.setDate(today.getDate() + 30);
            const reminders = [];

            athletes.forEach(athlete => {
                if (athlete.scadenzaVisita) {
                    const deadline = new Date(athlete.scadenzaVisita); deadline.setHours(0,0,0,0); // Ignora l'ora
                    if (deadline < today) {
                        reminders.push({ name: athlete.name, date: deadline.toLocaleDateString('it-IT'), status: 'danger' }); // Scaduta
                    } else if (deadline <= thirtyDaysFromNow) {
                        reminders.push({ name: athlete.name, date: deadline.toLocaleDateString('it-IT'), status: 'warning' }); // In scadenza
                    }
                }
            });

            reminders.sort((a, b) => new Date(a.date.split('/').reverse().join('-')) - new Date(b.date.split('/').reverse().join('-'))); // Ordina per data

            const listElement = elements.medicalDeadlinesList;
            listElement.innerHTML = ''; // Pulisce la lista

            if (reminders.length > 0) {
                reminders.forEach(reminder => {
                    const li = document.createElement('li');
                    li.className = `list-group-item d-flex justify-content-between align-items-center text-bg-${reminder.status}`;
                    li.innerHTML = `<span>${reminder.name}</span> <small>${reminder.date}</small>`;
                    listElement.appendChild(li);
                });
            } else {
                listElement.innerHTML = '<p class="text-muted text-center mt-2">Nessuna scadenza imminente.</p>';
            }
        };

        // --- NUOVA FUNZIONE: updateAttendancePercentageTable ---
        const updateAttendancePercentageTable = () => {
             const thirtyDaysAgo = new Date();
             thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
             const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
             const todayStr = new Date().toISOString().split('T')[0];

             const relevantDates = Object.keys(evaluations).filter(date => date >= thirtyDaysAgoStr && date <= todayStr);
             const totalSessions = relevantDates.length; // Assumiamo una valutazione per sessione

             const attendancePercentages = [];

             if (totalSessions > 0) {
                 athletes.forEach(athlete => {
                     let attendedCount = 0;
                     relevantDates.forEach(date => {
                         if (evaluations[date]?.[athlete.id]?.['presenza-allenamento'] && parseInt(evaluations[date][athlete.id]['presenza-allenamento'], 10) > 0) {
                             attendedCount++;
                         }
                     });
                     const percentage = totalSessions > 0 ? ((attendedCount / totalSessions) * 100).toFixed(0) : 0;
                     attendancePercentages.push({ name: athlete.name, percentage: parseInt(percentage, 10) });
                 });

                 attendancePercentages.sort((a, b) => b.percentage - a.percentage); // Ordina da pi√π alto a pi√π basso

                 const tbody = elements.attendancePercentageTbody;
                 tbody.innerHTML = ''; // Pulisce
                 attendancePercentages.forEach(item => {
                     const row = tbody.insertRow();
                     row.innerHTML = `<td>${item.name}</td><td>${item.percentage}%</td>`;
                 });
             } else {
                 elements.attendancePercentageTbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Nessun dato di presenza negli ultimi 30 giorni.</td></tr>';
             }
        };

         // --- NUOVA FUNZIONE: openAthleteDashboardModal ---
        const openAthleteDashboardModal = (athleteId) => {
            const athlete = athletes.find(a => a.id.toString() === athleteId);
            if (!athlete) return;

            elements.athleteDashboardTitle.textContent = `Dashboard: ${athlete.name}`;
            elements.athleteDashboardBody.innerHTML = '<p class="text-center">Caricamento...</p>'; // Placeholder

            // Costruisci il contenuto HTML dinamicamente
            let content = `<div class="row"><div class="col-md-4 text-center"><img src="${athlete.avatar || defaultAvatar}" onerror="this.src='${defaultAvatar}'" alt="${athlete.name}" class="img-fluid rounded-circle mb-3" style="max-width: 100px;"><h4>${athlete.number}. ${athlete.name} ${athlete.isCaptain ? '<i class="bi bi-star-fill is-captain"></i>' : ''}</h4><p class="text-muted">${athlete.role}</p>`;

            // Stato visita medica
            const today = new Date(); today.setHours(0,0,0,0);
            let medicalStatus = '<span class="badge text-bg-secondary">Non Impostata</span>';
            if (athlete.scadenzaVisita) {
                const deadline = new Date(athlete.scadenzaVisita); deadline.setHours(0,0,0,0);
                if (deadline < today) medicalStatus = `<span class="badge text-bg-danger">Scaduta (${deadline.toLocaleDateString('it-IT')})</span>`;
                else medicalStatus = `<span class="badge text-bg-success">Valida (${deadline.toLocaleDateString('it-IT')})</span>`;
            }
            content += `<p>Visita Medica: ${medicalStatus}</p></div>`;

            content += `<div class="col-md-8">`; // Colonna destra

            // Ultime Valutazioni
            content += `<h5><i class="bi bi-card-checklist"></i> Ultime Valutazioni</h5>`;
            const athleteEvals = [];
            Object.entries(evaluations).forEach(([date, dailyEvals]) => { if(dailyEvals[athleteId]) athleteEvals.push({date, score: calculateAthleteScore(dailyEvals[athleteId])}); });
            athleteEvals.sort((a,b) => new Date(b.date) - new Date(a.date));
            if(athleteEvals.length > 0) {
                content += `<ul class="list-group list-group-flush mb-3">`;
                athleteEvals.slice(0, 5).forEach(ev => { content += `<li class="list-group-item d-flex justify-content-between align-items-center">${new Date(ev.date).toLocaleDateString('it-IT')} <span class="badge bg-primary rounded-pill">${ev.score}</span></li>`; });
                content += `</ul>`;
            } else { content += `<p class="text-muted">Nessuna valutazione registrata.</p>`; }

            // Statistiche Stagionali Atleta
            content += `<h5><i class="bi bi-trophy-fill"></i> Statistiche Stagionali</h5>`;
            let goals = 0, assists = 0, yellowCards = 0, redCards = 0;
            Object.values(matchResults).forEach(match => {
                goals += match.scorers.filter(s => s.athleteId.toString() === athleteId).length;
                // Nota: Assist non tracciati attualmente, li lascio a 0
                yellowCards += match.cards.filter(c => c.athleteId.toString() === athleteId && c.type === 'yellow').length;
                redCards += match.cards.filter(c => c.athleteId.toString() === athleteId && c.type === 'red').length;
            });
            content += `<p><i class="bi bi-futbol"></i> Gol: <strong>${goals}</strong> | <i class="bi bi-person-fill-up"></i> Assist: <strong>${assists}</strong> | <span class="yellow-card mx-1"></span> Gialli: <strong>${yellowCards}</strong> | <span class="red-card mx-1"></span> Rossi: <strong>${redCards}</strong></p>`;

            // Record GPS Recenti (Ultimi 30 giorni)
            content += `<h5><i class="bi bi-graph-up-arrow"></i> Record Recenti (30gg)</h5>`;
            const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
            const recentSessions = [];
            if (gpsData[athleteId]) {
                Object.entries(gpsData[athleteId]).forEach(([date, sessions]) => { if (date >= thirtyDaysAgoStr) { sessions.forEach(s => recentSessions.push(s)); } });
            }
            if (recentSessions.length > 0) {
                const maxDistPerMin = Math.max(0, ...recentSessions.map(s => s.distanza_per_minuto || 0)).toFixed(1);
                const maxSpeed = Math.max(0, ...recentSessions.map(s => s.velocita_massima || 0)).toFixed(1);
                const maxSprintDist = Math.max(0, ...recentSessions.map(s => s.distanza_sprint || 0)).toFixed(1);
                content += `<p>üèÉ‚Äç‚ôÇÔ∏è Dist/min Max: <strong>${maxDistPerMin} m/min</strong> | ‚ö°Ô∏è Vel Max: <strong>${maxSpeed} km/h</strong> | üí® Dist Sprint Max: <strong>${maxSprintDist} m</strong></p>`;
            } else { content += `<p class="text-muted">Nessun dato GPS negli ultimi 30 giorni.</p>`; }


            content += `</div></div>`; // Chiudi col-md-8 e row
            elements.athleteDashboardBody.innerHTML = content;
            athleteDashboardModal.show();
        };


        const updateAllUI = () => {
            updateLogoutButtonVisibility();
            updateUnlockButtonsVisibility();
            checkDeadlinesAndAlert();
            updateHomePage();
            updateTeamSeasonStats();
            updateMedicalReminders(); // <-- AGGIUNTA CHIAMATA
            renderAthletes();
            renderCalendar();
            renderFormation();
            renderMatchResults();
            renderCardsSummary();
            renderTopScorers();
            updateMatchAnalysisChart();
            updateEvaluationCharts();
            updateAttendanceChart();
            updateAttendancePercentageTable(); // <-- AGGIUNTA CHIAMATA
            updateHallOfFame();
            populatePerformanceSelectors();
            populateAnalysisSelectors();
            updatePerformanceChart();
            updateAthleteTrendChart();
            updateAthleteRadarChart();
            updateMultiAthleteChart();
        };

        // --- FUNZIONI UI ESISTENTI (createJerseyElement, etc.) ---
        // ... (Tutte le altre funzioni UI, Gestione Dati, Event Listeners rimangono invariate rispetto all'ultima versione funzionante, inclusa la logica originale di onDragEnd) ...
        const createJerseyElement = (athlete) => { /* ... */ };
        const createTokenElement = (type, id) => { /* ... */ };
        const renderFormation = () => { /* ... */ };
        // updateHomePage √® stata modificata sopra per aggiungere updateMedicalReminders
        const renderAthletes = () => { /* ... */ };
        const renderCalendar = () => { /* ... */ };
        const openSessionModal = (sessionData = null) => { /* ... */ };
        const renderMatchResults = () => { /* ... */ };
        const renderCardsSummary = () => { /* ... */ };
        const renderTopScorers = () => { /* ... */ };
        const updateMatchAnalysisChart = () => { /* ... */ };
        const updateEvaluationCharts = () => { /* ... */ };
        const updateAttendanceChart = () => { /* ... */ };
        // updateAttendancePercentageTable √® nuova
        const updateHallOfFame = () => { /* ... */ };
        const getFilteredGpsData = () => { /* ... */ };
        const findSessionById = (sessionId) => { /* ... */ };
        const populatePerformanceSelectors = () => { /* ... */ };
        const updatePerformanceChart = () => { /* ... */ };
        const updatePerformanceTable = () => { /* ... */ };
        const populateAnalysisSelectors = () => { /* ... */ };
        const updateAthleteTrendChart = () => { /* ... */ };
        const updateAthleteRadarChart = () => { /* ... */ };
        const updateMultiAthleteChart = () => { /* ... */ };
        const checkDeadlinesAndAlert = () => { /* ... */ };
        const logout = () => { /* ... */ };

        // --- EVENT LISTENERS ESISTENTI ---
        const syncAndUpdateEvaluationDate = (newDate) => { /* ... */ };
        elements.evaluationDatePicker.addEventListener('change', (e) => syncAndUpdateEvaluationDate(e.target.value));
        elements.evaluationDatePicker2.addEventListener('change', (e) => syncAndUpdateEvaluationDate(e.target.value));
        elements.logoutBtn.addEventListener('click', logout);
        elements.cardsSummaryTbody.addEventListener('click', e => { /* ... */ });
        document.querySelector('main').addEventListener('click', e => { /* ... */ });
        elements.prevMonthBtn.addEventListener('click', () => { /* ... */ });
        elements.nextMonthBtn.addEventListener('click', () => { /* ... */ });
        elements.addSessionBtn.addEventListener('click', () => openSessionModal());
        elements.quickAddAthleteBtn.addEventListener('click', () => elements.addAthleteBtn.click());
        elements.quickPlanSessionBtn.addEventListener('click', () => elements.addSessionBtn.click());
        elements.calendarGrid.addEventListener('click', e => { /* ... */ });
        elements.sessionForm.addEventListener('submit', e => { /* ... */ });
        elements.deleteSessionBtn.addEventListener('click', () => { /* ... */ });
        document.getElementById('gps-tipo_sessione').addEventListener('change', (e) => { /* ... */ });
        elements.comparisonPeriodToggle.addEventListener('click', (e) => { /* ... */ });
        elements.attendancePeriodToggle.addEventListener('click', (e) => { /* ... */ });
        elements.addAthleteBtn.addEventListener('click', () => { /* ... */ });
        // MODIFICA Event Listener su athleteGrid per aprire il nuovo modal
        elements.athleteGrid.addEventListener('click', (e) => {
            const cardClickTarget = e.target.closest('.athlete-card-clickable');
            const card = e.target.closest('[data-athlete-id]');
            if (!card) return;
            const athleteId = card.dataset.athleteId;
            const athlete = athletes.find(a => a.id.toString() === athleteId);
            if (!athlete) return;

            if (e.target.closest('.edit-btn')) {
                // Logica per aprire il modal di modifica atleta (invariata)
                document.getElementById('athleteModalLabel').textContent = 'Modifica Atleta';
                document.getElementById('modal-athlete-id').value = athlete.id;
                document.getElementById('athlete-name').value = athlete.name;
                document.getElementById('athlete-role').value = athlete.role;
                document.getElementById('athlete-number').value = athlete.number;
                document.getElementById('scadenza-visita').value = athlete.scadenzaVisita || '';
                document.getElementById('prenotazione-visita').value = athlete.dataPrenotazioneVisita || '';
                document.getElementById('athlete-captain').checked = athlete.isCaptain;
                const preview = document.getElementById('avatar-preview');
                document.getElementById('athlete-avatar-input').value = '';
                document.getElementById('athlete-avatar-base64').value = '';
                if (athlete.avatar) { preview.src = athlete.avatar; preview.style.display = 'block'; } else { preview.style.display = 'none'; }
                athleteModal.show();
            } else if (e.target.closest('.delete-btn')) {
                // Logica per eliminare l'atleta (invariata)
                if (confirm(`Sei sicuro di voler eliminare ${athlete.name}? Tutti i suoi dati storici verranno rimossi.`)) { athletes = athletes.filter(a => a.id.toString() !== athleteId); for (const date in evaluations) { delete evaluations[date][athleteId]; } delete gpsData[athleteId]; for (const date in awards) { awards[date] = awards[date].filter(a => a.athleteId.toString() !== athleteId); } Object.keys(matchResults).forEach(matchId => { matchResults[matchId].scorers = matchResults[matchId].scorers.filter(s => String(s.athleteId) !== athleteId); matchResults[matchId].cards = matchResults[matchId].cards.filter(c => String(c.athleteId) !== athleteId); }); saveData(); updateAllUI(); }
            } else if (e.target.closest('.gps-btn')) {
                // Logica per aprire il modal GPS (invariata)
                document.getElementById('modal-athlete-name-gps').textContent = athlete.name; const gpsForm = document.getElementById('gps-form'); gpsForm.reset(); document.getElementById('match-stats-fields').style.display = 'none'; gpsForm.querySelector('#modal-athlete-id-gps').value = athlete.id; gpsForm.querySelector('#gps-data_di_registrazione').valueAsDate = new Date(); const sessionSelector = document.getElementById('gps-session-selector'); sessionSelector.innerHTML = '<option value="">--- Inserisci Nuova Sessione ---</option>'; const athleteGpsData = gpsData[athlete.id] || {}; const allSessions = []; Object.entries(athleteGpsData).forEach(([date, sessions]) => { sessions.forEach(session => allSessions.push({ date, ...session })); }); allSessions.sort((a,b)=> new Date(b.date) - new Date(a.date) || (b.ora_registrazione || "").localeCompare(a.ora_registrazione || "")).forEach(session => { const option = document.createElement('option'); option.value = session.id; let text = `${new Date(session.date).toLocaleDateString('it-IT')} ${session.ora_registrazione || ''} - ${session.tipo_sessione || 'N/A'}`; if (session.tipo_sessione === 'Individual' && !isAuthenticated()) { text += ' (Protetta)'; } option.textContent = text; sessionSelector.appendChild(option); }); document.getElementById('delete-gps-session-btn').disabled = true; gpsModal.show();
            } else if (cardClickTarget) {
                 // **NUOVO**: Apre il Dashboard Atleta invece del modal valutazione
                 openAthleteDashboardModal(athleteId);
            }
        });
        modalsContainer.addEventListener('change', (e) => { /* ... avatar input ... */ });
        elements.athleteForm.addEventListener('submit', (e) => { /* ... */ });
        elements.evaluationForm.addEventListener('submit', (e) => { /* ... */ });
        elements.gpsForm.addEventListener('submit', (e) => { /* ... */ });
        document.getElementById('gps-data_di_registrazione').addEventListener('input', () => { /* ... */ });
        document.getElementById('gps-ora_registrazione').addEventListener('input', () => { /* ... */ });
        ['gps-distanza_totale', 'gps-tempo_totale'].forEach(id => { /* ... */ });
        ['gps-distanza_circuito', /*...*/].forEach(id => { /* ... */ });
        elements.performanceSelectorsContainer.addEventListener('change', (e) => { /* ... */ });
        elements.performanceSelectorsContainer.addEventListener('click', (e) => { /* ... */ });
        elements.addComparisonBtn.addEventListener('click', () => { /* ... */ });
        elements.metricSelector.addEventListener('change', updatePerformanceChart);
        elements.trendAthleteSelector.addEventListener('change', updateAthleteTrendChart);
        elements.trendMetricSelector.addEventListener('change', updateAthleteTrendChart);
        elements.radarAthleteSelector1.addEventListener('change', updateAthleteRadarChart);
        elements.radarAthleteSelector2.addEventListener('change', updateAthleteRadarChart);
        elements.multiAthleteTimeFilter.addEventListener('click', e => { /* ... */ });
        elements.multiAthleteMetricSelector.addEventListener('change', updateMultiAthleteChart);
        elements.multiAthleteDatepicker.addEventListener('change', updateMultiAthleteChart);
        elements.multiAthleteResetBtn.addEventListener('click', () => { /* ... */ });
        elements.exportAllDataBtn.addEventListener('click', () => { /* ... */ });
        elements.deleteDayDataBtn.addEventListener('click', () => { /* ... */ });
        modalsContainer.addEventListener('click', (e) => { /* ... delete single athlete day ... */ });
        modalsContainer.addEventListener('change', (e) => { /* ... gps session selector ... */ });
        elements.importFileInput.addEventListener('change', (e) => { /* ... */ });
        elements.performanceFilterToggle.addEventListener('click', (e) => { /* ... */ });
        elements.multiAthleteTypeSelector.addEventListener('click', (e) => { /* ... */ });
        document.addEventListener('click', (e) => { /* ... export excel/pdf ... */ });

        // --- DRAG & DROP FORMAZIONE (CUSTOM) ---
        let draggedEl = null; let dragGhost = null; let offsetX, offsetY;
        function onDragStart(e) { const target = e.target.closest('.player-jersey, .available-player, .tool-item, .token'); if (!target || target.classList.contains('disabled') || e.button !== 0) return; e.preventDefault(); draggedEl = target; if (draggedEl.classList.contains('available-player')) { const athleteId = draggedEl.dataset.athleteId; const athlete = athletes.find(a => String(a.id) === athleteId); if (!athlete) return; dragGhost = createJerseyElement(athlete); } else { dragGhost = draggedEl.cloneNode(true); } dragGhost.classList.add('dragging'); document.body.appendChild(dragGhost); const rect = draggedEl.getBoundingClientRect(); offsetX = e.clientX - rect.left; offsetY = e.clientY - rect.top; dragGhost.style.left = `${e.clientX - offsetX}px`; dragGhost.style.top = `${e.clientY - offsetY}px`; document.addEventListener('mousemove', onDragMove); document.addEventListener('mouseup', onDragEnd, { once: true }); }
        function onDragMove(e) { if (!dragGhost) return; dragGhost.style.left = `${e.clientX - offsetX}px`; dragGhost.style.top = `${e.clientY - offsetY}px`; }
        function onDragEnd(e) { if (!draggedEl || !dragGhost) { cleanUpDrag(); return; } dragGhost.style.display = 'none'; const dropTarget = document.elementFromPoint(e.clientX, e.clientY); dragGhost.style.display = ''; const dropZone = dropTarget ? dropTarget.closest('.drop-zone') : null; if (dropZone) { const athleteId = draggedEl.dataset.athleteId; const itemType = draggedEl.dataset.itemType; const tokenId = draggedEl.dataset.tokenId; if (athleteId) { formationData.starters = formationData.starters.filter(p => p.athleteId != athleteId); formationData.bench = formationData.bench.filter(p => p.athleteId != athleteId); } else if (tokenId) { formationData.tokens = formationData.tokens.filter(t => t.id != tokenId); } const rect = dropZone.getBoundingClientRect(); const left = ((e.clientX - rect.left) / rect.width) * 100; const top = ((e.clientY - rect.top) / rect.height) * 100; if (athleteId) { if (dropZone.id === 'field-container' || dropZone.id === 'field-bench-area') { const targetArray = dropZone.id === 'field-container' ? formationData.starters : formationData.bench; targetArray.push({ athleteId, top, left }); } } else if (itemType) { if (dropZone.id === 'field-container' || dropZone.id === 'field-bench-area') { const newId = tokenId || Date.now().toString(); if (itemType === 'opponent' && (draggedEl.classList.contains('tool-item') || !tokenId)) { formationData.tokens.push({ id: newId, type: itemType, top, left }); } else { formationData.tokens = formationData.tokens.filter(t => t.type !== itemType); formationData.tokens.push({ id: newId, type: itemType, top, left }); } } } saveData(); renderFormation(); } cleanUpDrag(); }
        function cleanUpDrag() { if (dragGhost) { dragGhost.remove(); } draggedEl = null; dragGhost = null; document.removeEventListener('mousemove', onDragMove); }
        document.getElementById('formazione-section').addEventListener('mousedown', onDragStart);

        // --- GESTIONE STAMPA ---
        document.body.addEventListener('click', (e) => { /* ... */ });
        window.addEventListener('beforeprint', () => { /* ... */ });
        window.addEventListener('afterprint', () => { /* ... */ });

        // --- EVENT LISTENER RISULTATI PARTITE ---
        const openMatchResultModal = (matchId = null) => { /* ... */ };
        const addScorerInput = (scorer = {}) => { /* ... */ };
        const addCardInput = (card = {}) => { /* ... */ };
        elements.addMatchBtn.addEventListener('click', () => openMatchResultModal());
        document.getElementById('add-scorer-btn').addEventListener('click', () => addScorerInput());
        document.getElementById('add-card-btn').addEventListener('click', () => addCardInput());
        modalsContainer.addEventListener('click', e => { /* ... remove row ... */ });
        elements.matchResultForm.addEventListener('submit', e => { /* ... */ });
        elements.deleteMatchBtn.addEventListener('click', () => { /* ... */ });
        elements.matchOpponentFilter.addEventListener('change', updateMatchAnalysisChart);
        elements.matchPeriodToggle.addEventListener('click', e => { /* ... */ });

        // --- INIZIALIZZAZIONE APP ---
        function startPolling() { /* ... */ }
        async function initializeApp() { await loadData(); const today = new Date(); elements.evaluationDatePicker.valueAsDate = today; elements.evaluationDatePicker2.valueAsDate = today; elements.multiAthleteDatepicker.valueAsDate = today; updateAllUI(); startPolling(); }
        initializeApp();
    });
    </script>
</body>
</html>