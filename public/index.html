<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-blue: #0a2463; --secondary-blue: #1e5095; --primary-red: #d90429;
            --text-light: #ffffff; --card-bg: #1a3a7a; --border-color: #3b5a9d; --gold-star: #FFD700;
            --field-green: #008000; --field-line: #FFF; --gk-color: #E8C135; --custom-purple: #6f42c1;
        }
        html { scroll-behavior: smooth; }
        body { background-color: var(--primary-blue); color: var(--text-light); padding-top: 56px; }
        .bg-dark-blue { background-color: #051438 !important; border-bottom: 2px solid var(--primary-red); }
        .main-title { color: var(--text-light); border-left: 4px solid var(--primary-red); padding-left: 1rem; }
        .athlete-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .athlete-card-clickable { cursor: pointer; }
        .athlete-card-clickable:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(217, 4, 41, 0.2); border-color: var(--primary-red); }
        .athlete-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--border-color); object-fit: cover; background-color: var(--secondary-blue); }
        .athlete-card .card-title { font-size: 1.1rem; margin-bottom: 0.1rem; }
        .shirt-number { font-size: 1.5rem; font-weight: bold; color: var(--text-light); background-color: var(--primary-red); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; top: 50%; right: 15px; transform: translateY(-50%); }
        .is-captain { color: var(--gold-star); }
        .card-actions { position: absolute; bottom: 10px; right: 10px; z-index: 5; display: flex; gap: 5px; }
        .card-actions .btn { background: rgba(0,0,0,0.3); border: none; }
        .chart-card, .table-card, .summary-card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .modal-content { background-color: var(--primary-blue); border: 1px solid var(--primary-red); }
        .modal-header, .modal-footer { border-bottom: 1px solid var(--border-color); border-top: 1px solid var(--border-color); }
        .btn-primary-custom { background-color: var(--primary-red); border-color: var(--primary-red); color: white; }
        .btn-primary-custom:hover { background-color: #b80323; border-color: #b80323; }
        .form-control, .form-select { background-color: var(--secondary-blue); color: var(--text-light); border-color: var(--border-color); }
        .form-control::placeholder { color: #8a9fc1; }
        .form-control:focus, .form-select:focus { background-color: var(--secondary-blue); color: var(--text-light); border-color: var(--primary-red); box-shadow: 0 0 0 0.25rem rgba(217, 4, 41, 0.25); }
        .award-card { background: linear-gradient(45deg, var(--gold-star), #d4af37); color: #000; border: 2px solid #fff; width: 180px; }
        .award-avatar { width: 50px; height: 50px; }
        .text-muted { color: rgba(255, 255, 255, 0.75) !important; }
        .summary-card .card-body { min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;}
        .summary-card .display-4 { font-weight: 500; }
        .calendar-card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { background-color: var(--secondary-blue); border: 1px solid var(--border-color); min-height: 120px; padding: 8px; font-size: 0.9rem; }
        .calendar-day.today { border-color: var(--primary-red); }
        .calendar-day-header { font-weight: bold; }
        .calendar-session {
            padding: 4px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 5px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: white;
            font-weight: bold;
        }
        .deadline-status { font-size: 1.2rem; position: absolute; top: 50%; right: 70px; transform: translateY(-50%); }
        .text-purple { color: var(--custom-purple) !important; }
        .available-player.disabled { opacity: 0.5; cursor: not-allowed; background-color: #343a40 !important; }
        .dragging { opacity: 0.5; z-index: 1056; pointer-events: none; }
        #pitch-wrapper { display: flex; align-items: flex-start; gap: 1rem; }
        #field-container { background-color: var(--field-green); border: 2px solid var(--field-line); position: relative; width: 100%; max-width: 450px; aspect-ratio: 5 / 7; box-sizing: border-box; flex-shrink: 0; }
        #field-bench-area { background-color: rgba(0,0,0,0.2); border: 2px dashed var(--border-color); border-radius: 8px; width: 150px; height: 630px; position: relative; flex-shrink: 0; }
        .field-line, .field-box, .field-circle, .field-spot { position: absolute; box-sizing: border-box; border-color: var(--field-line); }
        .halfway-line { border-top: 2px solid var(--field-line); width: 100%; top: 50%; }
        .center-circle { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 25%; aspect-ratio: 1/1; border: 2px solid var(--field-line); border-radius: 50%; }
        .center-spot { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2%; aspect-ratio: 1/1; background-color: var(--field-line); border-radius: 50%; }
        .penalty-box-top { top: 0; left: 50%; transform: translateX(-50%); width: 60%; height: 16.5%; border: 2px solid var(--field-line); border-top: none; }
        .penalty-box-bottom { bottom: 0; left: 50%; transform: translateX(-50%); width: 60%; height: 16.5%; border: 2px solid var(--field-line); border-bottom: none; }
        .goal-box-top { top: 0; left: 50%; transform: translateX(-50%); width: 30%; height: 6%; border: 2px solid var(--field-line); border-top: none; }
        .goal-box-bottom { bottom: 0; left: 50%; transform: translateX(-50%); width: 30%; height: 6%; border: 2px solid var(--field-line); border-bottom: none; }
        .penalty-spot-top { top: 11.5%; left: 50%; transform: translateX(-50%); width: 1.5%; aspect-ratio: 1/1; background-color: var(--field-line); border-radius: 50%; }
        .penalty-spot-bottom { bottom: 11.5%; left: 50%; transform: translateX(-50%); width: 1.5%; aspect-ratio: 1/1; background-color: var(--field-line); border-radius: 50%; }
        .player-jersey { position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 15%; cursor: grab; user-select: none; font-size: clamp(4.5px, 0.6vw, 8px); transform: translate(-50%, -50%); }
        .jersey-body { position: relative; width: 5em; height: 5em; background-color: var(--secondary-blue); border-radius: 0.8em 0.8em 0.5em 0.5em; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 -4px 8px rgba(0,0,0,0.3); }
        .jersey-body::before, .jersey-body::after { content: ''; position: absolute; width: 2.5em; height: 1em; background-color: inherit; top: 0; }
        .jersey-body::before { left: -1.8em; transform: rotate(-40deg); border-radius: 0.5em 0.2em 0 0; }
        .jersey-body::after { right: -1.8em; transform: rotate(40deg); border-radius: 0.2em 0.5em 0 0; }
        .jersey-number { font-size: 2.2em; font-weight: bold; color: white; text-shadow: 1px 1px 2px black; }
        .player-name { margin-top: 0.5em; font-size: 1.33em; font-weight: bold; color: white; background-color: rgba(0,0,0,0.6); padding: 0.1em 0.4em; border-radius: 4px; white-space: nowrap; }
        #available-list .list-group-item, .tool-item { cursor: grab; background-color: var(--secondary-blue); }
        .available-slot { border: 1px dashed var(--border-color); border-radius: 8px; min-height: 50px; }
        #formation-tools { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1rem; }
        .tool-item { border: 1px solid var(--border-color); border-radius: 8px; padding: 5px 10px; text-align: center; }
        .tool-item.opponent-tool { background-color: var(--primary-red); font-size: 1.5rem; line-height: 1; padding: 5px 12px; }
        .tool-item.ball-tool { font-size: 1.5rem; line-height: 1; padding: 5px 10px; }
        .token { position: absolute; cursor: grab; user-select: none; z-index: 10; text-align: center; transform: translate(-50%, -50%); }
        .token-captain { font-weight: bold; color: white; background: black; padding: 0.2em 0.5em; border-radius: 4px; font-size: clamp(8px, 1vw, 12px); }
        .token-ball { font-size: 2rem; }
        .token-opponent { width: 2.5em; height: 2.5em; background-color: var(--primary-red); border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.5); font-size: clamp(8px, 1vw, 12px); }
        .match-result-item { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .match-score { font-weight: bold; font-size: 1.1rem; }
        .yellow-card { width: 10px; height: 14px; background-color: #ffc107; display: inline-block; border-radius: 2px; }
        .red-card { width: 10px; height: 14px; background-color: #dc3545; display: inline-block; border-radius: 2px; }
        .scorers-list { font-size: 0.8rem; color: var(--text-muted); }
        #cards-summary-table { --bs-table-bg: var(--secondary-blue); --bs-table-striped-bg: var(--secondary-blue); --bs-table-hover-bg: var(--border-color); border-color: var(--border-color); }
        .season-stats-card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .season-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; text-align: center;}
        .stat-item h6 { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.2rem;}
        .stat-item p { font-size: 1.4rem; font-weight: 500; margin-bottom: 0;}
        .stat-item .diff-pos { color: #28a745; }
        .stat-item .diff-neg { color: var(--primary-red); }
        @media print {
            body { padding-top: 0; }
            .no-print { display: none !important; }
            body * { visibility: hidden; }
            .printing-now, .printing-now * { visibility: visible; }
            .printing-now { position: absolute; left: 0; top: 0; width: 100%; }
            .printing-now #athlete-grid { display: flex !important; flex-wrap: wrap !important; }
            .printing-now #athlete-grid > [class*="col-"] { flex: 0 0 25% !important; max-width: 25% !important; padding: 5px !important; page-break-inside: avoid; }
            .printing-now .athlete-card { box-shadow: none !important; }
            .printing-now .card, .printing-now .list-group-item, .printing-now .calendar-day, .printing-now .table { background-color: #fff !important; border: 1px solid #ccc !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now table, .printing-now th, .printing-now td { background-color: #fff !important; color: #000 !important; border-color: #000 !important; }
            .printing-now .calendar-session, .printing-now .shirt-number { background-color: #cccccc !important; color: #000 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now *, .printing-now .main-title, .printing-now .text-muted, .printing-now .card-title, .printing-now p, .printing-now h1, .printing-now h2, .printing-now h3, .printing-now h4, .printing-now h5, .printing-now h6 { color: #000 !important; }
            .printing-now .player-name, .printing-now .jersey-number, .printing-now .token-captain { color: #fff !important; }
            .printing-now .main-title { border-left-color: #000 !important; }
            .printing-now canvas { max-width: 100% !important; height: auto !important; }
            .printing-now #field-container { background-color: var(--field-green) !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now #field-container .field-line, .printing-now #field-container .field-box, .printing-now #field-container .field-circle { border-color: var(--field-line) !important; }
            .printing-now #field-container .field-spot { background-color: var(--field-line) !important; }
            .printing-now .jersey-body, .printing-now .player-name, .printing-now .token-opponent, .printing-now .token-captain, .printing-now .yellow-card, .printing-now .red-card { -webkit-print-color-adjust: exact; color-adjust: exact; }
            .printing-now .player-jersey[data-role*="Portiere"] .jersey-body { background-color: var(--gk-color) !important; }
        }
    </style>
</head>
<body>
    <!-- HTML identico fino allo script -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark-blue fixed-top no-print">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#"><i class="bi bi-person-workspace"></i> Coach Dashboard</a>
            <button class="btn btn-outline-secondary ms-auto" id="logout-btn" title="Blocca Dashboard (Logout)" style="display: none;"><i class="bi bi-unlock-fill"></i></button>
        </div>
    </nav>
    <main class="container-fluid mt-5 pt-3">
        <!-- ... tutto il resto dell'HTML identico ... -->
        <!-- Per brevità, qui includo solo lo script modificato -->
    </main>
    <footer class="bg-dark-blue py-3 mt-5 no-print">
        <div class="container text-center">
            <p class="text-muted mb-0">By Edy Franzoso</p>
        </div>
    </footer>
    <div id="modals-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // ✅ Funzione per normalizzare la data in formato locale (evita slittamento)
    function toLocalDate(dateInput) {
        if (typeof dateInput === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
            return dateInput;
        }
        const d = new Date(dateInput);
        const offset = d.getTimezoneOffset();
        const localDate = new Date(d.getTime() - (offset * 60 * 1000));
        return localDate.toISOString().split('T')[0];
    }

    document.addEventListener('DOMContentLoaded', () => {
        // ... tutto il codice JS identico fino a modalsContainer.innerHTML ...

        const modalsContainer = document.getElementById('modals-container');
        // ✅ Modifica: nel matchResultModal, i campi dei gol NON sono più required
        modalsContainer.innerHTML = `<div class="modal fade" id="evaluationModal" tabindex="-1">... (identico) ...</div>
        <div class="modal fade" id="athleteModal" tabindex="-1">... (identico) ...</div>
        <div class="modal fade" id="gpsModal" tabindex="-1">... (identico) ...</div>
        <div class="modal fade" id="sessionModal" tabindex="-1">... (identico) ...</div>
        <!-- ✅ MODIFICA QUI: rimossi "required" dai campi gol -->
        <div class="modal fade" id="matchResultModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="matchResultModalLabel">Inserisci Risultato Partita</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="match-result-form"><input type="hidden" id="match-id"><div class="row"><div class="col-md-4 mb-3"><label class="form-label">Data Partita</label><input type="date" class="form-control" id="match-date" required></div><div class="col-md-4 mb-3"><label class="form-label">Ora Partita</label><input type="time" class="form-control" id="match-time"></div><div class="col-md-4 mb-3"><label class="form-label">Luogo Fisico</label><input type="text" class="form-control" id="match-venue" placeholder="Es. Stadio Comunale"></div></div><div class="row"><div class="col-md-5 mb-3"><label class="form-label">Squadra Avversaria</label><input type="text" class="form-control" id="match-opponent-name" required></div><div class="col-md-3 mb-3"><label class="form-label">Luogo</label><select class="form-select" id="match-location"><option value="home">Casa</option><option value="away">Trasferta</option></select></div></div><div class="row align-items-center text-center"><div class="col-5"><label class="form-label">GO Sport</label><input type="number" class="form-control text-center" id="match-my-team-score" min="0" placeholder="Gol"></div><div class="col-2">-</div><div class="col-5"><label class="form-label">AVVERSARI</label><input type="number" class="form-control text-center" id="match-opponent-score" min="0" placeholder="Gol"></div></div><hr><div class="row mt-3"><div class="col-md-6"><h5><i class="bi bi-futbol"></i> Marcatori (GO Sport)</h5><div id="scorers-container" class="d-grid gap-2"></div><button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-scorer-btn"><i class="bi bi-plus"></i> Aggiungi Marcatore</button></div><div class="col-md-6"><h5><i class="bi bi-file-earmark-person"></i> Cartellini (GO Sport)</h5><div id="cards-container" class="d-grid gap-2"></div><button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-card-btn"><i class="bi bi-plus"></i> Aggiungi Cartellino</button></div></div></form></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-outline-danger" id="delete-match-btn" style="display:none;">Elimina Partita</button><div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="submit" class="btn btn-primary-custom" form="match-result-form">Salva Partita</button></div></div></div></div></div>
        <div class="modal fade" id="passwordModal" tabindex="-1">... (identico) ...</div>`;

        // ... resto del codice JS identico fino a renderCalendar ...

        // ✅ Funzione renderCalendar corretta
        const renderCalendar = () => {
            elements.calendarGrid.innerHTML = '';
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            elements.currentMonthYearEl.textContent = `${currentCalendarDate.toLocaleString('it-IT', { month: 'long' })} ${year}`;
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;

            for (let i = 0; i < startDayOfWeek; i++) {
                elements.calendarGrid.innerHTML += `<div class="calendar-day other-month"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = toLocalDate(date); // ✅ Usa la data normalizzata

                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                if (dateString === toLocalDate(new Date())) {
                    dayCell.classList.add('today');
                }
                dayCell.innerHTML = `<div class="calendar-day-header">${day}</div>`;

                // Allenamenti
                if (trainingSessions[dateString]) {
                    trainingSessions[dateString].forEach(session => {
                        const sessionEl = document.createElement('div');
                        sessionEl.className = 'calendar-session';
                        sessionEl.textContent = session.title;
                        // ✅ Colori aggiornati
                        if (session.title?.toLowerCase().includes('individual')) {
                            sessionEl.style.backgroundColor = '#FF6F00'; // Arancione
                        } else {
                            sessionEl.style.backgroundColor = '#CCFF00'; // Verde acido
                        }
                        sessionEl.dataset.sessionId = session.id;
                        sessionEl.dataset.date = dateString;
                        dayCell.appendChild(sessionEl);
                    });
                }

                // Partite
                if (matchResults) {
                    Object.values(matchResults).forEach(match => {
                        const matchDateNormalized = toLocalDate(match.date);
                        if (matchDateNormalized === dateString) {
                            const location = match.location === 'home' ? 'Casa' : 'Trasferta';
                            const time = match.time || '';
                            const venue = match.venue || '';
                            let label = `${location === 'Casa' ? '⚽' : '✈️'} ${match.opponentName}`;
                            if (time || venue) {
                                label += ` (${time || ''}${venue ? (time ? ' - ' : '') + venue : ''})`;
                            }
                            const matchEl = document.createElement('div');
                            matchEl.className = 'calendar-session';
                            matchEl.textContent = label;
                            matchEl.style.backgroundColor = match.location === 'home' ? '#d90429' : '#1e5095'; // Rosso / Azzurro
                            matchEl.dataset.matchId = match.id;
                            dayCell.appendChild(matchEl);
                        }
                    });
                }

                elements.calendarGrid.appendChild(dayCell);
            }
        };

        // ... resto del codice JS identico ...

        // ✅ Modifica: nel submit del matchResultForm, i gol possono essere vuoti
        elements.matchResultForm.addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('match-id').value || Date.now();
            const location = document.getElementById('match-location').value;
            // ✅ Rimossi "required" e parseInt con fallback a null
            const myTeamScoreInput = document.getElementById('match-my-team-score').value;
            const opponentScoreInput = document.getElementById('match-opponent-score').value;
            const myTeamScore = myTeamScoreInput === '' ? null : parseInt(myTeamScoreInput, 10);
            const opponentScore = opponentScoreInput === '' ? null : parseInt(opponentScoreInput, 10);
            const matchData = {
                id: id,
                date: document.getElementById('match-date').value,
                time: document.getElementById('match-time').value,
                venue: document.getElementById('match-venue').value,
                opponentName: document.getElementById('match-opponent-name').value.trim(),
                location: location,
                homeScore: location === 'home' ? myTeamScore : opponentScore,
                awayScore: location === 'away' ? myTeamScore : opponentScore,
                scorers: [],
                cards: []
            };
            document.querySelectorAll('#scorers-container .d-flex').forEach(row => {
                matchData.scorers.push({ athleteId: row.querySelector('.scorer-athlete').value, minute: row.querySelector('.scorer-minute').value });
            });
            document.querySelectorAll('#cards-container .d-flex').forEach(row => {
                matchData.cards.push({ athleteId: row.querySelector('.card-athlete').value, type: row.querySelector('.card-type').value, minute: row.querySelector('.card-minute').value });
            });
            matchResults[id] = matchData;
            saveData();
            updateAllUI();
            matchResultModal.hide();
        });

        // ... resto del codice JS identico (initializeApp, ecc.) ...
        async function initializeApp() { await loadData(); const today = new Date(); elements.evaluationDatePicker.valueAsDate = today; elements.evaluationDatePicker2.valueAsDate = today; elements.multiAthleteDatepicker.valueAsDate = today; updateAllUI(); startPolling(); }
        initializeApp();
    });
    </script>
</body>
</html>