<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Squadra e Formazione</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Arial', sans-serif; }
        .player-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background-color: #f9f9f9; position: relative; }
        .player-card.selected { background-color: #e0ffe0; border-color: #0f0; }
        .player-card .btn-group { margin-top: 10px; }
        .form-section { margin-bottom: 30px; padding: 20px; border: 1px solid #eee; border-radius: 10px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .team-management-section { margin-top: 20px; }
        #team-overview .player-card { cursor: pointer; }
        #field { border: 2px solid #000; height: 600px; position: relative; background-color: #28a745; margin-bottom: 20px; overflow: hidden; }
        .field-player { position: absolute; background-color: #007bff; color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: grab; z-index: 10; border: 2px solid #fff; }
        .field-player.ui-draggable-dragging { cursor: grabbing; z-index: 100; }
        #formation-players { min-height: 100px; border: 1px dashed #ccc; padding: 10px; margin-top: 10px; }
        .player-list-item { background-color: #e9ecef; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .player-list-item .badge { margin-left: 10px; }

        /* Grafici */
        #performance-chart-container { height: 300px; width: 100%; }
        #performanceChartSingle, #performanceChartTeam { max-height: 300px; }

        /* Semaforo Scadenze (Nuove modifiche) */
        .deadline-status {
            font-size: 2rem; /* Aumentato del 100% */
            position: absolute;
            top: 50%; /* Centrato verticalmente */
            right: 15px; /* A destra */
            transform: translateY(-50%); /* Centrato verticalmente con precisione */
            z-index: 5;
        }
        .status-green { color: #28a745; } /* Verde */
        .status-yellow { color: #ffc107; } /* Giallo */
        .status-red { color: #dc3545; }   /* Rosso */
        .status-purple { color: #6f42c1; } /* Viola (nuovo colore) */

        .alert-fixed { position: fixed; top: 0; left: 0; width: 100%; z-index: 1050; border-radius: 0; }

        /* Stili per il pulsante di rimozione dalla formazione */
        .remove-from-formation-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div id="expiration-alerts" class="alert-fixed d-none"></div>

    <div class="container mt-4">
        <h1 class="mb-4 text-center">Gestione Squadra e Formazione</h1>

        <div class="form-section team-management-section">
            <h2 class="mb-3">Gestione Atleti</h2>

            <form id="player-form" class="mb-4">
                <input type="hidden" id="player-id">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="nome" class="form-label">Nome</label>
                        <input type="text" class="form-control" id="nome" required>
                    </div>
                    <div class="col-md-4">
                        <label for="cognome" class="form-label">Cognome</label>
                        <input type="text" class="form-control" id="cognome" required>
                    </div>
                    <div class="col-md-4">
                        <label for="ruolo" class="form-label">Ruolo</label>
                        <input type="text" class="form-control" id="ruolo" required>
                    </div>
                    <div class="col-md-4">
                        <label for="dataNascita" class="form-label">Data di Nascita</label>
                        <input type="date" class="form-control" id="dataNascita" required>
                    </div>
                    <div class="col-md-4">
                        <label for="scadenzaVisitaMedica" class="form-label">Scadenza Visita Medica</label>
                        <input type="date" class="form-control" id="scadenzaVisitaMedica" required>
                    </div>
                    <div class="col-md-4">
                        <label for="dataPrenotazioneVisita" class="form-label">Data Prenotazione Visita (Opzionale)</label>
                        <input type="date" class="form-control" id="dataPrenotazioneVisita">
                    </div>
                    <div class="col-md-4">
                        <label for="sesso" class="form-label">Sesso</label>
                        <select class="form-select" id="sesso" required>
                            <option value="">Seleziona...</option>
                            <option value="M">M</option>
                            <option value="F">F</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="nazionalita" class="form-label">Nazionalità</label>
                        <input type="text" class="form-control" id="nazionalita">
                    </div>
                    <div class="col-12">
                        <label for="performance" class="form-label">Performance (valori separati da virgola)</label>
                        <input type="text" class="form-control" id="performance" placeholder="es. 8,7,9,6">
                        <small class="form-text text-muted">Inserisci una serie di valori numerici per tracciare l'andamento della performance.</small>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3 me-2" id="save-player-btn">Aggiungi Atleta</button>
                <button type="button" class="btn btn-secondary mt-3" id="cancel-edit-btn" style="display: none;">Annulla Modifica</button>
            </form>

            <h3 class="mt-5">Elenco Atleti</h3>
            <div id="team-overview" class="row">
                </div>
        </div>

        <div class="form-section">
            <h2 class="mb-3">Analisi Performance</h2>
            <div class="row">
                <div class="col-md-6">
                    <h3>Performance Atleta Selezionato</h3>
                    <select id="select-player-chart" class="form-select mb-3">
                        <option value="">Seleziona un atleta</option>
                    </select>
                    <div id="performance-chart-container">
                        <canvas id="performanceChartSingle"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <h3>Performance Media Squadra</h3>
                    <div id="performance-chart-container">
                        <canvas id="performanceChartTeam"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h2 class="mb-3">Modulo Formazione</h2>
            <div class="row">
                <div class="col-md-4">
                    <h3>Giocatori Selezionabili</h3>
                    <div id="players-list" class="border p-3" style="min-height: 200px; max-height: 400px; overflow-y: auto;">
                        </div>
                </div>
                <div class="col-md-8">
                    <h3>Campo da Gioco</h3>
                    <div id="field">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let players = JSON.parse(localStorage.getItem('players')) || [];
        let selectedPlayersOnField = JSON.parse(localStorage.getItem('selectedPlayersOnField')) || {};
        let singlePlayerChart;
        let teamChart;

        // Funzione per calcolare lo stato della visita medica
        function getMedicalStatus(scadenzaVisita, dataPrenotazione = null) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalizza a inizio giornata
            const scadenzaDate = new Date(scadenzaVisita);
            scadenzaDate.setHours(0, 0, 0, 0);

            const threeMonthsFromNow = new Date(today);
            threeMonthsFromNow.setMonth(today.getMonth() + 1);
            threeMonthsFromNow.setHours(0, 0, 0, 0);

            let status = '';
            let colorClass = '';
            let icon = '<i class="fas fa-circle"></i>'; // Icona predefinita

            if (scadenzaDate < today) {
                // Scaduta
                status = 'Scaduta';
                colorClass = 'status-red';
            } else if (scadenzaDate <= threeMonthsFromNow) {
                // Scade entro 3 mesi
                status = 'In scadenza';
                colorClass = 'status-yellow';
            } else {
                // Valida
                status = 'Valida';
                colorClass = 'status-green';
            }

            // Nuova logica per la prenotazione
            if (dataPrenotazione) {
                const prenotazioneDate = new Date(dataPrenotazione);
                prenotazioneDate.setHours(0, 0, 0, 0);

                if (prenotazioneDate <= scadenzaDate) {
                    // Prenotata prima o nel giorno della scadenza -> VIOLA
                    status = 'Prenotata';
                    colorClass = 'status-purple';
                } else {
                    // Prenotata dopo la scadenza -> ROSSO (sovrascrive eventuali Giallo/Verde)
                    status = 'Prenotata (Scaduta)';
                    colorClass = 'status-red';
                }
            }
            return `<span class="deadline-status ${colorClass}" title="Visita Medica: ${status}">${icon}</span>`;
        }


        // Funzione per mostrare le schede degli atleti
        function displayPlayers() {
            const teamOverview = $('#team-overview');
            teamOverview.empty();
            const playersListForFormation = $('#players-list');
            playersListForFormation.empty();

            players.forEach(player => {
                const medicalStatusHtml = getMedicalStatus(player.scadenzaVisitaMedica, player.dataPrenotazioneVisita);
                const isRedStatus = medicalStatusHtml.includes('status-red');

                const playerCard = `
                    <div class="col-md-4">
                        <div class="player-card" data-id="${player.id}">
                            ${medicalStatusHtml}
                            <h5>${player.nome} ${player.cognome}</h5>
                            <p><strong>Ruolo:</strong> ${player.ruolo}</p>
                            <p><strong>Data Nascita:</strong> ${player.dataNascita}</p>
                            <p><strong>Scadenza Visita:</strong> ${player.scadenzaVisitaMedica}</p>
                            ${player.dataPrenotazioneVisita ? `<p><strong>Prenotazione Visita:</strong> ${player.dataPrenotazioneVisita}</p>` : ''}
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-info btn-sm edit-player-btn" data-id="${player.id}">Modifica</button>
                                <button type="button" class="btn btn-danger btn-sm delete-player-btn" data-id="${player.id}">Elimina</button>
                            </div>
                        </div>
                    </div>
                `;
                teamOverview.append(playerCard);

                // Mostra i giocatori nell'elenco selezionabili solo se la visita medica non è ROSSA
                if (!isRedStatus) {
                    const playerListItem = `
                        <div class="player-list-item draggable-player" data-id="${player.id}">
                            ${player.nome} ${player.cognome} <span class="badge bg-secondary">${player.ruolo}</span>
                        </div>
                    `;
                    playersListForFormation.append(playerListItem);
                }
            });

            makePlayersDraggable();
            updateFormationPlayers(); // Aggiorna i giocatori sul campo
            updateSelectPlayerChart();
            checkAndDisplayExpirationAlerts(); // Richiama la funzione di allerta dopo l'aggiornamento
        }

        // Funzione per rendere i giocatori trascinabili
        function makePlayersDraggable() {
            $('.draggable-player').draggable({
                revert: "invalid",
                helper: "clone",
                appendTo: "body",
                cursor: "move",
                zIndex: 1000,
                start: function(event, ui) {
                    $(ui.helper).addClass('field-player').css({
                        'width': '50px',
                        'height': '50px',
                        'border-radius': '50%',
                        'background-color': '#007bff',
                        'color': 'white',
                        'display': 'flex',
                        'align-items': 'center',
                        'justify-content': 'center',
                        'font-size': '0.8rem'
                    }).text($(this).text().split(' ')[0][0] + $(this).text().split(' ')[1][0]); // Iniziali
                }
            });
        }

        // Funzione per aggiornare i giocatori sul campo
        function updateFormationPlayers() {
            $('#field').empty(); // Pulisce il campo

            for (const playerId in selectedPlayersOnField) {
                const player = players.find(p => p.id === playerId);
                if (player) {
                    const medicalStatusHtml = getMedicalStatus(player.scadenzaVisitaMedica, player.dataPrenotazioneVisita);
                    const isRedStatus = medicalStatusHtml.includes('status-red');

                    // Se lo stato è ROSSO, rimuovi il giocatore dal campo e dal selectedPlayersOnField
                    if (isRedStatus) {
                        delete selectedPlayersOnField[playerId];
                        localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
                        displayPlayers(); // Ricarica per aggiornare l'elenco selezionabili
                        return; // Esce dalla funzione per evitare di aggiungere il giocatore ROSSO
                    }

                    const pos = selectedPlayersOnField[playerId];
                    const playerFieldHtml = `
                        <div class="field-player" data-id="${player.id}" style="left: ${pos.left}px; top: ${pos.top}px;">
                            ${player.nome.charAt(0)}${player.cognome.charAt(0)}
                            <button class="remove-from-formation-btn" data-id="${player.id}" title="Rimuovi dalla formazione">&times;</button>
                        </div>
                    `;
                    $('#field').append(playerFieldHtml);
                } else {
                    // Se un giocatore non esiste più (eliminato), rimuovilo dal campo
                    delete selectedPlayersOnField[playerId];
                    localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
                }
            }

            $('.field-player').draggable({
                containment: "#field",
                stop: function(event, ui) {
                    const id = $(this).data('id');
                    selectedPlayersOnField[id] = {
                        left: ui.position.left,
                        top: ui.position.top
                    };
                    localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
                }
            });
            attachRemoveButtonListener(); // Allega i listener per i nuovi pulsanti di rimozione
        }

        function attachRemoveButtonListener() {
            $('.remove-from-formation-btn').off('click').on('click', function(e) {
                e.stopPropagation(); // Evita che l'evento di drag venga attivato
                const playerIdToRemove = $(this).data('id');
                delete selectedPlayersOnField[playerIdToRemove];
                localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
                displayPlayers(); // Ricarica per aggiornare sia il campo che l'elenco selezionabili
            });
        }

        // Configura la zona di drop per il campo da gioco
        $('#field').droppable({
            accept: ".draggable-player",
            drop: function(event, ui) {
                const playerId = ui.draggable.data('id');
                const existingPlayer = $(`[data-id="${playerId}"].field-player`);

                if (existingPlayer.length === 0) { // Aggiungi solo se non è già sul campo
                    const player = players.find(p => p.id === playerId);
                    if (player) {
                        const newPlayerField = $(`<div class="field-player" data-id="${player.id}">${player.nome.charAt(0)}${player.cognome.charAt(0)}<button class="remove-from-formation-btn" data-id="${player.id}" title="Rimuovi dalla formazione">&times;</button></div>`);
                        
                        // Posizione iniziale del giocatore trascinato
                        const fieldOffset = $(this).offset();
                        const initialLeft = ui.offset.left - fieldOffset.left;
                        const initialTop = ui.offset.top - fieldOffset.top;

                        newPlayerField.css({
                            left: initialLeft,
                            top: initialTop
                        });

                        $(this).append(newPlayerField);
                        selectedPlayersOnField[player.id] = { left: initialLeft, top: initialTop };
                        localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));

                        newPlayerField.draggable({
                            containment: "#field",
                            stop: function(event, ui) {
                                const id = $(this).data('id');
                                selectedPlayersOnField[id] = {
                                    left: ui.position.left,
                                    top: ui.position.top
                                };
                                localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
                            }
                        });
                        attachRemoveButtonListener(); // Allega listener per il pulsante di rimozione
                    }
                }
                // Se era già sul campo, la sua posizione verrà aggiornata dallo stop del draggable
            }
        });


        // Gestione form aggiungi/modifica atleta
        $('#player-form').on('submit', function(e) {
            e.preventDefault();
            const id = $('#player-id').val();
            const nome = $('#nome').val();
            const cognome = $('#cognome').val();
            const ruolo = $('#ruolo').val();
            const dataNascita = $('#dataNascita').val();
            const scadenzaVisitaMedica = $('#scadenzaVisitaMedica').val();
            const dataPrenotazioneVisita = $('#dataPrenotazioneVisita').val(); // Nuovo campo
            const sesso = $('#sesso').val();
            const nazionalita = $('#nazionalita').val();
            const performanceInput = $('#performance').val();
            const performance = performanceInput ? performanceInput.split(',').map(Number) : [];

            if (id) {
                // Modifica atleta esistente
                const playerIndex = players.findIndex(p => p.id === id);
                if (playerIndex > -1) {
                    players[playerIndex] = { ...players[playerIndex], nome, cognome, ruolo, dataNascita, scadenzaVisitaMedica, dataPrenotazioneVisita, sesso, nazionalita, performance };
                }
                $('#save-player-btn').text('Aggiungi Atleta');
                $('#cancel-edit-btn').hide();
            } else {
                // Aggiungi nuovo atleta
                const newPlayer = {
                    id: Date.now().toString(),
                    nome, cognome, ruolo, dataNascita, scadenzaVisitaMedica, dataPrenotazioneVisita, sesso, nazionalita, performance
                };
                players.push(newPlayer);
            }
            localStorage.setItem('players', JSON.stringify(players));
            $('#player-form')[0].reset();
            $('#player-id').val('');
            displayPlayers();
        });

        // Eventi click per modifica ed eliminazione
        $('#team-overview').on('click', '.edit-player-btn', function() {
            const id = $(this).data('id');
            const player = players.find(p => p.id === id);
            if (player) {
                $('#player-id').val(player.id);
                $('#nome').val(player.nome);
                $('#cognome').val(player.cognome);
                $('#ruolo').val(player.ruolo);
                $('#dataNascita').val(player.dataNascita);
                $('#scadenzaVisitaMedica').val(player.scadenzaVisitaMedica);
                $('#dataPrenotazioneVisita').val(player.dataPrenotazioneVisita); // Carica il valore
                $('#sesso').val(player.sesso);
                $('#nazionalita').val(player.nazionalita);
                $('#performance').val(player.performance.join(','));
                $('#save-player-btn').text('Salva Modifiche');
                $('#cancel-edit-btn').show();
            }
        });

        $('#team-overview').on('click', '.delete-player-btn', function() {
            const id = $(this).data('id');
            players = players.filter(p => p.id !== id);
            delete selectedPlayersOnField[id]; // Rimuovi dal campo se presente
            localStorage.setItem('players', JSON.stringify(players));
            localStorage.setItem('selectedPlayersOnField', JSON.stringify(selectedPlayersOnField));
            displayPlayers();
        });

        $('#cancel-edit-btn').on('click', function() {
            $('#player-form')[0].reset();
            $('#player-id').val('');
            $('#save-player-btn').text('Aggiungi Atleta');
            $(this).hide();
        });

        // Funzioni Grafici
        function updateSelectPlayerChart() {
            const select = $('#select-player-chart');
            select.empty().append('<option value="">Seleziona un atleta</option>');
            players.forEach(player => {
                select.append(`<option value="${player.id}">${player.nome} ${player.cognome}</option>`);
            });
        }

        $('#select-player-chart').on('change', function() {
            const playerId = $(this).val();
            if (playerId) {
                const player = players.find(p => p.id === playerId);
                if (player) {
                    renderSinglePlayerChart(player);
                }
            } else {
                if (singlePlayerChart) {
                    singlePlayerChart.destroy();
                }
            }
        });

        function renderSinglePlayerChart(player) {
            if (singlePlayerChart) {
                singlePlayerChart.destroy();
            }

            const ctx = document.getElementById('performanceChartSingle').getContext('2d');
            const labels = Array.from({ length: player.performance.length }, (_, i) => `Gara ${i + 1}`);

            // Calcola la media della squadra
            const allPerformances = players.flatMap(p => p.performance);
            const teamAverage = allPerformances.length > 0 ? (allPerformances.reduce((a, b) => a + b, 0) / allPerformances.length) : 0;

            // Trova la miglior performance assoluta tra tutti gli atleti
            const maxPerformance = allPerformances.length > 0 ? Math.max(...allPerformances) : 0;

            singlePlayerChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Performance di ${player.nome}`,
                        data: player.performance,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: 'Media Squadra',
                        data: Array(labels.length).fill(teamAverage),
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5], /* Linea tratteggiata */
                        pointRadius: 0
                    },
                    {
                        label: 'Miglior Performance Squadra',
                        data: Array(labels.length).fill(maxPerformance),
                        borderColor: 'rgba(255, 206, 86, 1)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5], /* Linea tratteggiata */
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderTeamChart() {
            if (teamChart) {
                teamChart.destroy();
            }

            const ctx = document.getElementById('performanceChartTeam').getContext('2d');

            const allPerformances = players.flatMap(p => p.performance);
            const maxRaces = players.reduce((max, p) => Math.max(max, p.performance.length), 0);
            const labels = Array.from({ length: maxRaces }, (_, i) => `Gara ${i + 1}`);

            const teamPerformanceByRace = Array(maxRaces).fill(0).map((_, i) => {
                const values = players.map(p => p.performance[i]).filter(v => typeof v === 'number');
                return values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
            });

            // Trova la miglior performance assoluta tra tutti gli atleti
            const maxPerformance = allPerformances.length > 0 ? Math.max(...allPerformances) : 0;

            teamChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Media Performance Squadra',
                        data: teamPerformanceByRace,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: 'Miglior Performance Squadra',
                        data: Array(labels.length).fill(maxPerformance),
                        borderColor: 'rgba(255, 206, 86, 1)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5], /* Linea tratteggiata */
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Funzione per mostrare gli avvisi di scadenza
        function checkAndDisplayExpirationAlerts() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const threeMonthsFromNow = new Date(today);
            threeMonthsFromNow.setMonth(today.getMonth() + 3);
            threeMonthsFromNow.setHours(0, 0, 0, 0);

            let expiringPlayers = [];

            players.forEach(player => {
                const scadenzaDate = new Date(player.scadenzaVisitaMedica);
                scadenzaDate.setHours(0, 0, 0, 0);

                const dataPrenotazione = player.dataPrenotazioneVisita ? new Date(player.dataPrenotazioneVisita) : null;
                if (dataPrenotazione) dataPrenotazione.setHours(0, 0, 0, 0);

                // Mostra avviso solo se la visita SCADE entro 3 mesi E non è già stata prenotata prima della scadenza
                const isExpiringSoon = (scadenzaDate >= today && scadenzaDate <= threeMonthsFromNow);
                const isAlreadyBookedBeforeExpiration = (dataPrenotazione && dataPrenotazione <= scadenzaDate);

                if (isExpiringSoon && !isAlreadyBookedBeforeExpiration) {
                    expiringPlayers.push(player);
                } else if (scadenzaDate < today && (!dataPrenotazione || dataPrenotazione > scadenzaDate)) {
                    // Mostra anche gli atleti la cui visita è scaduta e non è stata prenotata (o prenotata tardi)
                    expiringPlayers.push(player);
                }
            });

            const alertsContainer = $('#expiration-alerts');
            alertsContainer.empty();

            if (expiringPlayers.length > 0) {
                let alertMessage = `
                    <div class="alert alert-warning alert-dismissible fade show mb-0" role="alert">
                        <strong>Attenzione!</strong> Le visite mediche di alcuni atleti sono in scadenza o scadute:
                        <ul>
                `;
                expiringPlayers.forEach(player => {
                    const scadenzaDate = new Date(player.scadenzaVisitaMedica);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    let statusText = '';
                    if (scadenzaDate < today) {
                        statusText = 'SCADUTA';
                    } else {
                        statusText = `scade il ${player.scadenzaVisitaMedica}`;
                    }

                    alertMessage += `<li><strong>${player.nome} ${player.cognome}</strong>: Visita ${statusText}</li>`;
                });
                alertMessage += `
                        </ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                alertsContainer.append(alertMessage).removeClass('d-none');
            } else {
                alertsContainer.addClass('d-none');
            }
        }


        // Inizializzazione
        $(document).ready(function() {
            displayPlayers();
            renderTeamChart();
            checkAndDisplayExpirationAlerts(); // Controlla all'avvio
        });
    </script>
</body>
</html>